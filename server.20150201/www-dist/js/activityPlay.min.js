/*! swall 17-01-2015 */
function onImgLoad(a){var b=a.target,c=$(b).parents(".resourceItem")[0],d=parseInt(c.getAttribute("data-gindex")),e=parseInt(c.getAttribute("data-rindex"));updateNextItemLineHeight(d,e)}function updateNextItemLineHeight(a,b){var c=$('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]'),d=$('.resourceItem[data-gindex="'+a+'"][data-rindex="'+(b+1)+'"] .nextLine'),e=c.outerHeight();d.length&&d.height(e-3)}function refreshAllNextItemLineHeight(){_.each(rs.resources,function(a,b){_.each(a.resources,function(a,c){0!==a.type&&updateNextItemLineHeight(b,c)})})}angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8090":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show"),angular.module("ts.services.utils",[]).service("UtilsService",[function(){var a={object:{toUrlencodedString:function(a){return _.map(a,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; "),c=_.reduce(b,function(a,b){var c=b.split("=");return a[c[0]]=c[1],a},{});return c[a]}},time:{timezoneOffset:(new Date).getTimezoneOffset(),dateToDatetimePickerValue:function(b,c){return b||(b=new Date),b.setMinutes(b.getMinutes()-a.time.timezoneOffset),c||(b.setSeconds(0),b.setMilliseconds(0)),b.toISOString().split(".")[0]},datetimePickerValueToTs:function(b){if(b){var c=b.split(":").length<3?":00.000Z":".000Z",d=Date.parse(b+c)+60*a.time.timezoneOffset*1e3;return console.log(b,d,new Date(d)),d}return 0}}};return a}]),angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,c,d,e){function f(){return c.cookie.get("uid")}function g(){var a=c.cookie.get("uid"),b=c.cookie.get("skey");return Boolean(a&&b)}function h(a){var b=c.cookie.get("uid"),d=a.users.creator;return b==d}function i(){var a=c.cookie.get("uid");if(a){var b=localStorage.login_result,d=b?JSON.parse(b):{};return d&&d.nick?d.nick:a}return"登录"}function j(c,f,g,h){function i(b,c){console.log("[UserService] login result:",b,c,document.cookie),200==c&&g?(localStorage.login_result=JSON.stringify(b),g(b,c)):h&&h(b,c),a.$emit(e,c,b)}b.put(d+"/users/"+c+"/login","pwd="+encodeURIComponent(f),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(i).error(i)}function k(){var a=(new Date).toGMTString(),b="71xiaoxue.com";document.cookie="uid=; domain=."+b+"; path=/; expires="+a,document.cookie="skey=; domain=."+b+"; path=/; expires="+a,document.cookie="connect.sid=; domain=."+b+"; path=/; expires="+a,localStorage.removeItem("login_result")}function l(b){var c=new XMLHttpRequest;c.addEventListener("load",function(){var d=JSON.parse(c.responseText),e=d?d.err:-1;if(e)console.error("[UserService][API] fetch organization tree fail!",e),b(e);else{var f=d.result.data,g={},h={},i=m(f,!1,g,h);i.nodes.unshift({text:"全员",icon:"glyphicon glyphicon-user",value:"*",id:"*"}),a.orgTree=f,a.orgUserIndex=g,a.orgUidIndex=h,a.processedOrgTree=i.nodes||[],localStorage.setItem("orgTree_uidIndex",JSON.stringify(h)),b()}}),c.addEventListener("error",function(a){console.error("[UserService][Request] fetch organization tree fail!",a),b(a)}),c.withCredentials=!0,c.open("GET","/users/tree"),c.send(),console.log("[UserService] fetching organization tree ...")}function m(a,b,c,d){if(b)return c[a._id]=a,d[a.name]=a,{text:a.nick,icon:"glyphicon glyphicon-user",value:a.name,id:a._id};var e=_.map(a.users,function(a){return m(a,!0,c,d)}),f=_.map(a.children,function(a){return m(a,!1,c,d)});return{text:a.name,icon:"glyphicon glyphicon-folder-open",color:"#999",selectable:!1,nodes:e.concat(f)}}function n(){}function o(b){return a.orgUidIndex[b]?a.orgUidIndex[b].nick:b}var p=localStorage.getItem("orgTree_uidIndex");return a.orgTree={},a.orgUserIndex={},a.orgUidIndex=p?JSON.parse(p):{},a.processedOrgTree=[],{uid:f,hasLoggedIn:g,nick:i,uid2nick:o,login:j,logout:k,fetchProfile:n,fetchOrganizationTree:l,activity:{isCreatorOfActivity:h}}}]),angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,c,d,e){function f(b){b?(a.selectedActivity=b,a.selectedActivityID=b._id):(a.selectedActivity=null,a.selectedActivityID=""),console.log("[ActivityService] selected activity",a.selectedActivity)}function g(b){var c=a.activityMap[b];f(c)}function h(a,c){var d=(new Date).getTime();b.get(e+"/activities/config?_="+d,null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",b),a&&a(b,c)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS"),c&&c(a,b)})}function i(c,f,g){a.activityList=[],a.activityMap={},z(),c=c||{},"manager"==a.mode()&&(c.creator=d.uid()),c._=(new Date).getTime(),console.log("[ActivityService] fetching activities with",c),b.get(e+"/activities",{responseType:"json",params:c}).success(function(b,c){if(200===c&&!b.c){a.profiles=b.r.profiles;var d=b.r.activities,e=_.groupBy(d,function(a){return v(a)});a.activityList=_.map(e,function(a,b){return{date:b,activities:a}}),a.activityMap=_.reduce(d,function(a,b){return a[b._id]=b,a},{}),a.activityList.length?y():A(),console.log("[ActivityService] activities result",a.activityList,a.activityMap)}f&&f(b,c)}).error(function(a,b){B(),g&&g(a,b)})}function j(a,c,d){var f=(new Date).getTime();b.get(e+"/activities/"+a+"?_="+f,{responseType:"json"}).success(c).error(d)}function k(a,d,f){a=a||{},a._=(new Date).getTime();var g=c.object.toUrlencodedString(a);b.post(e+"/activities",g,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,b){a&&!a.c&&a.r&&(y(),q(a.r[0])),y(),d&&d(a,b)}).error(f)}function l(a,d,f,g){w(),d=d||{},d._=(new Date).getTime();var h=c.object.toUrlencodedString(d);b.put(e+"/activities/"+a,h,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,b){a&&!a.c&&a.r&&t(a.r),x(),f&&f(a,b)}).error(function(a,b){x(),g&&g(a,b)})}function m(a,b,c){l(a,{status:"closed"},b,c)}function n(c,d,g){w(),b({method:"DELETE",url:e+"/activities/"+c+"?_="+(new Date).getTime()}).success(function(b,e){b&&!b.c&&(f(),u(c)),x(),a.activityList.length||A(),d&&d(b,e)}).error(function(a,b){x(),g&&g(a,b)})}function o(a){var b=_.countBy(_.pluck(a.resources,"user")),c=_.map(b,function(a,b){return{uid:b,count:a}}),d=_.sortBy(c,function(a){return-a.count});return d}function p(a,b){var c=_.first(a.resources);if(c){var d=c.date,e={};return b=1e3*(b||300),_.each(a.resources,function(a){var c=Math.floor((a.date-d)/b),f=c*b;e[f]||(e[f]=[]),e[f].push(a)}),{beginning:d,items:e}}return{}}function q(b){a.activityMap[b._id]=b;for(var c=v(b),d=0;d<a.activityList.length;++d){var e=a.activityList[d];if(e.date==c)return void r(e,b);if(e.date>c)return void s(d,b)}s(d,b)}function r(a,b){a.activities.unshift(b)}function s(b,c){a.activityList.splice(b,0,{date:v(c),activities:[c]})}function t(b){a.activityMap[b._id]=b;for(var c=0;c<a.activityList.length;++c)for(var d=a.activityList[c].activities,e=0;e<d.length;++e)if(d[e]._id==b._id)return a.selectedActivity==d[e]&&(a.selectedActivity=b,a.selectedActivityID=b._id),void(d[e]=b)}function u(b){delete a.activityMap[b];for(var c=0;c<a.activityList.length;++c)for(var d=0;d<a.activityList[c].activities.length;++d){var e=a.activityList[c].activities[d];if(e._id==b)return a.activityList[c].activities.splice(d,1),void(a.activityList[c].activities.length||a.activityList.splice(c,1))}}function v(a){var b=new Date(a.info.date);return b.setHours(0),b.setMinutes(0),b.setSeconds(0),b.setMilliseconds(0),b.getTime().toString()}function w(){C.setAttribute("disabled","disabled")}function x(){C.removeAttribute("disabled")}function y(){a.hints=""}function z(){a.hints="请稍候..."}function A(){a.hints="没找到任何活动"}function B(){a.hints="拉取活动失败"}var C=document.getElementById("activityDetailButtons");return a.profiles={},a.activityList=[],a.activityMap={},a.selectedActivity=null,a.selectedActivityID="",a.hints="",{selectActivity:f,selectActivityByID:g,fetchActivities:i,getActivity:j,createActivity:k,updateActivity:l,closeActivity:m,deleteActivity:n,fetchActivityConfig:h,statistics:{byUser:o,byTime:p}}}]),angular.module("ap.controllers.main",["ts.services.activity","ts.services.user","ts.services.utils"]).controller("PlayerMainController",["$rootScope","$scope","$location","$sce","ActivityService","UserService","UtilsService",function(a,b,c,d,e,f,g){function h(a){var b=new XMLHttpRequest;b.addEventListener("load",function(){a&&a()}),b.open("POST","/activities/"+q+"/participators"),b.send()}function i(a,b,c,d){var e="/activities/"+q+"/videos/"+a,f=new XMLHttpRequest,g=new FormData;_.each(b,function(a,b){g.append(b,a)}),console.log("updating main videos",e,b),f.addEventListener("load",function(a){c&&c(f,a,JSON.parse(f.responseText))}),f.addEventListener("error",function(a){d&&d(f,a)}),f.open("PUT",e),f.send(g)}function j(){b.selectedResource=null,b.selectedRIndex=-1}function k(){e.getActivity(q,function(c,d){if(console.log("[PlayerMainController] get activity success",d,c),200==d&&!c.c){if(a.profiles=c.profiles,a.activity=c.r,l(a.activity.resources),a.updateMainVideos(c.r.videos||[]),a.activity.active)a.userCount=a.activity.users.participators.length,b.autoRefresh&&(r=setTimeout(function(){k()},5e3));else{var e=_.countBy(a.activity.resources,function(a){return a.user});a.userCount=_.keys(e).length}b.shouldShowUploadMainButton=f.activity.isCreatorOfActivity(a.activity)}},function(a,b){console.error("[PlayerMainController] get activity fail",b,a)}),console.log("[PlayerMainController] getting info of activity "+q)}function l(b){var c=a.resources[0],d=c?c.resources[0].date:0,e=_.filter(b,function(a){return a.date>d});console.log("new resources",e);for(var f=0;f<e.length;++f){var g=e[f],h=new Date(g.date);h.setSeconds(0),h.setMilliseconds(0);var i=h.getTime();a.resources[0]&&a.resources[0].ts==i?a.resources[0].resources.splice(0,0,g):a.resources.splice(0,0,{ts:i,resources:[g]}),(1==g.type||4==g.type||2==g.type)&&a.presources.splice(0,0,g),-1==a.uploadedUsers.indexOf(g.user)&&a.uploadedUsers.push(g.user)}console.log("resources",a.resources),console.log("presources",a.presources)}function m(a){for(var b=_.map($(".resourceItem"),function(a){return parseInt(a.getAttribute("data-ts"))}).sort(),c=0;c<b.length;++c)if(b[c]>=a)return b[c-1];return _.last(b)}function n(){var b=document.querySelector("video");b.addEventListener("timeupdate",function(){var c=a.selectedMainVideoStartTime()+1e3*b.currentTime,d=m(c),e=$(".resourceItem[data-ts="+d+"]");p(e,!0)})}function o(a,b,c){if(a){var d=$(".resourceItem[data-ts="+a.date+"]");p(d,b,c)}}function p(c,d,e){if(c){var f=parseInt(c.attr("data-gindex")),g=parseInt(c.attr("data-rindex")),h=c.parents(".resourceGroup"),i=h.position(),j=c.position(),k=i?i.top:0,l=j?j.top:0,m=$("#timeline");console.log(m.scrollTop(),k,l),m.scrollTop(m.scrollTop()+k+l),e||a.$apply(function(){b.highlightSpecifyResource(null,f,g)}),c.width(c.width()+1),setTimeout(function(){c[0].style.width="50%"},100)}}var q=c.search().aid,r=0,s=document.getElementById("player"),t=document.getElementById("linkPanel"),u=document.getElementById("linkPanelFrame");a.apiHost="szone.71xiaoxue.com",a.username=f.nick(),a.userCount=0,a.uploadedUsers=[],a.rawResources=[],a.resources=[],a.presources=[],a.highlightResource={g:-1,r:-1},a.profiles={},a.selectedMainVideo=null,a.editingOrder=!1,a.editingTime=!1,a.mainVideos=[],b.selectedUser=null,b.selectedResource=null,b.selectedRIndex=-1,b.autoRefresh=!0,b.showActivityDetails=!1,b.shouldShowUploadMainButton=!1,b.newCommentContent="",b.addingNewComment=!1,b.submitNewComment=function(){h(function(){if(!b.addingNewComment&&b.newCommentContent.length){b.addingNewComment=!0;var a=new XMLHttpRequest,c=new FormData;c.append("type",0),c.append("content",b.newCommentContent),a.addEventListener("load",function(){switch(a.status){case 400:alert("请求有误，无法添加评论");break;case 404:alert("您是否已经加入了其他活动？请先在手机端退出其他活动才可以发表评论哦");break;case 500:alert("网络或服务器出错啦，请稍后再试");break;case 200:case 201:k()}b.addingNewComment=!1,b.newCommentContent="",$("#addCommentModal").modal("hide")}),a.open("POST","/activities/"+q+"/resources"),a.send(c)}})};a.updateMainVideos=function(b){a.mainVideos=_.map(b,function(a){return a.url||(a.url=d.trustAsResourceUrl(a.src)),a}),console.log("[MainVideos]",a.mainVideos)},b.$watch("selectedResource",function(a){a&&2==a.type&&setTimeout(function(){var b=document.getElementById("videoPlayer");b.src=a.content},100)}),a.uid2nick=function(a){return a?f.uid2nick(a):""},a.timelineStartTime=function(){var b=_.last(a.resources),c=b?_.last(b.resources):void 0;return c?c.date:0},a.selectedMainVideoStartTime=function(){var b=a.timelineStartTime();return a.selectedMainVideo&&(b+=1e3*a.selectedMainVideo.startTime),b},a.selectedMainVideoStopTime=function(){return a.selectedMainVideo?a.selectedMainVideoStartTime()+1e3*a.selectedMainVideo.duration:0},b.selectMainVideo=function(b){if(s.pause(),a.selectedMainVideo=b,b){var c=new Date(a.selectedMainVideoStartTime());a.selectedMainVideoStartDate={y:c.getFullYear(),M:c.getMonth()+1,d:c.getDate(),h:c.getHours(),m:c.getMinutes(),s:c.getSeconds()}}},b.editMainVideoName=function(a){var b=prompt("请输入“"+a.name+"”的新名称：");b&&(a.name=b,i(a._id,{name:b},function(a,b,c){console.log(a.status,c)},function(a,b){console.error(a.status,b)}))},b.removeMainVideo=function(b,c){if(confirm("确定删除主视频“"+b.name+"”?")){a.mainVideos.splice(c,1),a.selectedMainVideo=a.mainVideos[0],a.editingOrder=void 0!=a.mainVideos[0],a.editingTime=!1;var d="/activities/"+q+"/videos/"+b._id,e=new XMLHttpRequest;e.open("DELETE",d),e.send()}},b.toggleVideoPlayer=function(){s.paused?s.play():s.pause()},b.enterEditOrderMode=function(c){a.editingOrder=c,c?s.pause():b.updateMainVideosOrder()},b.enterEditTimeMode=function(c,d){a.editingTime=c?!0:!1,c?a.selectedMainVideo=c:d&&b.updateMainVideoTiming()},b.updateMainVideosLocalOrder=function(b,c){var d=a.mainVideos.splice(b,1)[0],e=c?b-1:b+1;a.mainVideos.splice(e,0,d)},b.updateMainVideosOrder=function(){i(a.mainVideos[0]._id,{orders:_.map(a.mainVideos,function(a){return a._id}).join(",")},function(a,b,c){console.log(a.status,c)},function(a,b){console.log(a.status,b)})},b.updateMainVideoTiming=function(){var b=a.timelineStartTime(),c=new Date(b),d=new Date;d.setFullYear(a.selectedMainVideoStartDate.y),d.setMonth(a.selectedMainVideoStartDate.M-1),d.setDate(a.selectedMainVideoStartDate.d),d.setHours(a.selectedMainVideoStartDate.h),d.setMinutes(a.selectedMainVideoStartDate.m),d.setSeconds(a.selectedMainVideoStartDate.s),d.setMilliseconds(c.getMilliseconds());var e=(d.getTime()-b)/1e3;if(e>=0)a.selectedMainVideoStartDate={y:d.getFullYear(),M:d.getMonth()+1,d:d.getDate(),h:d.getHours(),m:d.getMinutes(),s:d.getSeconds()},a.selectedMainVideo.startTime=e,i(a.selectedMainVideo._id,{startTime:e},function(a,b,c){console.log(a.status,c)},function(a,b){console.error(a.status,b)});else{alert("主视频开始录制时间必须晚于时间轴开始时间！");var f=new Date(a.selectedMainVideoStartTime());a.selectedMainVideoStartDate={y:f.getFullYear(),M:f.getMonth()+1,d:f.getDate(),h:f.getHours(),m:f.getMinutes(),s:f.getSeconds()}}},b.showResourceDetail=function(c,d,e){b.highlightSpecifyResource(c,d,e,!0),a.selectedMainVideo||(b.selectedResource=c,b.selectedRIndex=a.presources.indexOf(c))},b.highlightSpecifyResource=function(b,c,d,e){if(console.log("highlighting resource",c,d),a.highlightResource={g:c,r:d},o(b,!0,!0),e&&a.selectedMainVideo&&b){var f=b.date,g=a.selectedMainVideoStartTime(),h=g+a.selectedMainVideo.duration;console.log(f,g,h),g>f?f=g:f>h&&(f=h),s.currentTime=f-g,s.play()}},b.hasPreviousPreviewableResource=function(){return b.selectedRIndex>0},b.hasNextPreviewableResource=function(){return b.selectedRIndex<a.presources.length-1},b.selectPreviousPreviewableResource=function(){b.selectedRIndex>0&&(--b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])},b.selectNextPreviewableResource=function(){b.selectedRIndex<a.presources.length-1&&(++b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])},b.filterByUser=function(a){b.selectedUser=a,$(".resourceGroup").css("display","none"),setTimeout(function(){$(".resourceGroup").css("display","-webkit-box"),$(".resourceGroup").css("display","-ms-flexbox"),b.$digest(),refreshAllNextItemLineHeight()},0)},b.nextLineHeight=function(a,b){if(b){var c=$('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]'),d=c.outerHeight();return d?d-3:0}return 0},b.isFirstResourceInGroup=function(a,b){if(0==b)return!0;var c='.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]',d=document.querySelector(c);if(d){var e=d.parentElement,f=e.querySelectorAll(".resourceItem:not(.ng-hide)")[0];return d==f}return!1},b.resourceShouldBeVisible=function(a){return!b.selectedUser||b.selectedUser==a.user},b.groupContainsResourceOfSelectedUser=function(a){return b.selectedUser?_.some(a.resources,function(a){return a.user==b.selectedUser}):!0},b.hideResourceDetail=function(){j()},b.toggleAuthRefresh=function(){b.autoRefresh=!b.autoRefresh,b.autoRefresh?k():r&&(clearTimeout(r),r=0)},b.toggleActivityDetails=function(){},b.showUserStatistics=function(){b.stat=2;var c=e.statistics.byUser(a.activity,10);c=_.map(c,function(b){return{nick:a.uid2nick(b.uid),count:b.count}}),console.log(c),AmCharts.makeChart("statBody",{type:"pie",theme:"light",dataProvider:c,valueField:"count",titleField:"nick"})},b.showTimeStatistics=function(){b.stat=1;var c=e.statistics.byTime(a.activity),d=c.beginning,f=c.items;c=_.map(f,function(a,b){var c=new Date(parseInt(b)+d),e=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+" "+c.getHours()+":"+c.getMinutes();return{date:e,count:a.length}}),AmCharts.makeChart("statBody",{type:"serial",theme:"light",dataProvider:c,valueAxes:[{gridColor:"#FFFFFF",gridAlpha:.2,dashLength:0,labelsEnabled:!1}],gridAboveGraphs:!0,startDuration:1,graphs:[{balloonText:"[[category]]: <b>[[value]]</b>",fillAlphas:.8,lineAlpha:.2,type:"column",valueField:"count"}],chartCursor:{categoryBalloonEnabled:!1,cursorAlpha:0,zoomable:!1},categoryField:"date",categoryAxis:{gridPosition:"start",gridAlpha:0,labelRotation:45}})},b.showLinkPanel=function(){b.linkPanelVisible=!0,$(t).draggable(),u.src=a.activity.info.link},b.hideLinkPanel=function(){b.linkPanelVisible=!1,u.src=""},window.rs=a,window.utils=g,k(),n()}]),document.domain="71xiaoxue.com",angular.module("ap.controllers.videoUploader",["ts.services.activity","ts.services.user"]).controller("MainVideoUploaderController",["$rootScope","$scope","$location","ActivityService","UserService","UtilsService",function(a,b,c,d,e,f){function g(){b.$apply(function(){j(),$("#uploadMainVideoModal").modal("hide")})}function h(){if(b.videoFile&&b.videoDuration&&b.videoName){var a=new FormData,d=new XMLHttpRequest,e="http://"+l+"/upload";a.append("skey",f.cookie.get("skey")),a.append("connect.sid",f.cookie.get("connect.sid")),a.append("file",b.videoFile),a.append("name",b.videoName),a.append("media",1),a.append("activityId",c.search().aid),d.upload.addEventListener("progress",function(a){b.$apply(function(){b.videoUploadProgress=Math.floor(a.loaded/a.total*100)})},!1),d.addEventListener("load",function(){b.videoIsUploading=!1,console.log(d.status,d.responseText);try{var a=JSON.parse(d.responseText),c=a.data.fid;i(c)}catch(e){}b.$digest()},!1),d.addEventListener("error",function(a){console.log("[uploader] upload video error",a),g(),alert("主视频上传失败！")},!1),b.videoIsUploading=!0,b.videoUploadProgress=0,d.withCredentials=!0,d.open("POST",e),d.send(a),console.log("[uploader] uploading video ...")}}function i(d){if(b.videoIsUploading=!1,console.log("上传视频结果：",d),d)if(b.videoName){b.videoURL="http://"+l+"/api/media/download?fileId="+d;var e=c.search().aid,f=new FormData,g=new XMLHttpRequest;f.append("src",b.videoURL),f.append("name",b.videoName),f.append("duration",b.videoDuration),g.addEventListener("load",function(){if(b.videoIsAdding=!1,201==g.status){var c=JSON.parse(g.responseText),d=c?c.c:-1,e=c?c.r:null;console.log("[uploader] add success",c),!d&&e&&($("#uploadMainVideoModal").modal("hide"),a.updateMainVideos(e.videos))}else alert("添加主视频失败 ("+g.status+")");a.$digest()}),g.addEventListener("error",function(a){console.log("[uploader] add video error",a),b.$apply(function(){j()})}),b.videoIsAdding=!0,g.open("POST","/activities/"+e+"/videos"),g.send(f),console.log("[uploader] adding video to activity",e)}else alert("上传视频失败，请输入有效的视频名字");else alert("上传视频失败，请稍后再试")}function j(){$("#mainVideoFile").val(null),b.videoFile=null,b.videoName=null,b.videoDuration=0,b.videoIsReading=!1,b.videoIsUploading=!1,b.videoIsAdding=!1,b.videoUploadProgress=0,b.videoURL=null}var k=document.getElementById("mainVideoFile"),l="szone.71xiaoxue.com";b.skey=f.cookie.get("skey"),j(),b.onSelectedFile=function(){b.$apply(function(){var a=k.files,c=a?a[0]:null;if(console.log("[uploader] selected file",c),c&&"video"==c.type.split("/")[0]){b.videoFile=c;var d=document.createElement("video"),e=window.URL.createObjectURL(c);d.addEventListener("loadedmetadata",function(){b.$apply(function(){b.videoIsReading=!1,b.videoDuration=d.duration,console.log("[uploader] video duration = "+d.duration)})}),d.src=e,b.videoIsReading=!0,console.log("[uploader] reading video file ...")}else alert("对不起，您所选择的文件格式不支持 "),b.videoFile=null,b.videoDuration=0})},b.startUpload=function(){h()},b.cancelUpload=function(){(!b.videoIsUploading&&!b.videoIsUploading||confirm("确定要取消上传主视频？"))&&g()},b.submitLabel=function(){return b.videoIsReading?"请稍候":b.videoIsUploading?"上传中 ("+(b.videoUploadProgress||0)+"%)":b.videoIsAdding?"添加中":"添加"},window.addVideoToActivity=i,window.$scope=b}]),function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main","ap.controllers.videoUploader"])}();