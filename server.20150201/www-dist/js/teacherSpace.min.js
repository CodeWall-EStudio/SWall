/*! swall 17-01-2015 */
angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8090":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show"),angular.module("ts.services.utils",[]).service("UtilsService",[function(){var a={object:{toUrlencodedString:function(a){return _.map(a,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; "),c=_.reduce(b,function(a,b){var c=b.split("=");return a[c[0]]=c[1],a},{});return c[a]}},time:{timezoneOffset:(new Date).getTimezoneOffset(),dateToDatetimePickerValue:function(b,c){return b||(b=new Date),b.setMinutes(b.getMinutes()-a.time.timezoneOffset),c||(b.setSeconds(0),b.setMilliseconds(0)),b.toISOString().split(".")[0]},datetimePickerValueToTs:function(b){if(b){var c=b.split(":").length<3?":00.000Z":".000Z",d=Date.parse(b+c)+60*a.time.timezoneOffset*1e3;return console.log(b,d,new Date(d)),d}return 0}}};return a}]),angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,c,d,e){function f(){return c.cookie.get("uid")}function g(){var a=c.cookie.get("uid"),b=c.cookie.get("skey");return Boolean(a&&b)}function h(a){var b=c.cookie.get("uid"),d=a.users.creator;return b==d}function i(){var a=c.cookie.get("uid");if(a){var b=localStorage.login_result,d=b?JSON.parse(b):{};return d&&d.nick?d.nick:a}return"登录"}function j(c,f,g,h){function i(b,c){console.log("[UserService] login result:",b,c,document.cookie),200==c&&g?(localStorage.login_result=JSON.stringify(b),g(b,c)):h&&h(b,c),a.$emit(e,c,b)}b.put(d+"/users/"+c+"/login","pwd="+encodeURIComponent(f),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(i).error(i)}function k(){var a=(new Date).toGMTString(),b="71xiaoxue.com";document.cookie="uid=; domain=."+b+"; path=/; expires="+a,document.cookie="skey=; domain=."+b+"; path=/; expires="+a,document.cookie="connect.sid=; domain=."+b+"; path=/; expires="+a,localStorage.removeItem("login_result")}function l(b){var c=new XMLHttpRequest;c.addEventListener("load",function(){var d=JSON.parse(c.responseText),e=d?d.err:-1;if(e)console.error("[UserService][API] fetch organization tree fail!",e),b(e);else{var f=d.result.list,g={},h={},i=m({name:'部门', children:f},!1,g,h);console.log('raw',f);i.nodes.unshift({text:"全员",icon:"glyphicon glyphicon-user",value:"*",id:"*"}),a.orgTree=f,a.orgUserIndex=g,a.orgUidIndex=h,a.processedOrgTree=i.nodes||[],localStorage.setItem("orgTree_uidIndex",JSON.stringify(h)),b()}}),c.addEventListener("error",function(a){console.error("[UserService][Request] fetch organization tree fail!",a),b(a)}),c.withCredentials=!0,c.open("GET","/users/tree"),c.send(),console.log("[UserService] fetching organization tree ...")}function m(a,b,c,d){if(b)return c[a._id]=a,d[a.name]=a,{text:a.nick,icon:"glyphicon glyphicon-user",value:a.name,id:a._id};var e=_.map(a.users,function(a){return m(a,!0,c,d)}),f=_.map(a.children,function(a){return m(a,!1,c,d)});console.log('process',e,f);return{text:a.name,icon:"glyphicon glyphicon-folder-open",color:"#999",selectable:!1,nodes:e.concat(f)}}function n(){}function o(b){return a.orgUidIndex[b]?a.orgUidIndex[b].nick:b}var p=localStorage.getItem("orgTree_uidIndex");return a.orgTree={},a.orgUserIndex={},a.orgUidIndex=p?JSON.parse(p):{},a.processedOrgTree=[],{uid:f,hasLoggedIn:g,nick:i,uid2nick:o,login:j,logout:k,fetchProfile:n,fetchOrganizationTree:l,activity:{isCreatorOfActivity:h}}}]),angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,c,d,e){function f(b){b?(a.selectedActivity=b,a.selectedActivityID=b._id):(a.selectedActivity=null,a.selectedActivityID=""),console.log("[ActivityService] selected activity",a.selectedActivity)}function g(b){var c=a.activityMap[b];f(c)}function h(a,c){var d=(new Date).getTime();b.get(e+"/activities/config?_="+d,null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",b),a&&a(b,c)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS"),c&&c(a,b)})}function i(c,f,g){a.activityList=[],a.activityMap={},z(),c=c||{},"manager"==a.mode()&&(c.creator=d.uid()),c._=(new Date).getTime(),console.log("[ActivityService] fetching activities with",c),b.get(e+"/activities",{responseType:"json",params:c}).success(function(b,c){if(200===c&&!b.c){a.profiles=b.r.profiles;var d=b.r.activities,e=_.groupBy(d,function(a){return v(a)});a.activityList=_.map(e,function(a,b){return{date:b,activities:a}}),a.activityMap=_.reduce(d,function(a,b){return a[b._id]=b,a},{}),a.activityList.length?y():A(),console.log("[ActivityService] activities result",a.activityList,a.activityMap)}f&&f(b,c)}).error(function(a,b){B(),g&&g(a,b)})}function j(a,c,d){var f=(new Date).getTime();b.get(e+"/activities/"+a+"?_="+f,{responseType:"json"}).success(c).error(d)}function k(a,d,f){a=a||{},a._=(new Date).getTime();var g=c.object.toUrlencodedString(a);b.post(e+"/activities",g,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,b){a&&!a.c&&a.r&&(y(),q(a.r[0])),y(),d&&d(a,b)}).error(f)}function l(a,d,f,g){w(),d=d||{},d._=(new Date).getTime();var h=c.object.toUrlencodedString(d);b.put(e+"/activities/"+a,h,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,b){a&&!a.c&&a.r&&t(a.r),x(),f&&f(a,b)}).error(function(a,b){x(),g&&g(a,b)})}function m(a,b,c){l(a,{status:"closed"},b,c)}function n(c,d,g){w(),b({method:"DELETE",url:e+"/activities/"+c+"?_="+(new Date).getTime()}).success(function(b,e){b&&!b.c&&(f(),u(c)),x(),a.activityList.length||A(),d&&d(b,e)}).error(function(a,b){x(),g&&g(a,b)})}function o(a){var b=_.countBy(_.pluck(a.resources,"user")),c=_.map(b,function(a,b){return{uid:b,count:a}}),d=_.sortBy(c,function(a){return-a.count});return d}function p(a,b){var c=_.first(a.resources);if(c){var d=c.date,e={};return b=1e3*(b||300),_.each(a.resources,function(a){var c=Math.floor((a.date-d)/b),f=c*b;e[f]||(e[f]=[]),e[f].push(a)}),{beginning:d,items:e}}return{}}function q(b){a.activityMap[b._id]=b;for(var c=v(b),d=0;d<a.activityList.length;++d){var e=a.activityList[d];if(e.date==c)return void r(e,b);if(e.date>c)return void s(d,b)}s(d,b)}function r(a,b){a.activities.unshift(b)}function s(b,c){a.activityList.splice(b,0,{date:v(c),activities:[c]})}function t(b){a.activityMap[b._id]=b;for(var c=0;c<a.activityList.length;++c)for(var d=a.activityList[c].activities,e=0;e<d.length;++e)if(d[e]._id==b._id)return a.selectedActivity==d[e]&&(a.selectedActivity=b,a.selectedActivityID=b._id),void(d[e]=b)}function u(b){delete a.activityMap[b];for(var c=0;c<a.activityList.length;++c)for(var d=0;d<a.activityList[c].activities.length;++d){var e=a.activityList[c].activities[d];if(e._id==b)return a.activityList[c].activities.splice(d,1),void(a.activityList[c].activities.length||a.activityList.splice(c,1))}}function v(a){var b=new Date(a.info.date);return b.setHours(0),b.setMinutes(0),b.setSeconds(0),b.setMilliseconds(0),b.getTime().toString()}function w(){C.setAttribute("disabled","disabled")}function x(){C.removeAttribute("disabled")}function y(){a.hints=""}function z(){a.hints="请稍候..."}function A(){a.hints="没找到任何活动"}function B(){a.hints="拉取活动失败"}var C=document.getElementById("activityDetailButtons");return a.profiles={},a.activityList=[],a.activityMap={},a.selectedActivity=null,a.selectedActivityID="",a.hints="",{selectActivity:f,selectActivityByID:g,fetchActivities:i,getActivity:j,createActivity:k,updateActivity:l,closeActivity:m,deleteActivity:n,fetchActivityConfig:h,statistics:{byUser:o,byTime:p}}}]),angular.module("ts.controllers.activityDetail",["ts.utils.constants","ts.services.activity"]).controller("ActivityDetailController",["$rootScope","$scope","ActivityService","UserService","EVENT_MODE_CHANGE","CMD_SHOW_ACTIVITY_PANEL",function(a,b,c,d,e,f){b.uid2nick=function(a){return a?d.uid2nick(a.users.creator):""},b.userCount=function(){return a.selectedActivity?a.selectedActivity.active?b.participatorCount():b.uploadedUserCount():0},b.participatorCount=function(){var b=a.selectedActivity;return b&&b.active?b.users.participators.length:0},b.uploadedUserCount=function(){if(a.selectedActivity){var b=_.countBy(a.selectedActivity.resources,function(a){return a.user});return _.keys(b).length}return 0},b.resourceCount=function(b){return a.selectedActivity&&a.selectedActivity.resources?_.reduce(a.selectedActivity.resources,function(a,c){return c.type==b&&(a+=1),a},0):0},b.editActivity=function(){a.$emit(f,{panelTitle:"编辑活动",confirmBtnTitle:"保存",activity:$.extend(!0,{},a.selectedActivity)})},b.closeActivity=function(){confirm("确定要关闭活动？")&&c.closeActivity(a.selectedActivity._id)},b.deleteActivity=function(){confirm("确定要删除活动？")&&c.deleteActivity(a.selectedActivity._id,null,function(){alert("删除活动失败，请注意：有资源或有用户加入的活动不能删除")})},b.handlePlayBtnClick=function(){var b="activity_play.html#?aid="+a.selectedActivity._id;window.open(b,"_blank")},a.$on(e,function(){c.selectActivity()})}]),angular.module("ts.controllers.activityList",["ts.services.activity"]).controller("ActivityListController",["$rootScope","$scope","ActivityService",function(a,b,c){b.selectActivity=function(a){c.selectActivityByID(a)}}]),angular.module("ts.controllers.activityPanel",["ts.utils.constants","ts.services.activity","ts.services.user","ts.services.utils"]).controller("ActivityPanelController",["$rootScope","$scope","$http","ActivityService","UserService","UtilsService","CMD_SHOW_ACTIVITY_PANEL",function(a,b,c,d,e,f,g){function h(){return $.extend(!0,{},u.activityContent)}function i(){d.fetchActivityConfig(function(a){b.config=a})}function j(a,b){console.log(a,b),l(),n()}function k(a,c){a=a||{c:-1,msg:"UNKNOWN"};var d="其他未知错误";switch(a.c){case 1:d="后台其他错误";break;case 10:d="用户尚未登录";break;case 1e4:d="用户权限填写不正确";break;case 10010:d="活动标题填写不正确";break;case 10020:d="活动类型填写不正确";break;case 10040:d="活动日期填写不正确，必须晚于当前时间！";break;case 10050:d="出课教师填写不正确";break;case 10060:d="年级填写不正确";break;case 10070:d="班级填写不正确";break;case 10080:d="学科填写不正确";break;case 10090:d="课题填写不正确"}b.errMsg="["+c+"|"+a.c+"]"+d,l()}function l(){s.removeAttribute("disabled")}function m(){s.setAttribute("disabled","disabled")}function n(){p.modal("hide")}function o(){b.activity=h(),b.grade=b.cls=b.subject=0,b.errMsg="",q.tagsinput("removeAll")}b.grade=b.cls=b.subject=0;var p=$("#createActivityModal"),q=$('input[data-role="tagsinput"]'),r=document.getElementById("na_date"),s=document.getElementById("activityFormAllFields"),t=document.getElementById("activityFormFieldsForOpenActivities"),u={panelTitle:"创建活动",confirmBtnTitle:"创建活动",cancelBtnTitle:"取消",activityContent:{info:{type:1},users:{invitedUsers:[]}}};"datetime-local"!=r.type&&$("#na_data").datetimepicker("setEndDate",null),e.fetchOrganizationTree(function(){}),a.$on(g,function(c,d){d=d||{},b.panelTitle=d.panelTitle||u.panelTitle,b.confirmBtnTitle=d.confirmBtnTitle||u.confirmBtnTitle,b.cancelBtnTitle=d.cancelBtnTitle||u.cancelBtnTitle,b.activity=d.activity||h(),b.invitedUsers=b.activity.users.invitedUsers.join(",");for(var e=b.config?b.config.activityConfig:{},g=b.activity.info,i=0;i<e.classes.length;++i){var j=e.classes[i];if(j.grade==g.grade){b.grade=i,b.cls=j.cls.indexOf(g["class"]),console.log(b.grade,b.cls);break}}var k=b.activity.info.date,l=new Date,m=k?new Date(k):l;m.setSeconds(0),m.setMilliseconds(0),b.activity.info.date=f.time.dateToDatetimePickerValue(m),r.setAttribute("min",f.time.dateToDatetimePickerValue(l)),_.each(b.activity.users.invitedUsers,function(a){q.tagsinput("add",a)}),$("#orgTree").treeview({data:a.processedOrgTree,onNodeSelected:function(b,c){if(c.id){var d;if("*"==c.id)d="*";else{var e=a.orgUserIndex[c.id];e&&(d=e.name)}d&&q.tagsinput("add",d)}}}),b.showActivityPanel()}),p.on("hidden.bs.modal",function(){o()}),b.$watch("grade",function(){}),b.showActivityPanel=function(){$("#createActivityModal").modal("show"),!b.activity._id||b.activity.active?t.removeAttribute("disabled"):t.setAttribute("disabled","disabled")},b.createActivity=function(){b.errMsg="",m();var a=b.config?b.config.activityConfig:{},c=a.classes[b.grade],e=a.subjects[b.subject],g={uids:b.invitedUsers||"",title:b.activity.info.title||"",type:1|b.activity.info.type,desc:b.activity.info.desc||"",date:f.time.datetimePickerValueToTs(b.activity.info.date),teacher:b.activity.info.teacher||"",grade:c?c.grade:"","class":c?c.cls[b.cls]:"",subject:e||"",domain:b.activity.info.domain||"",link:b.activity.info.link||""};d.createActivity(g,j,k)},b.updateActivity=function(){b.errMsg="",m();var a=b.config?b.config.activityConfig:{},c={uids:b.invitedUsers||""};b.activity.active&&(c.title=b.activity.info.title||"",c.type=b.activity.info.type||"",c.desc=b.activity.info.desc||"",c.date=f.time.datetimePickerValueToTs(b.activity.info.date),c.teacher=b.activity.info.teacher||"",c.grade=a.classes[b.grade].grade||"",c["class"]=a.classes[b.grade].cls[b.cls]||"",c.subject=a.subjects[b.subject]||"",c.domain=b.activity.info.domain||"",c.link=b.activity.info.link||""),d.updateActivity(b.activity._id,c,j,k)},b.handleTestLinkBtnClick=function(){b.activity.info.link&&window.open(b.activity.info.link,"_blank")},b.handleConfirmBtnClick=function(){b.activity._id?b.updateActivity():b.createActivity()},i()}]),angular.module("ts.controllers.loginForm",["ts.utils.constants","ts.services.user"]).controller("LoginFormController",["$rootScope","$scope","UserService","CMD_SHOW_LOGIN_PANEL",function(a,b,c,d){b.uid="",b.pwd="",b.errMsg="",b.login=function(){function a(a,c){200==c?$("#loginModal").modal("hide"):(b.errMsg="验证失败",b.$digest()),b.uid=b.pwd=b.errMsg=""}b.uid?b.pwd?c.login(b.uid,b.pwd,a,a):(b.errMsg="请输入密码",b.$apply()):(b.errMsg="请输入帐号名",b.$apply())},a.$on(d,function(){if(c.hasLoggedIn()){if(!confirm("确定要退出登录吗？"))return;c.logout()}$("#loginModal").modal("show")})}]),angular.module("ts.controllers.main",["ts.utils.constants","ts.services.user","ts.services.activity"]).controller("MainController",["$rootScope","$scope","$http","$location","UserService","ActivityService","EVENT_LOGIN","CMD_SHOW_LOGIN_PANEL","EVENT_MODE_CHANGE",function(a,b,c,d,e,f,g,h,i){function j(){e.hasLoggedIn()&&a.fetchActivities()}a.fetchActivities=function(a){f.selectActivity(),f.fetchActivities(a)},a.showLoginModal=function(){a.$emit(h)},a.mode=function(){return d.search().mode},a.gotoMode=function(b){b!==a.mode()&&(d.search("mode",b),a.$emit(i,b))},a.$on(g,function(b,c){200==c&&(a.fetchActivities(),e.fetchOrganizationTree())}),window.rs=a,j()}]),angular.module("ts.controllers.navigator",["ts.services.user"]).controller("NavigatorController",["$rootScope","$scope","UserService","EVENT_LOGIN","CMD_SHOW_LOGIN_PANEL",function(a,b,c,d){function e(){b.nickname=c.nick()}a.$on(d,function(a,b){200==b&&e()}),e()}]),angular.module("ts.controllers.toolbar",["ts.utils.constants"]).controller("ToolbarController",["$rootScope","$scope","EVENT_MODE_CHANGE","CMD_SHOW_ACTIVITY_PANEL",function(a,b,c,d){b.authorizationTypes=[{label:"授权我参与的",value:"invited"},{label:"公开的",value:"public"},{label:"全部权限",value:null}],b.statuses=[{label:"开放的",value:"active"},{label:"关闭的",value:"closed"},{label:"全部状态",value:null}],b.aTypeIndex=2,b.statusIndex=2,b.searchKeyword="",b.showCreateActivityModal=function(b){b.currentTarget.classList.contains("disabled")||a.$emit(d)},b.updateQueryAndSearch=function(c,d){c&&(b[c]=d);var e={},f=b.authorizationTypes[b.aTypeIndex].value,g=b.statuses[b.statusIndex].value;f&&(e.authorize=f),g&&(e.status=g),b.searchKeyword&&(e.kw=b.searchKeyword),a.fetchActivities(e)},a.$on(c,function(){b.updateQueryAndSearch()})}]),angular.module("ts.directives.ngEnter",[]).directive("ngEnter",function(){function link(scope,element,attrs){element.on("keydown",function(event){if(13==event.keyCode){var callback=attrs.ngEnter;callback&&_.bind(function(){eval("this."+callback)},scope)()}})}return{link:link}}),function(){angular.module("teacherSpace",["ts.controllers.main","ts.controllers.navigator","ts.controllers.toolbar","ts.controllers.activityList","ts.controllers.activityDetail","ts.controllers.activityPanel","ts.controllers.loginForm","ts.directives.ngEnter"])}();