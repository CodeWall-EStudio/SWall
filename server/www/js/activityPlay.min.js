angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8080":"").constant("EVENT_LOGIN","event.login").constant("EVENT_LOGIN_CLICK","event.login.click").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(a){return _.map(a,function(a,c){return encodeURIComponent(c)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; ");return _.reduce(b,function(a,b){var e=b.split("=");a[e[0]]=e[1];return a},{})[a]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,c,l,e){return{uid:function(){return c.cookie.get("uid")},hasLoggedIn:function(){var a=c.cookie.get("uid"),b=c.cookie.get("skey");return a&&b},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(k,c,m,g){function d(d,b){console.log("[UserService] login result:",d,b,document.cookie);
200==b&&m?(localStorage.login_result=JSON.stringify(d),m(d,b)):g&&g(d,b);a.$emit(e,b,d)}b.put(l+"/users/"+k+"/login","pwd="+encodeURIComponent(c),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(d).error(d)}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,c,l,e){function k(d){d?(a.selectedActivity=d,a.selectedActivityID=d._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function p(d,f,h,n){f=c.object.toUrlencodedString(f);b.put(e+"/activities/"+d,f,{responseType:"json",
headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(d,b){if(d&&!d.c&&d.r)a:{var f=d.r;a.activityMap[f._id]=f;for(var n=0;n<a.activityList.length;++n)for(var g=a.activityList[n].activities,c=0;c<g.length;++c)if(g[c]._id==f._id){a.selectedActivity==g[c]&&(a.selectedActivity=f,a.selectedActivityID=f._id);g[c]=f;break a}}h&&h(d,b)}).error(n)}function m(d,b){a.activityList.splice(d,0,{date:g(b),activities:[b]})}function g(a){a=new Date(a.info.date);a.setHours(0);a.setMinutes(0);
a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:k,selectActivityByID:function(b){k(a.activityMap[b])},fetchActivities:function(d,f,c){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";d=d||{};"manager"==a.mode()&&(d.creator=l.uid());console.log("[ActivityService] fetching activities with",d);b.get(e+"/activities",{responseType:"json",params:d}).success(function(b,
d){if(200===d&&!b.c){var c=b.r.activities,h=_.groupBy(c,function(a){return g(a)});a.activityList=_.map(h,function(a,b){return{date:b,activities:a}});a.activityMap=_.reduce(c,function(a,b){a[b._id]=b;return a},{});a.hints=a.activityList.length?"":"\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8";console.log("[ActivityService] activities result",a.activityList,a.activityMap)}f&&f(b,d)}).error(function(b,d){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";c&&c(b,d)})},getActivity:function(a,c,g){b.get(e+"/activities/"+
a,{responseType:"json"}).success(c).error(g)},createActivity:function(d,f,h){d=c.object.toUrlencodedString(d);b.post(e+"/activities",d,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,d){if(b&&!b.c&&b.r)a:{var c=b.r[0];a.activityMap[c._id]=c;for(var h=g(c),e=0;e<a.activityList.length;++e){var k=a.activityList[e];if(k.date==h){k.activities.unshift(c);break a}else if(k.date>h){m(e,c);break a}}m(e,c)}f&&f(b,d)}).error(h)},updateActivity:p,closeActivity:function(a,
b,c){p(a,{status:"closed"},b,c)},fetchActivityConfig:function(a,c){b.get(e+"/activities/config",null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",b);a&&a(b,c)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");c&&c(a,b)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,b,c,l,e){a.username=e.nick();a.resources={};a.presources=[];b.selectedResource=null;b.selectedRIndex=-1;b.showResourceDetail=function(c){c.type&&(b.selectedResource=c,b.selectedRIndex=a.presources.indexOf(c))};b.hasPreviousPreviewableResource=function(){return 0<b.selectedRIndex};b.hasNextPreviewableResource=
function(){return b.selectedRIndex<a.presources.length-1};b.selectPreviousPreviewableResource=function(){0<b.selectedRIndex&&(--b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.selectNextPreviewableResource=function(){b.selectedRIndex<a.presources.length-1&&(++b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.hideResourceDetail=function(){b.selectedResource=null;b.selectedRIndex=-1};(function(){var b=c.search().aid;l.getActivity(b,function(b,c){console.log("[PlayerMainController] get activity success",
c,b);200!=c||b.c||(a.activity=b.r,a.resources=_.groupBy(a.activity.resources,function(a){a=new Date(a.date);a.setSeconds(0);a.setMilliseconds(0);return a.getTime()}),a.presources=_.filter(a.activity.resources,function(a){return 1==a.type||2==a.type}))},function(a,b){console.error("[PlayerMainController] get activity fail",b,a)});console.log("[PlayerMainController] getting info of activity "+b)})()}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();
