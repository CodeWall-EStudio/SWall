angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8090":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(a){return _.map(a,function(a,d){return encodeURIComponent(d)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; ");return _.reduce(b,function(a,b){var f=b.split("=");a[f[0]]=f[1];return a},{})[a]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,d,l,f){return{uid:function(){return d.cookie.get("uid")},hasLoggedIn:function(){var a=d.cookie.get("uid"),b=d.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(d,r,m,e){function c(b,c){console.log("[UserService] login result:",
b,c,document.cookie);200==c&&m?(localStorage.login_result=JSON.stringify(b),m(b,c)):e&&e(b,c);a.$emit(f,c,b)}b.put(l+"/users/"+d+"/login","pwd="+encodeURIComponent(r),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(c).error(c)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")},fetchProfile:function(a){}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,d,l,f){function q(b){b?(a.selectedActivity=b,a.selectedActivityID=b._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function r(e,h,t,p){c();h=h||{};h._=(new Date).getTime();h=d.object.toUrlencodedString(h);b.put(f+"/activities/"+
e,h,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,e){if(b&&!b.c&&b.r)a:{var k=b.r;a.activityMap[k._id]=k;for(var c=0;c<a.activityList.length;++c)for(var p=a.activityList[c].activities,h=0;h<p.length;++h)if(p[h]._id==k._id){a.selectedActivity==p[h]&&(a.selectedActivity=k,a.selectedActivityID=k._id);p[h]=k;break a}}n();t&&t(b,e)}).error(function(a,b){n();p&&p(a,b)})}function m(b,c){a.activityList.splice(b,0,{date:e(c),activities:[c]})}function e(a){a=
new Date(a.info.date);a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}function c(){g.setAttribute("disabled","disabled")}function n(){g.removeAttribute("disabled")}function s(){a.hints="\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8"}var g=document.getElementById("activityDetailButtons");a.profiles={};a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:q,selectActivityByID:function(b){q(a.activityMap[b])},
fetchActivities:function(c,h,d){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";c=c||{};"manager"==a.mode()&&(c.creator=l.uid());c._=(new Date).getTime();console.log("[ActivityService] fetching activities with",c);b.get(f+"/activities",{responseType:"json",params:c}).success(function(b,c){if(200===c&&!b.c){a.profiles=b.r.profiles;var k=b.r.activities,d=_.groupBy(k,function(a){return e(a)});a.activityList=_.map(d,function(a,b){return{date:b,activities:a}});a.activityMap=_.reduce(k,
function(a,b){a[b._id]=b;return a},{});a.activityList.length?a.hints="":s();console.log("[ActivityService] activities result",a.activityList,a.activityMap)}h&&h(b,c)}).error(function(b,c){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";d&&d(b,c)})},getActivity:function(a,c,e){var p=(new Date).getTime();b.get(f+"/activities/"+a+"?_="+p,{responseType:"json"}).success(c).error(e)},createActivity:function(c,h,n){c=c||{};c._=(new Date).getTime();c=d.object.toUrlencodedString(c);b.post(f+"/activities",c,
{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,c){if(b&&!b.c&&b.r){a.hints="";a:{var d=b.r[0];a.activityMap[d._id]=d;for(var n=e(d),k=0;k<a.activityList.length;++k){var s=a.activityList[k];if(s.date==n){s.activities.unshift(d);break a}else if(s.date>n){m(k,d);break a}}m(k,d)}}a.hints="";h&&h(b,c)}).error(n)},updateActivity:r,closeActivity:function(a,b,c){r(a,{status:"closed"},b,c)},deleteActivity:function(e,d,g){c();b({method:"DELETE",url:f+
"/activities/"+e+"?_="+(new Date).getTime()}).success(function(b,c){if(b&&!b.c)a:{q(),delete a.activityMap[e];for(var g=0;g<a.activityList.length;++g)for(var f=0;f<a.activityList[g].activities.length;++f)if(a.activityList[g].activities[f]._id==e){a.activityList[g].activities.splice(f,1);a.activityList[g].activities.length||a.activityList.splice(g,1);break a}}n();a.activityList.length||s();d&&d(b,c)}).error(function(a,b){n();g&&g(a,b)})},fetchActivityConfig:function(a,c){var e=(new Date).getTime();
b.get(f+"/activities/config?_="+e,null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",b);a&&a(b,c)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");c&&c(a,b)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,b,d,l,f){function q(){var e=d.search().aid;l.getActivity(e,function(c,e){console.log("[PlayerMainController] get activity success",e,c);if(200==e&&!c.c)if(a.profiles=c.profiles,a.activity=c.r,r(a.activity.resources),a.mainVideos.length||(a.mainVideos=c.r.videos||[]),a.activity.active)a.userCount=a.activity.users.participators.length,
b.autoRefresh&&(m=setTimeout(function(){q()},5E3));else{var d=_.countBy(a.activity.resources,function(a){return a.user});a.userCount=_.keys(d).length}},function(a,b){console.error("[PlayerMainController] get activity fail",b,a)});console.log("[PlayerMainController] getting info of activity "+e)}function r(b){var c=a.resources[0],d=c?c.resources[0].date:0;b=_.filter(b,function(a){return a.date>d});console.log("new resources",b);for(c=0;c<b.length;++c){var f=b[c],g=new Date(f.date);g.setSeconds(0);
g.setMilliseconds(0);g=g.getTime();a.resources[0]&&a.resources[0].ts==g?a.resources[0].resources.splice(0,0,f):a.resources.splice(0,0,{ts:g,resources:[f]});1!=f.type&&2!=f.type||a.presources.splice(0,0,f);-1==a.uploadedUsers.indexOf(f.user)&&a.uploadedUsers.push(f.user)}console.log("resources",a.resources);console.log("presources",a.presources)}var m=0;a.username=f.nick();a.userCount=0;a.uploadedUsers=[];a.rawResources=[];a.resources=[];a.presources=[];a.profiles={};a.selectedMainVideo=null;a.editingOrder=
!1;a.editingTime=!1;a.mainVideos=[];b.selectedUser=null;b.selectedResource=null;b.selectedRIndex=-1;b.autoRefresh=!0;b.$watch("selectedResource",function(a){a&&2==a.type&&setTimeout(function(){document.getElementById("videoPlayer").src=a.content},100)});a.uid2nick=function(b){return a.profiles[b]?a.profiles[b].nick:b};b.uploadMainVideo=function(){};b.selectMainVideo=function(a){b.selectedMainVideo=a};b.enterEditTimeMode=function(e){e&&(b.selectedMainVideo=e);a.editingTime=e?!0:!1};b.showResourceDetail=
function(e){e.type&&(b.selectedResource=e,b.selectedRIndex=a.presources.indexOf(e))};b.hasPreviousPreviewableResource=function(){return 0<b.selectedRIndex};b.hasNextPreviewableResource=function(){return b.selectedRIndex<a.presources.length-1};b.selectPreviousPreviewableResource=function(){0<b.selectedRIndex&&(--b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.selectNextPreviewableResource=function(){b.selectedRIndex<a.presources.length-1&&(++b.selectedRIndex,b.selectedResource=
a.presources[b.selectedRIndex])};b.filterByUser=function(a){b.selectedUser=a;$(".resourceGroup").css("display","none");setTimeout(function(){$(".resourceGroup").css("display","-webkit-box");b.$digest();refreshAllNextItemLineHeight()},0)};b.nextLineHeight=function(a,b){if(b){var d=$('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]').outerHeight();return d?d-3:0}return 0};b.isFirstResourceInGroup=function(a,b){if(0==b)return!0;var d=document.querySelector('.resourceItem[data-gindex="'+a+'"][data-rindex="'+
b+'"]');if(d){var f=d.parentElement.querySelectorAll(".resourceItem:not(.ng-hide)")[0];return d==f}return!1};b.resourceShouldBeVisible=function(a){return!b.selectedUser||b.selectedUser==a.user};b.groupContainsResourceOfSelectedUser=function(a){return b.selectedUser?_.some(a.resources,function(a){return a.user==b.selectedUser}):!0};b.hideResourceDetail=function(){b.selectedResource=null;b.selectedRIndex=-1};b.toggleAuthRefresh=function(){b.autoRefresh=!b.autoRefresh;b.autoRefresh?q():m&&(clearTimeout(m),
m=0)};window.rs=a;q()}]);function onImgLoad(a){var b=$(a.target).parents(".resourceItem")[0];a=parseInt(b.getAttribute("data-gindex"));b=parseInt(b.getAttribute("data-rindex"));updateNextItemLineHeight(a,b)}function updateNextItemLineHeight(a,b){var d=$('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]'),l=$('.resourceItem[data-gindex="'+a+'"][data-rindex="'+(b+1)+'"] .nextLine'),d=d.outerHeight();l.length&&l.height(d-3)}
function refreshAllNextItemLineHeight(){_.each(rs.resources,function(a,b){_.each(a.resources,function(a,l){0!==a.type&&updateNextItemLineHeight(b,l)})})};(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();
