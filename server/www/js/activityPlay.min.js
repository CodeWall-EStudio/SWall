angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8090":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){var a={object:{toUrlencodedString:function(a){return _.map(a,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var c=document.cookie.split("; ");return _.reduce(c,function(a,b){var n=b.split("=");a[n[0]]=n[1];return a},{})[a]}},time:{timezoneOffset:(new Date).getTimezoneOffset(),dateToDatetimePickerValue:function(b,c){b||(b=new Date);b.setMinutes(b.getMinutes()-a.time.timezoneOffset);
c||(b.setSeconds(0),b.setMilliseconds(0));return b.toISOString().split(".")[0]},datetimePickerValueToTs:function(b){if(b){var c=3>b.split(":").length?":00.000Z":".000Z",c=Date.parse(b+c)+6E4*a.time.timezoneOffset;console.log(b,c,new Date(c));return c}return 0}}};return a}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,c,s,l){return{uid:function(){return c.cookie.get("uid")},hasLoggedIn:function(){var a=c.cookie.get("uid"),b=c.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(c,q,p,k){function m(b,c){console.log("[UserService] login result:",
b,c,document.cookie);200==c&&p?(localStorage.login_result=JSON.stringify(b),p(b,c)):k&&k(b,c);a.$emit(l,c,b)}b.put(s+"/users/"+c+"/login","pwd="+encodeURIComponent(q),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(m).error(m)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")},fetchProfile:function(a){},activity:{isCreatorOfActivity:function(a){return c.cookie.get("uid")==
a.users.creator}}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,c,s,l){function n(b){b?(a.selectedActivity=b,a.selectedActivityID=b._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function q(g,e,f,d){m();e=e||{};e._=(new Date).getTime();e=c.object.toUrlencodedString(e);b.put(l+"/activities/"+
g,e,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e,b){if(e&&!e.c&&e.r)a:{var d=e.r;a.activityMap[d._id]=d;for(var g=0;g<a.activityList.length;++g)for(var c=a.activityList[g].activities,k=0;k<c.length;++k)if(c[k]._id==d._id){a.selectedActivity==c[k]&&(a.selectedActivity=d,a.selectedActivityID=d._id);c[k]=d;break a}}t();f&&f(e,b)}).error(function(a,e){t();d&&d(a,e)})}function p(b,e){a.activityList.splice(b,0,{date:k(e),activities:[e]})}function k(a){a=
new Date(a.info.date);a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}function m(){r.setAttribute("disabled","disabled")}function t(){r.removeAttribute("disabled")}function u(){a.hints="\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8"}var r=document.getElementById("activityDetailButtons");a.profiles={};a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:n,selectActivityByID:function(b){n(a.activityMap[b])},
fetchActivities:function(g,e,f){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";g=g||{};"manager"==a.mode()&&(g.creator=s.uid());g._=(new Date).getTime();console.log("[ActivityService] fetching activities with",g);b.get(l+"/activities",{responseType:"json",params:g}).success(function(b,f){if(200===f&&!b.c){a.profiles=b.r.profiles;var h=b.r.activities,g=_.groupBy(h,function(a){return k(a)});a.activityList=_.map(g,function(a,b){return{date:b,activities:a}});a.activityMap=_.reduce(h,
function(a,b){a[b._id]=b;return a},{});a.activityList.length?a.hints="":u();console.log("[ActivityService] activities result",a.activityList,a.activityMap)}e&&e(b,f)}).error(function(b,e){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";f&&f(b,e)})},getActivity:function(a,e,f){var d=(new Date).getTime();b.get(l+"/activities/"+a+"?_="+d,{responseType:"json"}).success(e).error(f)},createActivity:function(g,e,f){g=g||{};g._=(new Date).getTime();g=c.object.toUrlencodedString(g);b.post(l+"/activities",g,
{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,f){if(b&&!b.c&&b.r){a.hints="";a:{var h=b.r[0];a.activityMap[h._id]=h;for(var g=k(h),c=0;c<a.activityList.length;++c){var m=a.activityList[c];if(m.date==g){m.activities.unshift(h);break a}else if(m.date>g){p(c,h);break a}}p(c,h)}}a.hints="";e&&e(b,f)}).error(f)},updateActivity:q,closeActivity:function(a,b,f){q(a,{status:"closed"},b,f)},deleteActivity:function(g,e,f){m();b({method:"DELETE",url:l+
"/activities/"+g+"?_="+(new Date).getTime()}).success(function(b,f){if(b&&!b.c)a:{n(),delete a.activityMap[g];for(var h=0;h<a.activityList.length;++h)for(var c=0;c<a.activityList[h].activities.length;++c)if(a.activityList[h].activities[c]._id==g){a.activityList[h].activities.splice(c,1);a.activityList[h].activities.length||a.activityList.splice(h,1);break a}}t();a.activityList.length||u();e&&e(b,f)}).error(function(a,b){t();f&&f(a,b)})},fetchActivityConfig:function(a,e){var f=(new Date).getTime();
b.get(l+"/activities/config?_="+f,null,{responseType:"json"}).success(function(b,e){console.log("[ActivityService] activity config =",b);a&&a(b,e)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");e&&e(a,b)})},statistics:{byUser:function(a,b){var f=_.countBy(_.pluck(a.resources,"user")),f=_.map(f,function(a,b){return{uid:b,count:a}});return _.sortBy(f,function(a){return-a.count})},byTime:function(a,b){var f=_.first(a.resources);if(f){var d=f.date,c={};
b=1E3*(b||300);_.each(a.resources,function(a){var f=Math.floor((a.date-d)/b)*b;c[f]||(c[f]=[]);c[f].push(a)});return{beginning:d,items:c}}return{}}}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user","ts.services.utils"]).controller("PlayerMainController",["$rootScope","$scope","$location","$sce","ActivityService","UserService","UtilsService",function(a,b,c,s,l,n,q){function p(a,b,d,c){a="/activities/"+u+"/videos/"+a;var h=new XMLHttpRequest,g=new FormData;_.each(b,function(a,b){g.append(b,a)});console.log("updating main videos",a,b);h.addEventListener("load",function(a){d&&d(h,a,JSON.parse(h.responseText))});h.addEventListener("error",
function(a){c&&c(h,a)});h.open("PUT",a);h.send(g)}function k(){l.getActivity(u,function(e,f){console.log("[PlayerMainController] get activity success",f,e);if(200==f&&!e.c){a.profiles=e.profiles;a.activity=e.r;m(a.activity.resources);a.updateMainVideos(e.r.videos||[]);if(a.activity.active)a.userCount=a.activity.users.participators.length,b.autoRefresh&&(r=setTimeout(function(){k()},5E3));else{var d=_.countBy(a.activity.resources,function(a){return a.user});a.userCount=_.keys(d).length}b.shouldShowUploadMainButton=
n.activity.isCreatorOfActivity(a.activity)}},function(a,b){console.error("[PlayerMainController] get activity fail",b,a)});console.log("[PlayerMainController] getting info of activity "+u)}function m(b){var f=a.resources[0],d=f?f.resources[0].date:0;b=_.filter(b,function(a){return a.date>d});console.log("new resources",b);for(f=0;f<b.length;++f){var c=b[f],h=new Date(c.date);h.setSeconds(0);h.setMilliseconds(0);h=h.getTime();a.resources[0]&&a.resources[0].ts==h?a.resources[0].resources.splice(0,0,
c):a.resources.splice(0,0,{ts:h,resources:[c]});1!=c.type&&2!=c.type||a.presources.splice(0,0,c);-1==a.uploadedUsers.indexOf(c.user)&&a.uploadedUsers.push(c.user)}console.log("resources",a.resources);console.log("presources",a.presources)}function t(a){for(var b=_.map($(".resourceItem"),function(a){return parseInt(a.getAttribute("data-ts"))}).sort(),d=0;d<b.length;++d)if(b[d]>=a)return b[d-1];return _.last(b)}var u=c.search().aid,r=0,g=document.getElementById("player");a.username=n.nick();a.userCount=
0;a.uploadedUsers=[];a.rawResources=[];a.resources=[];a.presources=[];a.highlightResource={};a.profiles={};a.selectedMainVideo=null;a.editingOrder=!1;a.editingTime=!1;a.mainVideos=[];b.selectedUser=null;b.selectedResource=null;b.selectedRIndex=-1;b.autoRefresh=!0;b.shouldShowUploadMainButton=!1;a.updateMainVideos=function(b){a.mainVideos=_.map(b,function(a){a.url||(a.url=s.trustAsResourceUrl(a.src));return a});console.log("[MainVideos]",a.mainVideos)};b.$watch("selectedResource",function(a){a&&2==
a.type&&setTimeout(function(){document.getElementById("videoPlayer").src=a.content},100)});a.uid2nick=function(b){return a.profiles[b]?a.profiles[b].nick:b};a.timelineStartTime=function(){var b=_.last(a.resources);return(b=b?_.last(b.resources):void 0)&&a.selectedMainVideo?b.date:0};a.selectedMainVideoStartTime=function(){var b=a.timelineStartTime();a.selectedMainVideo&&(b+=1E3*a.selectedMainVideo.startTime);return b};a.selectedMainVideoStopTime=function(){return a.selectedMainVideo?a.selectedMainVideoStartTime()+
1E3*a.selectedMainVideo.duration:0};b.selectMainVideo=function(b){g.pause();a.selectedMainVideo=b;b=new Date(a.selectedMainVideoStartTime());a.selectedMainVideoStartDate={y:b.getFullYear(),M:b.getMonth()+1,d:b.getDate(),h:b.getHours(),m:b.getMinutes(),s:b.getSeconds()}};b.toggleVideoPlayer=function(){g.paused?g.play():g.pause()};b.enterEditOrderMode=function(e){(a.editingOrder=e)?g.pause():b.updateMainVideosOrder()};b.enterEditTimeMode=function(e,f){a.editingTime=e?!0:!1;e?a.selectedMainVideo=e:f&&
b.updateMainVideoTiming()};b.updateMainVideosLocalOrder=function(b,f){var d=a.mainVideos.splice(b,1)[0];a.mainVideos.splice(f?b-1:b+1,0,d)};b.updateMainVideosOrder=function(){p(a.mainVideos[0]._id,{orders:_.map(a.mainVideos,function(a){return a._id}).join(",")},function(a,b,d){console.log(a.status,d)},function(a,b){console.log(a.status,b)})};b.updateMainVideoTiming=function(){var b=a.timelineStartTime(),f=new Date(b),d=new Date;d.setFullYear(a.selectedMainVideoStartDate.y);d.setMonth(a.selectedMainVideoStartDate.M-
1);d.setDate(a.selectedMainVideoStartDate.d);d.setHours(a.selectedMainVideoStartDate.h);d.setMinutes(a.selectedMainVideoStartDate.m);d.setSeconds(a.selectedMainVideoStartDate.s);d.setMilliseconds(f.getMilliseconds());b=(d.getTime()-b)/1E3;0<=b?(a.selectedMainVideoStartDate={y:d.getFullYear(),M:d.getMonth()+1,d:d.getDate(),h:d.getHours(),m:d.getMinutes(),s:d.getSeconds()},a.selectedMainVideo.startTime=b,p(a.selectedMainVideo._id,{startTime:b},function(a,b,f){console.log(a.status,f)},function(a,b){console.log(a.status,
b)})):(alert("\u4e3b\u89c6\u9891\u5f00\u59cb\u5f55\u5236\u65f6\u95f4\u5fc5\u987b\u665a\u4e8e\u65f6\u95f4\u8f74\u5f00\u59cb\u65f6\u95f4\uff01"),d=new Date(a.selectedMainVideoStartTime()),a.selectedMainVideoStartDate={y:d.getFullYear(),M:d.getMonth()+1,d:d.getDate(),h:d.getHours(),m:d.getMinutes(),s:d.getSeconds()})};b.showResourceDetail=function(e){e.type&&(b.selectedResource=e,b.selectedRIndex=a.presources.indexOf(e))};b.hasPreviousPreviewableResource=function(){return 0<b.selectedRIndex};b.hasNextPreviewableResource=
function(){return b.selectedRIndex<a.presources.length-1};b.selectPreviousPreviewableResource=function(){0<b.selectedRIndex&&(--b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.selectNextPreviewableResource=function(){b.selectedRIndex<a.presources.length-1&&(++b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.filterByUser=function(a){b.selectedUser=a;$(".resourceGroup").css("display","none");setTimeout(function(){$(".resourceGroup").css("display","-webkit-box");
b.$digest();refreshAllNextItemLineHeight()},0)};b.nextLineHeight=function(a,b){if(b){var d=$('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]').outerHeight();return d?d-3:0}return 0};b.isFirstResourceInGroup=function(a,b){if(0==b)return!0;var d=document.querySelector('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]');if(d){var c=d.parentElement.querySelectorAll(".resourceItem:not(.ng-hide)")[0];return d==c}return!1};b.resourceShouldBeVisible=function(a){return!b.selectedUser||b.selectedUser==
a.user};b.groupContainsResourceOfSelectedUser=function(a){return b.selectedUser?_.some(a.resources,function(a){return a.user==b.selectedUser}):!0};b.hideResourceDetail=function(){b.selectedResource=null;b.selectedRIndex=-1};b.toggleAuthRefresh=function(){b.autoRefresh=!b.autoRefresh;b.autoRefresh?k():r&&(clearTimeout(r),r=0)};b.showUserStatistics=function(){b.stat=2;var e=l.statistics.byUser(a.activity,10),e=_.map(e,function(b){return[a.uid2nick(b.uid),b.count]});e.splice(0,0,["\u7528\u6237","\u8d44\u6e90\u6570"]);
var f=google.visualization.arrayToDataTable(e),d={is3D:!0},c=new google.visualization.PieChart(document.getElementById("statBody"));setTimeout(function(){c.draw(f,d)},200)};b.showTimeStatistics=function(){b.stat=1;var c=l.statistics.byTime(a.activity),f=c.beginning,c=_.map(c.items,function(a,b){var c=new Date(parseInt(b)+f);return[c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+" "+c.getHours()+":"+c.getMinutes(),a.length]});c.splice(0,0,["\u65f6\u95f4","\u8d44\u6e90\u6570"]);var d=google.visualization.arrayToDataTable(c),
g={hAxis:{title:"\u65f6\u95f4",titleTextStyle:{color:"red"}}},h=new google.visualization.ColumnChart(document.getElementById("statBody"));setTimeout(function(){h.draw(d,g)},200)};window.rs=a;window.utils=q;k();(function(){var b=document.querySelector("video");b.addEventListener("timeupdate",function(c){c=a.selectedMainVideoStartTime()+1E3*b.currentTime;c=t(c);c=$(".resourceItem[data-ts="+c+"]");var d=c.parents(".resourceGroup"),g=parseInt(c.attr("data-gindex")),h=parseInt(c.attr("data-rindex")),d=
d.position();c=c.position();d=d?d.top:0;c=c?c.top:0;var k=$("#timeline");if(a.highlightResource.g!==g||a.highlightResource.r!==h)k.scrollTop(k.scrollTop()+d+c),a.$apply(function(){a.highlightResource={g:g,r:h};var b=k.width();k.width(b+1);setTimeout(function(){k.width(b)},0)})})})()}]);document.domain="71xiaoxue.com";
angular.module("ap.controllers.videoUploader",["ts.services.activity","ts.services.user"]).controller("MainVideoUploaderController",["$rootScope","$scope","$location","ActivityService","UserService","UtilsService",function(a,b,c,s,l,n){function q(){$("#mainVideoFile").val(null);b.videoFile=null;b.videoName=null;b.videoDuration=0;b.videoIsReading=!1;b.videoIsUploading=!1;b.videoIsAdding=!1;b.videoUploadProgress=0;b.videoURL=null}var p=document.getElementById("mainVideoFile");b.skey=n.cookie.get("skey");
q();b.onSelectedFile=function(){b.$apply(function(){var a=p.files,a=a?a[0]:null;console.log("[uploader] selected file",a);if(a&&"video/mp4"==a.type){b.videoFile=a;var c=document.createElement("video"),a=window.URL.createObjectURL(a);c.addEventListener("loadedmetadata",function(){b.$apply(function(){b.videoIsReading=!1;b.videoDuration=c.duration;console.log("[uploader] video duration = "+c.duration)})});c.src=a;b.videoIsReading=!0;console.log("[uploader] reading video file ...")}else alert("\u5bf9\u4e0d\u8d77\uff0c\u60a8\u6240\u9009\u62e9\u7684\u6587\u4ef6\u683c\u5f0f\u4e0d\u652f\u6301 "),
b.videoFile=null,b.videoDuration=0})};b.startUpload=function(){b.videoIsUploading=!0;document.querySelector("#uploadMainVideoForm").submit()};b.submitLabel=function(){return b.videoIsReading?"\u8bf7\u7a0d\u5019":b.videoIsUploading?"\u4e0a\u4f20\u4e2d":b.videoIsAdding?"\u6dfb\u52a0\u4e2d":"\u6dfb\u52a0"};window.addVideoToActivity=function(k){b.videoIsUploading=!1;console.log("\u4e0a\u4f20\u89c6\u9891\u7ed3\u679c\uff1a",k);if(0>k)alert("\u4e0a\u4f20\u89c6\u9891\u5931\u8d25 ["+k+"]\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5");
else if(b.videoName){b.videoURL="http://szone.71xiaoxue.com/download/media?id="+k;k=c.search().aid;var m=new FormData,l=new XMLHttpRequest;m.append("src",b.videoURL);m.append("name",b.videoName);m.append("duration",b.videoDuration);l.addEventListener("load",function(c){b.videoIsAdding=!1;if(201==l.status){var k=(c=JSON.parse(l.responseText))?c.c:-1,g=c?c.r:null;console.log("[uploader] add success",c);!k&&g&&($("#uploadMainVideoModal").modal("hide"),a.updateMainVideos(g.videos))}else alert("\u6dfb\u52a0\u4e3b\u89c6\u9891\u5931\u8d25");
a.$digest()});l.addEventListener("error",function(a){console.log("[uploader] add video error",a);b.$apply(function(){q()})});b.videoIsAdding=!0;l.open("POST","/activities/"+k+"/videos");l.send(m);console.log("[uploader] adding video to activity",k)}else alert("\u4e0a\u4f20\u89c6\u9891\u5931\u8d25\uff0c\u8bf7\u8f93\u5165\u6709\u6548\u7684\u89c6\u9891\u540d\u5b57")};window.$scope=b}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main","ap.controllers.videoUploader"])})();
