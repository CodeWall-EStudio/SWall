angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8080":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(a){return _.map(a,function(a,e){return encodeURIComponent(e)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var c=document.cookie.split("; ");return _.reduce(c,function(a,c){var f=c.split("=");a[f[0]]=f[1];return a},{})[a]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,c,e,m,f){function h(){return h}return{uid:function(){return e.cookie.get("uid")},hasLoggedIn:function(){var a=e.cookie.get("uid"),c=e.cookie.get("skey");return a&&c},nick:h,login:function(e,n,l,b){function d(d,g){console.log("[UserService] login result:",d,g,document.cookie);200==g&&l?(h=d.nick,l(d,g)):b&&b(d,g);a.$emit(f,
g,d)}c.put(m+"/users/"+e+"/login","pwd="+encodeURIComponent(n),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(d).error(d)}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,c,e,m,f){function h(b){b?(a.selectedActivity=b,a.selectedActivityID=b._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function q(b,d,k,g){d=e.object.toUrlencodedString(d);c.put(f+"/activities/"+b,d,{responseType:"json",
headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,d){if(b&&!b.c&&b.r)a:{var g=b.r;a.activityMap[g._id]=g;for(var p=0;p<a.activityList.length;++p)for(var c=a.activityList[p].activities,e=0;e<c.length;++e)if(c[e]._id==g._id){a.selectedActivity==c[e]&&(a.selectedActivity=g,a.selectedActivityID=g._id);c[e]=g;break a}}k&&k(b,d)}).error(g)}function n(b,d){a.activityList.splice(b,0,{date:l(d),activities:[d]})}function l(a){a=new Date(a.info.date);a.setHours(0);a.setMinutes(0);
a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:h,selectActivityByID:function(b){h(a.activityMap[b])},fetchActivities:function(b,d,e){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";b=b||{};"manager"==a.mode()&&(b.creator=m.uid());console.log("[ActivityService] fetching activities with",b);c.get(f+"/activities",{responseType:"json",params:b}).success(function(b,
e){if(200===e&&!b.c){var c=b.r.activities,k=_.groupBy(c,function(a){return l(a)});a.activityList=_.map(k,function(a,b){return{date:b,activities:a}});a.activityMap=_.reduce(c,function(a,b){a[b._id]=b;return a},{});a.hints=a.activityList.length?"":"\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8";console.log("[ActivityService] activities result",a.activityList,a.activityMap)}d&&d(b,e)}).error(function(b,d){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";e&&e(b,d)})},getActivity:function(a,d,e){c.get(f+"/activities/"+
a,{responseType:"json"}).success(d).error(e)},createActivity:function(b,d,k){b=e.object.toUrlencodedString(b);c.post(f+"/activities",b,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,e){if(b&&!b.c&&b.r)a:{var c=b.r[0];a.activityMap[c._id]=c;for(var k=l(c),f=0;f<a.activityList.length;++f){var h=a.activityList[f];if(h.date==k){h.activities.unshift(c);break a}else if(h.date>k){n(f,c);break a}}n(f,c)}d&&d(b,e)}).error(k)},updateActivity:q,closeActivity:function(a,
d,c){q(a,{status:"closed"},d,c)},fetchActivityConfig:function(a,d){c.get(f+"/activities/config",null,{responseType:"json"}).success(function(d,c){console.log("[ActivityService] activity config =",d);a&&a(d,c)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");d&&d(a,b)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,c,e,m,f){a.username=f.uid();(function(){var c=e.search().aid;m.getActivity(c,function(c,e){if(200==e&&!c.c){a.activity=c.r;var f=new Date(c.r.info.date);a.activityDate=f.getFullYear()+"\u5e74"+(f.getMonth()+1)+"\u6708"+f.getDate()+"\u65e5";a.activityTime=f.getHours()+":"+f.getMinutes()}},function(a,c){});console.log("[PlayerMainController] getting info of activity "+
c)})()}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();
