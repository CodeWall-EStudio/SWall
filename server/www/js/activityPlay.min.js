angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8080":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(a){return _.map(a,function(a,g){return encodeURIComponent(g)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; ");return _.reduce(b,function(a,b){var f=b.split("=");a[f[0]]=f[1];return a},{})[a]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,g,n,f){return{uid:function(){return g.cookie.get("uid")},hasLoggedIn:function(){var a=g.cookie.get("uid"),b=g.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(g,k,e,d){function c(c,b){console.log("[UserService] login result:",
c,b,document.cookie);200==b&&e?(localStorage.login_result=JSON.stringify(c),e(c,b)):d&&d(c,b);a.$emit(f,b,c)}b.put(n+"/users/"+g+"/login","pwd="+encodeURIComponent(k),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(c).error(c)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,g,n,f){function p(c){c?(a.selectedActivity=c,a.selectedActivityID=c._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function k(c,d,h,m){d=g.object.toUrlencodedString(d);b.put(f+"/activities/"+c,d,{responseType:"json",
headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(c,b){if(c&&!c.c&&c.r)a:{var d=c.r;a.activityMap[d._id]=d;for(var l=0;l<a.activityList.length;++l)for(var m=a.activityList[l].activities,e=0;e<m.length;++e)if(m[e]._id==d._id){a.selectedActivity==m[e]&&(a.selectedActivity=d,a.selectedActivityID=d._id);m[e]=d;break a}}h&&h(c,b)}).error(m)}function e(c,b){a.activityList.splice(c,0,{date:d(b),activities:[b]})}function d(a){a=new Date(a.info.date);a.setHours(0);a.setMinutes(0);
a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:p,selectActivityByID:function(c){p(a.activityMap[c])},fetchActivities:function(c,e,h){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";c=c||{};"manager"==a.mode()&&(c.creator=n.uid());console.log("[ActivityService] fetching activities with",c);b.get(f+"/activities",{responseType:"json",params:c}).success(function(c,
b){if(200===b&&!c.c){var h=c.r.activities,g=_.groupBy(h,function(a){return d(a)});a.activityList=_.map(g,function(a,c){return{date:c,activities:a}});a.activityMap=_.reduce(h,function(a,c){a[c._id]=c;return a},{});a.hints=a.activityList.length?"":"\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8";console.log("[ActivityService] activities result",a.activityList,a.activityMap)}e&&e(c,b)}).error(function(c,b){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";h&&h(c,b)})},getActivity:function(a,d,e){b.get(f+"/activities/"+
a,{responseType:"json"}).success(d).error(e)},createActivity:function(c,l,h){c=g.object.toUrlencodedString(c);b.post(f+"/activities",c,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(c,b){if(c&&!c.c&&c.r)a:{var h=c.r[0];a.activityMap[h._id]=h;for(var g=d(h),f=0;f<a.activityList.length;++f){var k=a.activityList[f];if(k.date==g){k.activities.unshift(h);break a}else if(k.date>g){e(f,h);break a}}e(f,h)}l&&l(c,b)}).error(h)},updateActivity:k,closeActivity:function(a,
b,d){k(a,{status:"closed"},b,d)},fetchActivityConfig:function(a,d){b.get(f+"/activities/config",null,{responseType:"json"}).success(function(b,d){console.log("[ActivityService] activity config =",b);a&&a(b,d)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");d&&d(a,b)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,b,g,n,f){function p(){var b=g.search().aid;n.getActivity(b,function(b,c){console.log("[PlayerMainController] get activity success",c,b);if(200==c&&!b.c)if(a.activity=b.r,k(b.r),a.activity.active)a.userCount=a.activity.users.participators.length,setTimeout(function(){p()},5E3);else{var e=_.countBy(a.selectedActivity.resources,
function(a){return a.user});a.userCount=_.keys(e).length}},function(a,b){console.error("[PlayerMainController] get activity fail",b,a)});console.log("[PlayerMainController] getting info of activity "+b)}function k(b){b.resources.reverse();a.rawResources=b.resources;a.resources=_.map(_.groupBy(a.rawResources,function(a){a=new Date(a.date);a.setSeconds(0);a.setMilliseconds(0);return a.getTime()}),function(a,b){return{ts:b,resources:a}});a.presources=_.filter(a.rawResources,function(a){return 1==a.type||
2==a.type})}a.username=f.nick();a.userCount=0;a.rawResources=[];a.resources=[];a.presources=[];b.selectedResource=null;b.selectedRIndex=-1;b.showResourceDetail=function(e){e.type&&(b.selectedResource=e,b.selectedRIndex=a.presources.indexOf(e))};b.hasPreviousPreviewableResource=function(){return 0<b.selectedRIndex};b.hasNextPreviewableResource=function(){return b.selectedRIndex<a.presources.length-1};b.selectPreviousPreviewableResource=function(){0<b.selectedRIndex&&(--b.selectedRIndex,b.selectedResource=
a.presources[b.selectedRIndex])};b.selectNextPreviewableResource=function(){b.selectedRIndex<a.presources.length-1&&(++b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.hideResourceDetail=function(){b.selectedResource=null;b.selectedRIndex=-1};p()}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();
