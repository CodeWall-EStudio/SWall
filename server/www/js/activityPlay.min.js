angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8080":"").constant("EVENT_LOGIN","event.login").constant("EVENT_LOGIN_CLICK","event.login.click").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(a){return _.map(a,function(a,d){return encodeURIComponent(d)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var c=document.cookie.split("; ");return _.reduce(c,function(a,c){var e=c.split("=");a[e[0]]=e[1];return a},{})[a]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,c,d,m,e){return{uid:function(){return d.cookie.get("uid")},hasLoggedIn:function(){var a=d.cookie.get("uid"),c=d.cookie.get("skey");return a&&c},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(d,h,n,l){function b(b,f){console.log("[UserService] login result:",b,f,document.cookie);
200==f&&n?(localStorage.login_result=JSON.stringify(b),n(b,f)):l&&l(b,f);a.$emit(e,f,b)}c.put(m+"/users/"+d+"/login","pwd="+encodeURIComponent(h),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(b).error(b)}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,c,d,m,e){function q(b){b?(a.selectedActivity=b,a.selectedActivityID=b._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function h(b,g,f,k){g=d.object.toUrlencodedString(g);c.put(e+"/activities/"+b,g,{responseType:"json",
headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,g){if(b&&!b.c&&b.r)a:{var k=b.r;a.activityMap[k._id]=k;for(var p=0;p<a.activityList.length;++p)for(var c=a.activityList[p].activities,d=0;d<c.length;++d)if(c[d]._id==k._id){a.selectedActivity==c[d]&&(a.selectedActivity=k,a.selectedActivityID=k._id);c[d]=k;break a}}f&&f(b,g)}).error(k)}function n(b,g){a.activityList.splice(b,0,{date:l(g),activities:[g]})}function l(a){a=new Date(a.info.date);a.setHours(0);a.setMinutes(0);
a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:q,selectActivityByID:function(b){q(a.activityMap[b])},fetchActivities:function(b,g,f){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";b=b||{};"manager"==a.mode()&&(b.creator=m.uid());console.log("[ActivityService] fetching activities with",b);c.get(e+"/activities",{responseType:"json",params:b}).success(function(b,
f){if(200===f&&!b.c){var c=b.r.activities,d=_.groupBy(c,function(a){return l(a)});a.activityList=_.map(d,function(a,b){return{date:b,activities:a}});a.activityMap=_.reduce(c,function(a,b){a[b._id]=b;return a},{});a.hints=a.activityList.length?"":"\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8";console.log("[ActivityService] activities result",a.activityList,a.activityMap)}g&&g(b,f)}).error(function(b,c){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";f&&f(b,c)})},getActivity:function(a,g,f){c.get(e+"/activities/"+
a,{responseType:"json"}).success(g).error(f)},createActivity:function(b,g,f){b=d.object.toUrlencodedString(b);c.post(e+"/activities",b,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,f){if(b&&!b.c&&b.r)a:{var c=b.r[0];a.activityMap[c._id]=c;for(var d=l(c),e=0;e<a.activityList.length;++e){var h=a.activityList[e];if(h.date==d){h.activities.unshift(c);break a}else if(h.date>d){n(e,c);break a}}n(e,c)}g&&g(b,f)}).error(f)},updateActivity:h,closeActivity:function(a,
c,f){h(a,{status:"closed"},c,f)},fetchActivityConfig:function(a,d){c.get(e+"/activities/config",null,{responseType:"json"}).success(function(c,d){console.log("[ActivityService] activity config =",c);a&&a(c,d)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");d&&d(a,b)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,c,d,m,e){a.username=e.nick();(function(){var c=d.search().aid;m.getActivity(c,function(c,d){if(200==d&&!c.c){a.activity=c.r;var e=new Date(c.r.info.date);a.activityDate=e.getFullYear()+"\u5e74"+(e.getMonth()+1)+"\u6708"+e.getDate()+"\u65e5";a.activityTime=e.getHours()+":"+e.getMinutes();a.resources=_.groupBy(a.activity.resources,
function(a){a=new Date(a.date);a.setSeconds(0);a.setMilliseconds(0);return a.getTime()})}},function(a,c){});console.log("[PlayerMainController] getting info of activity "+c)})()}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();
