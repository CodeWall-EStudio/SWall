angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8090":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){var b={object:{toUrlencodedString:function(b){return _.map(b,function(b,a){return encodeURIComponent(a)+"="+encodeURIComponent(b)}).join("&")}},cookie:{get:function(b){var l=document.cookie.split("; ");return _.reduce(l,function(b,a){var q=a.split("=");b[q[0]]=q[1];return b},{})[b]}},time:{timezoneOffset:(new Date).getTimezoneOffset(),dateToDatetimePickerValue:function(a,l){a||(a=new Date);a.setMinutes(a.getMinutes()-b.time.timezoneOffset);
l||(a.setSeconds(0),a.setMilliseconds(0));return a.toISOString().split(".")[0]},datetimePickerValueToTs:function(a){if(a){var l=3>a.split(":").length?":00.000Z":".000Z",l=Date.parse(a+l)+6E4*b.time.timezoneOffset;console.log(a,l,new Date(l));return l}return 0}}};return b}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(b,a,l,v,n){return{uid:function(){return l.cookie.get("uid")},hasLoggedIn:function(){var b=l.cookie.get("uid"),a=l.cookie.get("skey");return Boolean(b&&a)},nick:function(){var b=localStorage.login_result;return(b=b?JSON.parse(b):{})?b.nick:""},login:function(l,t,r,p){function s(a,f){console.log("[UserService] login result:",
a,f,document.cookie);200==f&&r?(localStorage.login_result=JSON.stringify(a),r(a,f)):p&&p(a,f);b.$emit(n,f,a)}a.put(v+"/users/"+l+"/login","pwd="+encodeURIComponent(t),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(s).error(s)},logout:function(){var b=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+b;document.cookie="skey=; path=/; expires="+b;localStorage.removeItem("login_result")},fetchProfile:function(b){},activity:{isCreatorOfActivity:function(b){return l.cookie.get("uid")==
b.users.creator}}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(b,a,l,v,n){function q(a){a?(b.selectedActivity=a,b.selectedActivityID=a._id):(b.selectedActivity=null,b.selectedActivityID="");console.log("[ActivityService] selected activity",b.selectedActivity)}function t(c,h,d,k){s();h=h||{};h._=(new Date).getTime();h=l.object.toUrlencodedString(h);a.put(n+"/activities/"+
c,h,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,k){if(a&&!a.c&&a.r)a:{var c=a.r;b.activityMap[c._id]=c;for(var h=0;h<b.activityList.length;++h)for(var f=b.activityList[h].activities,e=0;e<f.length;++e)if(f[e]._id==c._id){b.selectedActivity==f[e]&&(b.selectedActivity=c,b.selectedActivityID=c._id);f[e]=c;break a}}u();d&&d(a,k)}).error(function(b,a){u();k&&k(b,a)})}function r(a,h){b.activityList.splice(a,0,{date:p(h),activities:[h]})}function p(b){b=
new Date(b.info.date);b.setHours(0);b.setMinutes(0);b.setSeconds(0);b.setMilliseconds(0);return b.getTime().toString()}function s(){e.setAttribute("disabled","disabled")}function u(){e.removeAttribute("disabled")}function f(){b.hints="\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8"}var e=document.getElementById("activityDetailButtons");b.profiles={};b.activityList=[];b.activityMap={};b.selectedActivity=null;b.selectedActivityID="";b.hints="";return{selectActivity:q,selectActivityByID:function(a){q(b.activityMap[a])},
fetchActivities:function(c,h,d){b.activityList=[];b.activityMap={};b.hints="\u8bf7\u7a0d\u5019...";c=c||{};"manager"==b.mode()&&(c.creator=v.uid());c._=(new Date).getTime();console.log("[ActivityService] fetching activities with",c);a.get(n+"/activities",{responseType:"json",params:c}).success(function(a,d){if(200===d&&!a.c){b.profiles=a.r.profiles;var m=a.r.activities,c=_.groupBy(m,function(b){return p(b)});b.activityList=_.map(c,function(b,a){return{date:a,activities:b}});b.activityMap=_.reduce(m,
function(b,a){b[a._id]=a;return b},{});b.activityList.length?b.hints="":f();console.log("[ActivityService] activities result",b.activityList,b.activityMap)}h&&h(a,d)}).error(function(a,g){b.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";d&&d(a,g)})},getActivity:function(b,h,d){var k=(new Date).getTime();a.get(n+"/activities/"+b+"?_="+k,{responseType:"json"}).success(h).error(d)},createActivity:function(c,h,d){c=c||{};c._=(new Date).getTime();c=l.object.toUrlencodedString(c);a.post(n+"/activities",c,
{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,d){if(a&&!a.c&&a.r){b.hints="";a:{var m=a.r[0];b.activityMap[m._id]=m;for(var c=p(m),f=0;f<b.activityList.length;++f){var e=b.activityList[f];if(e.date==c){e.activities.unshift(m);break a}else if(e.date>c){r(f,m);break a}}r(f,m)}}b.hints="";h&&h(a,d)}).error(d)},updateActivity:t,closeActivity:function(b,a,d){t(b,{status:"closed"},a,d)},deleteActivity:function(c,h,d){s();a({method:"DELETE",url:n+
"/activities/"+c+"?_="+(new Date).getTime()}).success(function(a,d){if(a&&!a.c)a:{q(),delete b.activityMap[c];for(var m=0;m<b.activityList.length;++m)for(var e=0;e<b.activityList[m].activities.length;++e)if(b.activityList[m].activities[e]._id==c){b.activityList[m].activities.splice(e,1);b.activityList[m].activities.length||b.activityList.splice(m,1);break a}}u();b.activityList.length||f();h&&h(a,d)}).error(function(b,a){u();d&&d(b,a)})},fetchActivityConfig:function(b,h){var d=(new Date).getTime();
a.get(n+"/activities/config?_="+d,null,{responseType:"json"}).success(function(a,d){console.log("[ActivityService] activity config =",a);b&&b(a,d)}).error(function(b,a){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");h&&h(b,a)})},statistics:{byUser:function(b,a){var d=_.countBy(_.pluck(b.resources,"user")),d=_.map(d,function(b,a){return{uid:a,count:b}});return _.sortBy(d,function(b){return-b.count})},byTime:function(b,a){var d=_.first(b.resources);if(d){var k=d.date,g={};
a=1E3*(a||300);_.each(b.resources,function(b){var d=Math.floor((b.date-k)/a)*a;g[d]||(g[d]=[]);g[d].push(b)});return{beginning:k,items:g}}return{}}}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user","ts.services.utils"]).controller("PlayerMainController",["$rootScope","$scope","$location","$sce","ActivityService","UserService","UtilsService",function(b,a,l,v,n,q,t){function r(b,a,g,m){b="/activities/"+e+"/videos/"+b;var c=new XMLHttpRequest,f=new FormData;_.each(a,function(b,a){f.append(a,b)});console.log("updating main videos",b,a);c.addEventListener("load",function(b){g&&g(c,b,JSON.parse(c.responseText))});c.addEventListener("error",
function(b){m&&m(c,b)});c.open("PUT",b);c.send(f)}function p(){n.getActivity(e,function(d,k){console.log("[PlayerMainController] get activity success",k,d);if(200==k&&!d.c){b.profiles=d.profiles;b.activity=d.r;s(b.activity.resources);b.updateMainVideos(d.r.videos||[]);if(b.activity.active)b.userCount=b.activity.users.participators.length,a.autoRefresh&&(c=setTimeout(function(){p()},5E3));else{var g=_.countBy(b.activity.resources,function(b){return b.user});b.userCount=_.keys(g).length}a.shouldShowUploadMainButton=
q.activity.isCreatorOfActivity(b.activity)}},function(b,a){console.error("[PlayerMainController] get activity fail",a,b)});console.log("[PlayerMainController] getting info of activity "+e)}function s(a){var k=b.resources[0],g=k?k.resources[0].date:0;a=_.filter(a,function(b){return b.date>g});console.log("new resources",a);for(k=0;k<a.length;++k){var c=a[k],f=new Date(c.date);f.setSeconds(0);f.setMilliseconds(0);f=f.getTime();b.resources[0]&&b.resources[0].ts==f?b.resources[0].resources.splice(0,0,
c):b.resources.splice(0,0,{ts:f,resources:[c]});1!=c.type&&2!=c.type||b.presources.splice(0,0,c);-1==b.uploadedUsers.indexOf(c.user)&&b.uploadedUsers.push(c.user)}console.log("resources",b.resources);console.log("presources",b.presources)}function u(b){for(var a=_.map($(".resourceItem"),function(b){return parseInt(b.getAttribute("data-ts"))}).sort(),g=0;g<a.length;++g)if(a[g]>=b)return a[g-1];return _.last(a)}function f(d,k,g){if(d){var c=parseInt(d.attr("data-gindex")),f=parseInt(d.attr("data-rindex"));
k=d.parents(".resourceGroup").position();var h=d.position();k=k?k.top:0;var h=h?h.top:0,e=$("#timeline");console.log(e.scrollTop(),k,h);e.scrollTop(e.scrollTop()+k+h);g||b.$apply(function(){a.highlightSpecifyResource(null,c,f)});d.width(d.width()+1);setTimeout(function(){d.width("auto")},100)}}var e=l.search().aid,c=0,h=document.getElementById("player");b.username=q.nick();b.userCount=0;b.uploadedUsers=[];b.rawResources=[];b.resources=[];b.presources=[];b.highlightResource={g:-1,r:-1};b.profiles=
{};b.selectedMainVideo=null;b.editingOrder=!1;b.editingTime=!1;b.mainVideos=[];a.selectedUser=null;a.selectedResource=null;a.selectedRIndex=-1;a.autoRefresh=!0;a.shouldShowUploadMainButton=!1;b.updateMainVideos=function(a){b.mainVideos=_.map(a,function(b){b.url||(b.url=v.trustAsResourceUrl(b.src));return b});console.log("[MainVideos]",b.mainVideos)};a.$watch("selectedResource",function(b){b&&2==b.type&&setTimeout(function(){document.getElementById("videoPlayer").src=b.content},100)});b.uid2nick=function(a){return b.profiles[a]?
b.profiles[a].nick:a};b.timelineStartTime=function(){var a=_.last(b.resources);return(a=a?_.last(a.resources):void 0)?a.date:0};b.selectedMainVideoStartTime=function(){var a=b.timelineStartTime();b.selectedMainVideo&&(a+=1E3*b.selectedMainVideo.startTime);return a};b.selectedMainVideoStopTime=function(){return b.selectedMainVideo?b.selectedMainVideoStartTime()+1E3*b.selectedMainVideo.duration:0};a.selectMainVideo=function(a){h.pause();if(b.selectedMainVideo=a)a=new Date(b.selectedMainVideoStartTime()),
b.selectedMainVideoStartDate={y:a.getFullYear(),M:a.getMonth()+1,d:a.getDate(),h:a.getHours(),m:a.getMinutes(),s:a.getSeconds()}};a.editMainVideoName=function(a){var b=prompt("\u8bf7\u8f93\u5165\u201c"+a.name+"\u201d\u7684\u65b0\u540d\u79f0\uff1a");b&&(a.name=b,r(a._id,{name:b},function(a,b,d){console.log(a.status,d)},function(a,b){console.error(a.status,b)}))};a.removeMainVideo=function(a,k){if(confirm("\u786e\u5b9a\u5220\u9664\u4e3b\u89c6\u9891\u201c"+a.name+"\u201d?")){b.mainVideos.splice(k,1);
b.selectedMainVideo=b.mainVideos[0];b.editingOrder=void 0!=b.mainVideos[0];b.editingTime=!1;var c=new XMLHttpRequest;c.open("DELETE","/activities/"+e+"/videos/"+a._id);c.send()}};a.toggleVideoPlayer=function(){h.paused?h.play():h.pause()};a.enterEditOrderMode=function(d){(b.editingOrder=d)?h.pause():a.updateMainVideosOrder()};a.enterEditTimeMode=function(d,c){b.editingTime=d?!0:!1;d?b.selectedMainVideo=d:c&&a.updateMainVideoTiming()};a.updateMainVideosLocalOrder=function(a,c){var g=b.mainVideos.splice(a,
1)[0];b.mainVideos.splice(c?a-1:a+1,0,g)};a.updateMainVideosOrder=function(){r(b.mainVideos[0]._id,{orders:_.map(b.mainVideos,function(a){return a._id}).join(",")},function(a,b,c){console.log(a.status,c)},function(a,b){console.log(a.status,b)})};a.updateMainVideoTiming=function(){var a=b.timelineStartTime(),c=new Date(a),g=new Date;g.setFullYear(b.selectedMainVideoStartDate.y);g.setMonth(b.selectedMainVideoStartDate.M-1);g.setDate(b.selectedMainVideoStartDate.d);g.setHours(b.selectedMainVideoStartDate.h);
g.setMinutes(b.selectedMainVideoStartDate.m);g.setSeconds(b.selectedMainVideoStartDate.s);g.setMilliseconds(c.getMilliseconds());a=(g.getTime()-a)/1E3;0<=a?(b.selectedMainVideoStartDate={y:g.getFullYear(),M:g.getMonth()+1,d:g.getDate(),h:g.getHours(),m:g.getMinutes(),s:g.getSeconds()},b.selectedMainVideo.startTime=a,r(b.selectedMainVideo._id,{startTime:a},function(a,b,d){console.log(a.status,d)},function(a,b){console.error(a.status,b)})):(alert("\u4e3b\u89c6\u9891\u5f00\u59cb\u5f55\u5236\u65f6\u95f4\u5fc5\u987b\u665a\u4e8e\u65f6\u95f4\u8f74\u5f00\u59cb\u65f6\u95f4\uff01"),
g=new Date(b.selectedMainVideoStartTime()),b.selectedMainVideoStartDate={y:g.getFullYear(),M:g.getMonth()+1,d:g.getDate(),h:g.getHours(),m:g.getMinutes(),s:g.getSeconds()})};a.showResourceDetail=function(d,c,g){a.highlightSpecifyResource(d,c,g,!0);d.type&&(a.selectedResource=d,a.selectedRIndex=b.presources.indexOf(d))};a.highlightSpecifyResource=function(a,c,g,e){console.log("highlighting resource",c,g);b.highlightResource={g:c,r:g};a&&(c=$(".resourceItem[data-ts="+a.date+"]"),f(c,!0,!0));e&&b.selectedMainVideo&&
a&&(a=a.date,e=b.selectedMainVideoStartTime(),c=e+b.selectedMainVideo.duration,console.log(a,e,c),a<e?a=e:a>c&&(a=c),h.currentTime=a-e,h.play())};a.hasPreviousPreviewableResource=function(){return 0<a.selectedRIndex};a.hasNextPreviewableResource=function(){return a.selectedRIndex<b.presources.length-1};a.selectPreviousPreviewableResource=function(){0<a.selectedRIndex&&(--a.selectedRIndex,a.selectedResource=b.presources[a.selectedRIndex])};a.selectNextPreviewableResource=function(){a.selectedRIndex<
b.presources.length-1&&(++a.selectedRIndex,a.selectedResource=b.presources[a.selectedRIndex])};a.filterByUser=function(b){a.selectedUser=b;$(".resourceGroup").css("display","none");setTimeout(function(){$(".resourceGroup").css("display","-webkit-box");a.$digest();refreshAllNextItemLineHeight()},0)};a.nextLineHeight=function(a,b){if(b){var c=$('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]').outerHeight();return c?c-3:0}return 0};a.isFirstResourceInGroup=function(a,b){if(0==b)return!0;var c=
document.querySelector('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]');if(c){var f=c.parentElement.querySelectorAll(".resourceItem:not(.ng-hide)")[0];return c==f}return!1};a.resourceShouldBeVisible=function(b){return!a.selectedUser||a.selectedUser==b.user};a.groupContainsResourceOfSelectedUser=function(b){return a.selectedUser?_.some(b.resources,function(b){return b.user==a.selectedUser}):!0};a.hideResourceDetail=function(){a.selectedResource=null;a.selectedRIndex=-1};a.toggleAuthRefresh=
function(){a.autoRefresh=!a.autoRefresh;a.autoRefresh?p():c&&(clearTimeout(c),c=0)};a.showUserStatistics=function(){a.stat=2;var c=n.statistics.byUser(b.activity,10),c=_.map(c,function(a){return[b.uid2nick(a.uid),a.count]});c.splice(0,0,["\u7528\u6237","\u8d44\u6e90\u6570"]);var f=google.visualization.arrayToDataTable(c),e={is3D:!0},h=new google.visualization.PieChart(document.getElementById("statBody"));setTimeout(function(){h.draw(f,e)},200)};a.showTimeStatistics=function(){a.stat=1;var c=n.statistics.byTime(b.activity),
f=c.beginning,c=_.map(c.items,function(a,b){var c=new Date(parseInt(b)+f);return[c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+" "+c.getHours()+":"+c.getMinutes(),a.length]});c.splice(0,0,["\u65f6\u95f4","\u8d44\u6e90\u6570"]);var e=google.visualization.arrayToDataTable(c),h={hAxis:{title:"\u65f6\u95f4",titleTextStyle:{color:"red"}}},l=new google.visualization.ColumnChart(document.getElementById("statBody"));setTimeout(function(){l.draw(e,h)},200)};window.rs=b;window.utils=t;p();(function(){var a=
document.querySelector("video");a.addEventListener("timeupdate",function(c){c=b.selectedMainVideoStartTime()+1E3*a.currentTime;c=u(c);c=$(".resourceItem[data-ts="+c+"]");f(c,!0)})})()}]);document.domain="71xiaoxue.com";
angular.module("ap.controllers.videoUploader",["ts.services.activity","ts.services.user"]).controller("MainVideoUploaderController",["$rootScope","$scope","$location","ActivityService","UserService","UtilsService",function(b,a,l,v,n,q){function t(){a.$apply(function(){s();$("#uploadMainVideoModal").modal("hide")})}function r(){if(a.videoFile&&a.videoDuration&&a.videoName){var b=new FormData,e=new XMLHttpRequest;b.append("skey",q.cookie.get("skey"));b.append("file",a.videoFile);b.append("name",a.videoName);
b.append("media",1);b.append("activityId",l.search().aid);e.upload.addEventListener("progress",function(b){a.$apply(function(){a.videoUploadProgress=Math.floor(100*(b.loaded/b.total))})},!1);e.addEventListener("load",function(b){a.videoIsUploading=!1;console.log(e.status,e.responseText);try{var f=JSON.parse(e.responseText).data.fid;p(f)}catch(d){}a.$digest()},!1);e.addEventListener("error",function(a){console.log("[uploader] upload video error",a);t();alert("\u4e3b\u89c6\u9891\u4e0a\u4f20\u5931\u8d25\uff01")},
!1);a.videoIsUploading=!0;a.videoUploadProgress=0;e.withCredentials=!0;e.open("POST","http://szone.71xiaoxue.com/upload");e.send(b);console.log("[uploader] uploading video ...")}}function p(f){a.videoIsUploading=!1;console.log("\u4e0a\u4f20\u89c6\u9891\u7ed3\u679c\uff1a",f);if(f)if(a.videoName){a.videoURL="http://szone.71xiaoxue.com/api/media/download?fileId="+f;f=l.search().aid;var e=new FormData,c=new XMLHttpRequest;e.append("src",a.videoURL);e.append("name",a.videoName);e.append("duration",a.videoDuration);
c.addEventListener("load",function(f){a.videoIsAdding=!1;if(201==c.status){var d=(f=JSON.parse(c.responseText))?f.c:-1,e=f?f.r:null;console.log("[uploader] add success",f);!d&&e&&($("#uploadMainVideoModal").modal("hide"),b.updateMainVideos(e.videos))}else alert("\u6dfb\u52a0\u4e3b\u89c6\u9891\u5931\u8d25 ("+c.status+")");b.$digest()});c.addEventListener("error",function(b){console.log("[uploader] add video error",b);a.$apply(function(){s()})});a.videoIsAdding=!0;c.open("POST","/activities/"+f+"/videos");
c.send(e);console.log("[uploader] adding video to activity",f)}else alert("\u4e0a\u4f20\u89c6\u9891\u5931\u8d25\uff0c\u8bf7\u8f93\u5165\u6709\u6548\u7684\u89c6\u9891\u540d\u5b57");else alert("\u4e0a\u4f20\u89c6\u9891\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5")}function s(){$("#mainVideoFile").val(null);a.videoFile=null;a.videoName=null;a.videoDuration=0;a.videoIsReading=!1;a.videoIsUploading=!1;a.videoIsAdding=!1;a.videoUploadProgress=0;a.videoURL=null}var u=document.getElementById("mainVideoFile");
a.skey=q.cookie.get("skey");s();a.onSelectedFile=function(){a.$apply(function(){var b=u.files,b=b?b[0]:null;console.log("[uploader] selected file",b);if(b&&"video/mp4"==b.type){a.videoFile=b;var e=document.createElement("video"),b=window.URL.createObjectURL(b);e.addEventListener("loadedmetadata",function(){a.$apply(function(){a.videoIsReading=!1;a.videoDuration=e.duration;console.log("[uploader] video duration = "+e.duration)})});e.src=b;a.videoIsReading=!0;console.log("[uploader] reading video file ...")}else alert("\u5bf9\u4e0d\u8d77\uff0c\u60a8\u6240\u9009\u62e9\u7684\u6587\u4ef6\u683c\u5f0f\u4e0d\u652f\u6301 "),
a.videoFile=null,a.videoDuration=0})};a.startUpload=function(){r()};a.cancelUpload=function(){(!a.videoIsUploading&&!a.videoIsUploading||confirm("\u786e\u5b9a\u8981\u53d6\u6d88\u4e0a\u4f20\u4e3b\u89c6\u9891\uff1f"))&&t()};a.submitLabel=function(){return a.videoIsReading?"\u8bf7\u7a0d\u5019":a.videoIsUploading?"\u4e0a\u4f20\u4e2d ("+(a.videoUploadProgress||0)+"%)":a.videoIsAdding?"\u6dfb\u52a0\u4e2d":"\u6dfb\u52a0"};window.addVideoToActivity=p;window.$scope=a}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main","ap.controllers.videoUploader"])})();
