angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8080":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(b){return _.map(b,function(b,d){return encodeURIComponent(d)+"="+encodeURIComponent(b)}).join("&")}},cookie:{get:function(b){var c=document.cookie.split("; ");return _.reduce(c,function(b,c){var g=c.split("=");b[g[0]]=g[1];return b},{})[b]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(b,c,d,m,g){function n(){return d.cookie.get("uid")}return{uid:n,hasLoggedIn:function(){return void 0!==n()},login:function(k,d,l,a){function e(e,h){console.log("[UserService] login result:",e,h,document.cookie);200==h&&l?l(e,h):a&&a(e,h);b.$emit(g,h,e)}c.put(m+"/users/"+k+"/login","pwd="+encodeURIComponent(d),{responseType:"json",
headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(e).error(e)}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(b,c,d,m,g){function n(a){a?(b.selectedActivity=a,b.selectedActivityID=a._id):(b.selectedActivity=null,b.selectedActivityID="");console.log("[ActivityService] selected activity",b.selectedActivity)}function k(a,e,f,h){e=d.object.toUrlencodedString(e);c.put(g+"/activities/"+a,e,{responseType:"json",
headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,e){if(a&&!a.c&&a.r)a:{var h=a.r;b.activityMap[h._id]=h;for(var q=0;q<b.activityList.length;++q)for(var p=b.activityList[q].activities,c=0;c<p.length;++c)if(p[c]._id==h._id){b.selectedActivity==p[c]&&(b.selectedActivity=h,b.selectedActivityID=h._id);p[c]=h;break a}}f&&f(a,e)}).error(h)}function r(a,e){b.activityList.splice(a,0,{date:l(e),activities:[e]})}function l(a){a=new Date(a.info.date);a.setHours(0);a.setMinutes(0);
a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}b.activityList=[];b.activityMap={};b.selectedActivity=null;b.selectedActivityID="";return{selectActivity:n,selectActivityByID:function(a){n(b.activityMap[a])},fetchActivities:function(a,e,f){a=a||{};"manager"==b.mode()&&(a.creator=m.uid());console.log("[ActivityService] fetching activities with",a);c.get(g+"/activities",{responseType:"json",params:a}).success(function(a,c){if(200===c&&!a.c){var f=a.r.activities,g=_.groupBy(f,function(a){return l(a)});
b.activityList=_.map(g,function(a,b){return{date:b,activities:a}});b.activityMap=_.reduce(f,function(a,b){a[b._id]=b;return a},{})}e&&e(a,c)}).error(f)},getActivity:function(a,b,f){c.get(g+"/activities/"+a,{responseType:"json"}).success(b).error(f)},createActivity:function(a,e,f){a=d.object.toUrlencodedString(a);c.post(g+"/activities",a,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,c){if(a&&!a.c&&a.r)a:{var f=a.r[0];b.activityMap[f._id]=f;for(var g=
l(f),d=0;d<b.activityList.length;++d){var k=b.activityList[d];if(k.date==g){k.activities.unshift(f);break a}else if(k.date>g){r(d,f);break a}}r(d,f)}e&&e(a,c)}).error(f)},updateActivity:k,closeActivity:function(a,b,f){k(a,{status:"closed"},b,f)},fetchActivityConfig:function(a,b){c.get(g+"/activities/config",null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",b);a&&a(b,c)}).error(function(a,c){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");
b&&b(a,c)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(b,c,d,m,g){b.username=g.uid();(function(){var c=d.search().aid;m.getActivity(c,function(c,g){if(200==g&&!c.c){b.activity=c.r;var d=new Date(c.r.info.date);b.activityDate=d.getFullYear()+"\u5e74"+(d.getMonth()+1)+"\u6708"+d.getDate()+"\u65e5";b.activityTime=d.getHours()+":"+d.getMinutes()}},function(b,c){});console.log("[PlayerMainController] getting info of activity "+
c)})()}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();
