angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8080":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(a){return _.map(a,function(a,d){return encodeURIComponent(d)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; ");return _.reduce(b,function(a,b){var e=b.split("=");a[e[0]]=e[1];return a},{})[a]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,d,l,e){return{uid:function(){return d.cookie.get("uid")},hasLoggedIn:function(){var a=d.cookie.get("uid"),b=d.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(h,d,m,k){function c(c,b){console.log("[UserService] login result:",
c,b,document.cookie);200==b&&m?(localStorage.login_result=JSON.stringify(c),m(c,b)):k&&k(c,b);a.$emit(e,b,c)}b.put(l+"/users/"+h+"/login","pwd="+encodeURIComponent(d),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(c).error(c)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,d,l,e){function h(c){c?(a.selectedActivity=c,a.selectedActivityID=c._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function q(c,f,g,n){f=d.object.toUrlencodedString(f);b.put(e+"/activities/"+c,f,{responseType:"json",
headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(c,b){if(c&&!c.c&&c.r)a:{var f=c.r;a.activityMap[f._id]=f;for(var n=0;n<a.activityList.length;++n)for(var p=a.activityList[n].activities,d=0;d<p.length;++d)if(p[d]._id==f._id){a.selectedActivity==p[d]&&(a.selectedActivity=f,a.selectedActivityID=f._id);p[d]=f;break a}}g&&g(c,b)}).error(n)}function m(c,b){a.activityList.splice(c,0,{date:k(b),activities:[b]})}function k(a){a=new Date(a.info.date);a.setHours(0);a.setMinutes(0);
a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:h,selectActivityByID:function(c){h(a.activityMap[c])},fetchActivities:function(c,f,d){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";c=c||{};"manager"==a.mode()&&(c.creator=l.uid());console.log("[ActivityService] fetching activities with",c);b.get(e+"/activities",{responseType:"json",params:c}).success(function(c,
b){if(200===b&&!c.c){var d=c.r.activities,g=_.groupBy(d,function(a){return k(a)});a.activityList=_.map(g,function(a,c){return{date:c,activities:a}});a.activityMap=_.reduce(d,function(a,c){a[c._id]=c;return a},{});a.hints=a.activityList.length?"":"\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8";console.log("[ActivityService] activities result",a.activityList,a.activityMap)}f&&f(c,b)}).error(function(c,b){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";d&&d(c,b)})},getActivity:function(a,f,d){b.get(e+"/activities/"+
a,{responseType:"json"}).success(f).error(d)},createActivity:function(c,f,g){c=d.object.toUrlencodedString(c);b.post(e+"/activities",c,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(c,b){if(c&&!c.c&&c.r)a:{var d=c.r[0];a.activityMap[d._id]=d;for(var g=k(d),e=0;e<a.activityList.length;++e){var h=a.activityList[e];if(h.date==g){h.activities.unshift(d);break a}else if(h.date>g){m(e,d);break a}}m(e,d)}f&&f(c,b)}).error(g)},updateActivity:q,closeActivity:function(a,
b,d){q(a,{status:"closed"},b,d)},fetchActivityConfig:function(a,d){b.get(e+"/activities/config",null,{responseType:"json"}).success(function(b,d){console.log("[ActivityService] activity config =",b);a&&a(b,d)}).error(function(a,c){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");d&&d(a,c)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,b,d,l,e){a.username=e.nick();a.userCount=0;a.resources={};a.presources=[];b.selectedResource=null;b.selectedRIndex=-1;b.showResourceDetail=function(d){d.type&&(b.selectedResource=d,b.selectedRIndex=a.presources.indexOf(d))};b.hasPreviousPreviewableResource=function(){return 0<b.selectedRIndex};b.hasNextPreviewableResource=
function(){return b.selectedRIndex<a.presources.length-1};b.selectPreviousPreviewableResource=function(){0<b.selectedRIndex&&(--b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.selectNextPreviewableResource=function(){b.selectedRIndex<a.presources.length-1&&(++b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.hideResourceDetail=function(){b.selectedResource=null;b.selectedRIndex=-1};(function(){var b=d.search().aid;l.getActivity(b,function(b,d){console.log("[PlayerMainController] get activity success",
d,b);if(200==d&&!b.c){a.activity=b.r;a.activity.resources.reverse();var e=_.map(_.groupBy(a.activity.resources,function(a){a=new Date(a.date);a.setSeconds(0);a.setMilliseconds(0);return a.getTime()}),function(a,b){return{ts:b,resources:a}});a.resources=e;a.presources=_.filter(a.activity.resources,function(a){return 1==a.type||2==a.type});a.activity.active?a.userCount=a.activity.users.participators.length:(e=_.countBy(a.selectedActivity.resources,function(a){return a.user}),a.userCount=_.keys(e).length)}},
function(a,b){console.error("[PlayerMainController] get activity fail",b,a)});console.log("[PlayerMainController] getting info of activity "+b)})()}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();
