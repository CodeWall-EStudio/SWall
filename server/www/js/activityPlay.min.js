angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8080":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(a){return _.map(a,function(a,e){return encodeURIComponent(e)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; ");return _.reduce(b,function(a,b){var d=b.split("=");a[d[0]]=d[1];return a},{})[a]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,e,p,d){return{uid:function(){return e.cookie.get("uid")},hasLoggedIn:function(){var a=e.cookie.get("uid"),b=e.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(l,e,k,f){function c(b,c){console.log("[UserService] login result:",
b,c,document.cookie);200==c&&k?(localStorage.login_result=JSON.stringify(b),k(b,c)):f&&f(b,c);a.$emit(d,c,b)}b.put(p+"/users/"+l+"/login","pwd="+encodeURIComponent(e),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(c).error(c)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")},fetchProfile:function(a){}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,e,p,d){function l(b){b?(a.selectedActivity=b,a.selectedActivityID=b._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function q(m,g,f,n){c();g=e.object.toUrlencodedString(g);b.put(d+"/activities/"+m,g,{responseType:"json",
headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,m){if(b&&!b.c&&b.r)a:{var c=b.r;a.activityMap[c._id]=c;for(var n=0;n<a.activityList.length;++n)for(var g=a.activityList[n].activities,d=0;d<g.length;++d)if(g[d]._id==c._id){a.selectedActivity==g[d]&&(a.selectedActivity=c,a.selectedActivityID=c._id);g[d]=c;break a}}h();f&&f(b,m)}).error(function(a,b){h();n&&n(a,b)})}function k(b,c){a.activityList.splice(b,0,{date:f(c),activities:[c]})}function f(a){a=new Date(a.info.date);
a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}function c(){t.setAttribute("disabled","disabled")}function h(){t.removeAttribute("disabled")}function r(){a.hints="\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8"}var t=document.getElementById("activityDetailButtons");a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:l,selectActivityByID:function(b){l(a.activityMap[b])},fetchActivities:function(c,
g,s){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u540e...";c=c||{};"manager"==a.mode()&&(c.creator=p.uid());c._=(new Date).getTime();console.log("[ActivityService] fetching activities with",c);b.get(d+"/activities",{responseType:"json",params:c}).success(function(b,c){if(200===c&&!b.c){var d=b.r.activities,m=_.groupBy(d,function(a){return f(a)});a.activityList=_.map(m,function(a,b){return{date:b,activities:a}});a.activityMap=_.reduce(d,function(a,b){a[b._id]=b;return a},{});a.activityList.length?
a.hints="":r();console.log("[ActivityService] activities result",a.activityList,a.activityMap)}g&&g(b,c)}).error(function(b,c){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";s&&s(b,c)})},getActivity:function(a,c,f){b.get(d+"/activities/"+a,{responseType:"json"}).success(c).error(f)},createActivity:function(c,g,h){c=e.object.toUrlencodedString(c);b.post(d+"/activities",c,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,c){if(b&&!b.c&&b.r){a.hints=
"";a:{var d=b.r[0];a.activityMap[d._id]=d;for(var m=f(d),h=0;h<a.activityList.length;++h){var e=a.activityList[h];if(e.date==m){e.activities.unshift(d);break a}else if(e.date>m){k(h,d);break a}}k(h,d)}}a.hints="";g&&g(b,c)}).error(h)},updateActivity:q,closeActivity:function(a,b,c){q(a,{status:"closed"},b,c)},deleteActivity:function(f,g,e){c();b({method:"DELETE",url:d+"/activities/"+f}).success(function(b,c){if(b&&!b.c)a:{l(),delete a.activityMap[f];for(var d=0;d<a.activityList.length;++d)for(var e=
0;e<a.activityList[d].activities.length;++e)if(a.activityList[d].activities[e]._id==f){a.activityList[d].activities.splice(e,1);a.activityList[d].activities.length||a.activityList.splice(d,1);break a}}h();a.activityList.length||r();g&&g(b,c)}).error(function(a,b){h();e&&e(a,b)})},fetchActivityConfig:function(a,c){var f=(new Date).getTime();b.get(d+"/activities/config?_="+f,null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",b);a&&a(b,c)}).error(function(a,
b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");c&&c(a,b)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,b,e,p,d){function l(){var d=e.search().aid;p.getActivity(d,function(c,d){console.log("[PlayerMainController] get activity success",d,c);if(200==d&&!c.c)if(a.activity=c.r,q(c.r),a.activity.active)a.userCount=a.activity.users.participators.length,b.autoRefresh&&(k=setTimeout(function(){l()},5E3));else{var e=
_.countBy(a.selectedActivity.resources,function(a){return a.user});a.userCount=_.keys(e).length}},function(a,b){console.error("[PlayerMainController] get activity fail",b,a)});console.log("[PlayerMainController] getting info of activity "+d)}function q(b){b.resources.reverse();a.rawResources=b.resources;a.resources=_.map(_.groupBy(a.rawResources,function(a){a=new Date(a.date);a.setSeconds(0);a.setMilliseconds(0);return a.getTime()}),function(a,b){return{ts:b,resources:a}});a.presources=_.filter(a.rawResources,
function(a){return 1==a.type||2==a.type})}var k=0;a.username=d.nick();a.userCount=0;a.rawResources=[];a.resources=[];a.presources=[];b.selectedResource=null;b.selectedRIndex=-1;b.autoRefresh=!0;b.showResourceDetail=function(d){d.type&&(b.selectedResource=d,b.selectedRIndex=a.presources.indexOf(d))};b.hasPreviousPreviewableResource=function(){return 0<b.selectedRIndex};b.hasNextPreviewableResource=function(){return b.selectedRIndex<a.presources.length-1};b.selectPreviousPreviewableResource=function(){0<
b.selectedRIndex&&(--b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.selectNextPreviewableResource=function(){b.selectedRIndex<a.presources.length-1&&(++b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.hideResourceDetail=function(){b.selectedResource=null;b.selectedRIndex=-1};b.toggleAuthRefresh=function(){b.autoRefresh=!b.autoRefresh;b.autoRefresh?l():k&&(clearTimeout(k),k=0)};l()}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();
