angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8080":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(a){return _.map(a,function(a,e){return encodeURIComponent(e)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; ");return _.reduce(b,function(a,b){var d=b.split("=");a[d[0]]=d[1];return a},{})[a]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,e,p,d){return{uid:function(){return e.cookie.get("uid")},hasLoggedIn:function(){var a=e.cookie.get("uid"),b=e.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(m,e,h,f){function c(b,c){console.log("[UserService] login result:",
b,c,document.cookie);200==c&&h?(localStorage.login_result=JSON.stringify(b),h(b,c)):f&&f(b,c);a.$emit(d,c,b)}b.put(p+"/users/"+m+"/login","pwd="+encodeURIComponent(e),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(c).error(c)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")},fetchProfile:function(a){}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,e,p,d){function m(b){b?(a.selectedActivity=b,a.selectedActivityID=b._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function q(n,g,f,l){c();g=g||{};g._=(new Date).getTime();g=e.object.toUrlencodedString(g);b.put(d+"/activities/"+
n,g,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,n){if(b&&!b.c&&b.r)a:{var l=b.r;a.activityMap[l._id]=l;for(var g=0;g<a.activityList.length;++g)for(var c=a.activityList[g].activities,d=0;d<c.length;++d)if(c[d]._id==l._id){a.selectedActivity==c[d]&&(a.selectedActivity=l,a.selectedActivityID=l._id);c[d]=l;break a}}k();f&&f(b,n)}).error(function(a,b){k();l&&l(a,b)})}function h(b,c){a.activityList.splice(b,0,{date:f(c),activities:[c]})}function f(a){a=
new Date(a.info.date);a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}function c(){t.setAttribute("disabled","disabled")}function k(){t.removeAttribute("disabled")}function r(){a.hints="\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8"}var t=document.getElementById("activityDetailButtons");a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:m,selectActivityByID:function(b){m(a.activityMap[b])},
fetchActivities:function(c,g,s){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";c=c||{};"manager"==a.mode()&&(c.creator=p.uid());c._=(new Date).getTime();console.log("[ActivityService] fetching activities with",c);b.get(d+"/activities",{responseType:"json",params:c}).success(function(b,c){if(200===c&&!b.c){var n=b.r.activities,d=_.groupBy(n,function(a){return f(a)});a.activityList=_.map(d,function(a,b){return{date:b,activities:a}});a.activityMap=_.reduce(n,function(a,b){a[b._id]=
b;return a},{});a.activityList.length?a.hints="":r();console.log("[ActivityService] activities result",a.activityList,a.activityMap)}g&&g(b,c)}).error(function(b,c){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";s&&s(b,c)})},getActivity:function(a,c,f){var l=(new Date).getTime();b.get(d+"/activities/"+a+"?_="+l,{responseType:"json"}).success(c).error(f)},createActivity:function(c,g,k){c=c||{};c._=(new Date).getTime();c=e.object.toUrlencodedString(c);b.post(d+"/activities",c,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,
c){if(b&&!b.c&&b.r){a.hints="";a:{var d=b.r[0];a.activityMap[d._id]=d;for(var n=f(d),k=0;k<a.activityList.length;++k){var e=a.activityList[k];if(e.date==n){e.activities.unshift(d);break a}else if(e.date>n){h(k,d);break a}}h(k,d)}}a.hints="";g&&g(b,c)}).error(k)},updateActivity:q,closeActivity:function(a,b,c){q(a,{status:"closed"},b,c)},deleteActivity:function(f,g,e){c();b({method:"DELETE",url:d+"/activities/"+f+"?_="+(new Date).getTime()}).success(function(b,c){if(b&&!b.c)a:{m(),delete a.activityMap[f];
for(var d=0;d<a.activityList.length;++d)for(var e=0;e<a.activityList[d].activities.length;++e)if(a.activityList[d].activities[e]._id==f){a.activityList[d].activities.splice(e,1);a.activityList[d].activities.length||a.activityList.splice(d,1);break a}}k();a.activityList.length||r();g&&g(b,c)}).error(function(a,b){k();e&&e(a,b)})},fetchActivityConfig:function(a,c){var f=(new Date).getTime();b.get(d+"/activities/config?_="+f,null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",
b);a&&a(b,c)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");c&&c(a,b)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,b,e,p,d){function m(){var d=e.search().aid;p.getActivity(d,function(c,d){console.log("[PlayerMainController] get activity success",d,c);if(200==d&&!c.c)if(a.activity=c.r,q(a.activity.resources),a.activity.active)a.userCount=a.activity.users.participators.length,b.autoRefresh&&(h=setTimeout(function(){m()},
5E3));else{var f=_.countBy(a.selectedActivity.resources,function(a){return a.user});a.userCount=_.keys(f).length}},function(a,b){console.error("[PlayerMainController] get activity fail",b,a)});console.log("[PlayerMainController] getting info of activity "+d)}function q(b){var c=a.resources[0],d=c?c.resources[0].date:0;b=_.filter(b,function(a){return a.date>d});console.log("new resources",b);for(c=0;c<b.length;++c){var e=b[c],h=new Date(e.date);h.setSeconds(0);h.setMilliseconds(0);h=h.getTime();a.resources[0]&&
a.resources[0].ts==h?a.resources[0].resources.splice(0,0,e):a.resources.splice(0,0,{ts:h,resources:[e]});1!=e.type&&2!=e.type||a.presources.splice(0,0,e)}console.log("resources",a.resources);console.log("presources",a.presources)}var h=0;a.username=d.nick();a.userCount=0;a.rawResources=[];a.resources=[];a.presources=[];b.selectedResource=null;b.selectedRIndex=-1;b.autoRefresh=!0;b.$watch("selectedResource",function(a){a&&2==a.type&&setTimeout(function(){document.getElementById("videoPlayer").src=
a.content},100)});b.showResourceDetail=function(d){d.type&&(b.selectedResource=d,b.selectedRIndex=a.presources.indexOf(d))};b.hasPreviousPreviewableResource=function(){return 0<b.selectedRIndex};b.hasNextPreviewableResource=function(){return b.selectedRIndex<a.presources.length-1};b.selectPreviousPreviewableResource=function(){0<b.selectedRIndex&&(--b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.selectNextPreviewableResource=function(){b.selectedRIndex<a.presources.length-
1&&(++b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.hideResourceDetail=function(){b.selectedResource=null;b.selectedRIndex=-1};b.toggleAuthRefresh=function(){b.autoRefresh=!b.autoRefresh;b.autoRefresh?m():h&&(clearTimeout(h),h=0)};window.rs=a;m()}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();
