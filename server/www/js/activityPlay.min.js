angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8090":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(a){return _.map(a,function(a,k){return encodeURIComponent(k)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; ");return _.reduce(b,function(a,b){var l=b.split("=");a[l[0]]=l[1];return a},{})[a]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,k,t,l){return{uid:function(){return k.cookie.get("uid")},hasLoggedIn:function(){var a=k.cookie.get("uid"),b=k.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(p,k,n,m){function e(b,c){console.log("[UserService] login result:",
b,c,document.cookie);200==c&&n?(localStorage.login_result=JSON.stringify(b),n(b,c)):m&&m(b,c);a.$emit(l,c,b)}b.put(t+"/users/"+p+"/login","pwd="+encodeURIComponent(k),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(e).error(e)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")},fetchProfile:function(a){}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,k,t,l){function p(b){b?(a.selectedActivity=b,a.selectedActivityID=b._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function s(c,d,f,r){e();d=d||{};d._=(new Date).getTime();d=k.object.toUrlencodedString(d);b.put(l+"/activities/"+
c,d,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,c){if(b&&!b.c&&b.r)a:{var h=b.r;a.activityMap[h._id]=h;for(var d=0;d<a.activityList.length;++d)for(var q=a.activityList[d].activities,r=0;r<q.length;++r)if(q[r]._id==h._id){a.selectedActivity==q[r]&&(a.selectedActivity=h,a.selectedActivityID=h._id);q[r]=h;break a}}g();f&&f(b,c)}).error(function(a,b){g();r&&r(a,b)})}function n(b,c){a.activityList.splice(b,0,{date:m(c),activities:[c]})}function m(a){a=
new Date(a.info.date);a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}function e(){d.setAttribute("disabled","disabled")}function g(){d.removeAttribute("disabled")}function c(){a.hints="\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8"}var d=document.getElementById("activityDetailButtons");a.profiles={};a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:p,selectActivityByID:function(b){p(a.activityMap[b])},
fetchActivities:function(d,q,f){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";d=d||{};"manager"==a.mode()&&(d.creator=t.uid());d._=(new Date).getTime();console.log("[ActivityService] fetching activities with",d);b.get(l+"/activities",{responseType:"json",params:d}).success(function(b,d){if(200===d&&!b.c){a.profiles=b.r.profiles;var h=b.r.activities,f=_.groupBy(h,function(a){return m(a)});a.activityList=_.map(f,function(a,b){return{date:b,activities:a}});a.activityMap=_.reduce(h,
function(a,b){a[b._id]=b;return a},{});a.activityList.length?a.hints="":c();console.log("[ActivityService] activities result",a.activityList,a.activityMap)}q&&q(b,d)}).error(function(b,c){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";f&&f(b,c)})},getActivity:function(a,c,d){var r=(new Date).getTime();b.get(l+"/activities/"+a+"?_="+r,{responseType:"json"}).success(c).error(d)},createActivity:function(c,d,f){c=c||{};c._=(new Date).getTime();c=k.object.toUrlencodedString(c);b.post(l+"/activities",c,
{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,c){if(b&&!b.c&&b.r){a.hints="";a:{var h=b.r[0];a.activityMap[h._id]=h;for(var f=m(h),e=0;e<a.activityList.length;++e){var g=a.activityList[e];if(g.date==f){g.activities.unshift(h);break a}else if(g.date>f){n(e,h);break a}}n(e,h)}}a.hints="";d&&d(b,c)}).error(f)},updateActivity:s,closeActivity:function(a,b,c){s(a,{status:"closed"},b,c)},deleteActivity:function(d,q,f){e();b({method:"DELETE",url:l+
"/activities/"+d+"?_="+(new Date).getTime()}).success(function(b,e){if(b&&!b.c)a:{p(),delete a.activityMap[d];for(var f=0;f<a.activityList.length;++f)for(var k=0;k<a.activityList[f].activities.length;++k)if(a.activityList[f].activities[k]._id==d){a.activityList[f].activities.splice(k,1);a.activityList[f].activities.length||a.activityList.splice(f,1);break a}}g();a.activityList.length||c();q&&q(b,e)}).error(function(a,b){g();f&&f(a,b)})},fetchActivityConfig:function(a,c){var d=(new Date).getTime();
b.get(l+"/activities/config?_="+d,null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",b);a&&a(b,c)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");c&&c(a,b)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,b,k,t,l){function p(a,b,h,e){a="/activities/"+m+"/videos/"+a;var f=new XMLHttpRequest,g=new FormData;_.each(b,function(a,b){g.append(b,a)});console.log("updating main videos",a,b);f.addEventListener("load",function(a){h&&h(f,a,JSON.parse(f.responseText))});f.addEventListener("error",function(a){e&&e(f,a)});
f.open("PUT",a);f.send(g)}function s(){t.getActivity(m,function(c,d){console.log("[PlayerMainController] get activity success",d,c);if(200==d&&!c.c)if(a.profiles=c.profiles,a.activity=c.r,n(a.activity.resources),a.mainVideos.length||(a.mainVideos=c.r.videos||[]),a.activity.active)a.userCount=a.activity.users.participators.length,b.autoRefresh&&(e=setTimeout(function(){s()},5E3));else{var h=_.countBy(a.activity.resources,function(a){return a.user});a.userCount=_.keys(h).length}},function(a,b){console.error("[PlayerMainController] get activity fail",
b,a)});console.log("[PlayerMainController] getting info of activity "+m)}function n(b){var d=a.resources[0],h=d?d.resources[0].date:0;b=_.filter(b,function(a){return a.date>h});console.log("new resources",b);for(d=0;d<b.length;++d){var e=b[d],f=new Date(e.date);f.setSeconds(0);f.setMilliseconds(0);f=f.getTime();a.resources[0]&&a.resources[0].ts==f?a.resources[0].resources.splice(0,0,e):a.resources.splice(0,0,{ts:f,resources:[e]});1!=e.type&&2!=e.type||a.presources.splice(0,0,e);-1==a.uploadedUsers.indexOf(e.user)&&
a.uploadedUsers.push(e.user)}console.log("resources",a.resources);console.log("presources",a.presources)}var m=k.search().aid,e=0,g=document.getElementById("player");a.username=l.nick();a.userCount=0;a.uploadedUsers=[];a.rawResources=[];a.resources=[];a.presources=[];a.profiles={};a.selectedMainVideo=null;a.selectedMainVideoStartDate=new Date;a.editingOrder=!1;a.editingTime=!1;a.mainVideos=[];b.selectedUser=null;b.selectedResource=null;b.selectedRIndex=-1;b.autoRefresh=!0;b.$watch("selectedResource",
function(a){a&&2==a.type&&setTimeout(function(){document.getElementById("videoPlayer").src=a.content},100)});a.uid2nick=function(b){return a.profiles[b]?a.profiles[b].nick:b};a.timelineStartTime=function(){return a.resources[0]&&a.selectedMainVideo?a.resources[0].resources[0].date:0};a.selectedMainVideoStartTime=function(){var b=a.timelineStartTime();a.selectedMainVideo&&(b+=1E3*a.selectedMainVideo.startTime);return b};a.selectedMainVideoStopTime=function(){return a.selectedMainVideo?a.selectedMainVideoStartTime()+
1E3*a.selectedMainVideo.duration:0};b.uploadMainVideo=function(){};b.selectMainVideo=function(b){a.selectedMainVideo=b;g.pause()};b.enterEditOrderMode=function(c){(a.editingOrder=c)?g.pause():b.updateMainVideosOrder()};b.enterEditTimeMode=function(c,d){a.editingTime=c?!0:!1;c?a.selectedMainVideo=c:d&&b.updateMainVideoTiming()};b.updateMainVideosLocalOrder=function(b,d){var e=a.mainVideos.splice(b,1)[0];a.mainVideos.splice(d?b-1:b+1,0,e)};b.updateMainVideosOrder=function(){p(a.mainVideos[0]._id,{orders:_.map(a.mainVideos,
function(a){return a._id}).join(",")},function(a,b,e){console.log(a.status,e)},function(a,b){console.log(a.status,b)})};b.updateMainVideoTiming=function(){p(a.selectedMainVideo._id,{startTime:a.selectedMainVideo.startTime},function(a,b,e){console.log(a.status,e)},function(a,b){console.log(a.status,b)})};b.showResourceDetail=function(c){c.type&&(b.selectedResource=c,b.selectedRIndex=a.presources.indexOf(c))};b.hasPreviousPreviewableResource=function(){return 0<b.selectedRIndex};b.hasNextPreviewableResource=
function(){return b.selectedRIndex<a.presources.length-1};b.selectPreviousPreviewableResource=function(){0<b.selectedRIndex&&(--b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.selectNextPreviewableResource=function(){b.selectedRIndex<a.presources.length-1&&(++b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.filterByUser=function(a){b.selectedUser=a;$(".resourceGroup").css("display","none");setTimeout(function(){$(".resourceGroup").css("display","-webkit-box");
b.$digest();refreshAllNextItemLineHeight()},0)};b.nextLineHeight=function(a,b){if(b){var e=$('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]').outerHeight();return e?e-3:0}return 0};b.isFirstResourceInGroup=function(a,b){if(0==b)return!0;var e=document.querySelector('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]');if(e){var g=e.parentElement.querySelectorAll(".resourceItem:not(.ng-hide)")[0];return e==g}return!1};b.resourceShouldBeVisible=function(a){return!b.selectedUser||b.selectedUser==
a.user};b.groupContainsResourceOfSelectedUser=function(a){return b.selectedUser?_.some(a.resources,function(a){return a.user==b.selectedUser}):!0};b.hideResourceDetail=function(){b.selectedResource=null;b.selectedRIndex=-1};b.toggleAuthRefresh=function(){b.autoRefresh=!b.autoRefresh;b.autoRefresh?s():e&&(clearTimeout(e),e=0)};window.rs=a;s()}]);angular.module("ap.controllers.videoUploader",["ts.services.activity","ts.services.user"]).controller("MainVideoUploaderController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,b,k,t,l){function p(){if(b.videoFile&&b.videoDuration&&b.videoName){var a=new FormData,g=new XMLHttpRequest;a.append("file",b.videoFile);g.upload.addEventListener("progress",function(a){b.$apply(function(){b.videoUploadProgress=Math.floor(100*(a.loaded/a.total))})},!1);g.addEventListener("load",
function(a){b.videoIsUploading=!1;if(200==g.status){var d=(a=JSON.parse(g.responseText))&&a[0]?"/resources/"+a[0].filename:null;console.log("[uploader] upload video success",a,d);b.videoURL=d;s()}b.$digest()},!1);g.addEventListener("error",function(a){console.log("[uploader] upload video error",a);b.$apply(function(){n()})},!1);b.videoIsUploading=!0;b.videoUploadProgress=0;g.open("POST","/resources");g.send(a);console.log("[uploader] uploading video ...")}}function s(){var e=k.search().aid,g=new FormData,
c=new XMLHttpRequest;g.append("src",b.videoURL);g.append("name",b.videoName);g.append("duration",b.videoDuration);c.addEventListener("load",function(d){b.videoIsAdding=!1;if(201==c.status){var e=(d=JSON.parse(c.responseText))?d.c:-1,g=d?d.r:null;console.log("[uploader] add success",d);!e&&g&&($("#uploadMainVideoModal").modal("hide"),a.mainVideos=g.videos)}a.$digest()});c.addEventListener("error",function(a){console.log("[uploader] add video error",a);b.$apply(function(){n()})});b.videoIsAdding=!0;
c.open("POST","/activities/"+e+"/videos");c.send(g);console.log("[uploader] adding video to activity",e)}function n(){b.videoFile=null;b.videoName=null;b.videoDuration=0;b.videoIsUploading=!1;b.videoIsAdding=!1;b.videoUploadProgress=0;b.videoURL=null}var m=document.getElementById("mainVideoFile");n();b.onSelectedFile=function(){var a=m.files,a=a?a[0]:null;console.log("[uploader] selected file",a);if(a){b.videoFile=a;var g=document.createElement("video"),a=window.URL.createObjectURL(a);g.addEventListener("loadedmetadata",
function(){b.videoDuration=g.duration;console.log("[uploader] video duration = "+g.duration)});g.src=a;console.log("[uploader] reading video file ...")}};b.startUpload=function(){p()}}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main","ap.controllers.videoUploader"])})();
