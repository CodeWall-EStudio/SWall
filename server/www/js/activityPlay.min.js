(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();angular.module("ts.services.user",["ts.utils.constants"]).service("UserService",["$rootScope","$location","$http","EVENT_LOGIN",function(b,c,l,m){function f(){return c.search().uid}return{uid:f,hasLoggedIn:function(){return void 0!==f()},login:function(f,p,n){l.post("");c.search("uid",f);n(0);b.$emit(m,0)}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.user"]).service("ActivityService",["$rootScope","$http","UserService","BACKEND_SERVER",function(b,c,l,m){function f(a){a?(b.selectedActivity=a,b.selectedActivityID=a._id):(b.selectedActivity=null,b.selectedActivityID="");console.log("[ActivityService] selected activity",b.selectedActivity)}function q(a,e,d,h){e=r(e);c.put(m+"/activities/"+a+"?uid="+l.uid(),e,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,
e){if(a&&!a.c&&a.r)a:{var h=a.r;b.activityMap[h._id]=h;for(var g=0;g<b.activityList.length;++g)for(var k=b.activityList[g].activities,c=0;c<k.length;++c)if(k[c]._id==h._id){b.selectedActivity==k[c]&&(b.selectedActivity=h,b.selectedActivityID=h._id);k[c]=h;break a}}d&&d(a,e)}).error(h)}function p(a,e){b.activityList.splice(a,0,{date:n(e),activities:[e]})}function n(a){a=new Date(a.info.date);a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}function r(a){return _.map(a,
function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")}b.activityList=[];b.activityMap={};b.selectedActivity=null;b.selectedActivityID="";return{selectActivity:f,selectActivityByID:function(a){f(b.activityMap[a])},fetchActivities:function(a,e,d){a=a||{};"manager"==b.mode()&&(a.creator=l.uid());console.log("[ActivityService] fetching activities with",a);c.get(m+"/activities?uid="+l.uid(),{responseType:"json",params:a}).success(function(a,c){if(200===c&&!a.c){var d=a.r.activities,
f=_.groupBy(d,function(a){return n(a)});b.activityList=_.map(f,function(a,b){return{date:b,activities:a}});b.activityMap=_.reduce(d,function(a,b){a[b._id]=b;return a},{})}e&&e(a,c)}).error(d)},createActivity:function(a,e,d){a=r(a);c.post(m+"/activities?uid="+l.uid(),a,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,c){if(a&&!a.c&&a.r)a:{var d=a.r[0];b.activityMap[d._id]=d;for(var f=n(d),g=0;g<b.activityList.length;++g){var k=b.activityList[g];
if(k.date==f){k.activities.unshift(d);break a}else if(k.date>f){p(g,d);break a}}p(g,d)}e&&e(a,c)}).error(d)},updateActivity:q,closeActivity:function(a,b,d){q(a,{status:"closed"},b,d)},fetchActivityConfig:function(a,b){c.get(m+"/activities/config",null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",b);a&&a(b,c)}).error(function(a,c){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");b&&b(a,c)})}}}]);angular.module("ap.controllers.main",[]).controller("PlayerMainController",["$rootScope","$scope",function(b,c){}]);
