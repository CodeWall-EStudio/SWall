angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8090":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(a){return _.map(a,function(a,f){return encodeURIComponent(f)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; ");return _.reduce(b,function(a,b){var e=b.split("=");a[e[0]]=e[1];return a},{})[a]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,f,p,e){return{uid:function(){return f.cookie.get("uid")},hasLoggedIn:function(){var a=f.cookie.get("uid"),b=f.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(m,f,h,d){function c(b,c){console.log("[UserService] login result:",
b,c,document.cookie);200==c&&h?(localStorage.login_result=JSON.stringify(b),h(b,c)):d&&d(b,c);a.$emit(e,c,b)}b.put(p+"/users/"+m+"/login","pwd="+encodeURIComponent(f),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(c).error(c)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")},fetchProfile:function(a){}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,f,p,e){function m(b){b?(a.selectedActivity=b,a.selectedActivityID=b._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function q(l,d,g,n){c();d=d||{};d._=(new Date).getTime();d=f.object.toUrlencodedString(d);b.put(e+"/activities/"+
l,d,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,l){if(b&&!b.c&&b.r)a:{var d=b.r;a.activityMap[d._id]=d;for(var n=0;n<a.activityList.length;++n)for(var c=a.activityList[n].activities,k=0;k<c.length;++k)if(c[k]._id==d._id){a.selectedActivity==c[k]&&(a.selectedActivity=d,a.selectedActivityID=d._id);c[k]=d;break a}}r();g&&g(b,l)}).error(function(a,b){r();n&&n(a,b)})}function h(b,c){a.activityList.splice(b,0,{date:d(c),activities:[c]})}function d(a){a=
new Date(a.info.date);a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}function c(){t.setAttribute("disabled","disabled")}function r(){t.removeAttribute("disabled")}function s(){a.hints="\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8"}var t=document.getElementById("activityDetailButtons");a.profiles={};a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:m,selectActivityByID:function(b){m(a.activityMap[b])},
fetchActivities:function(c,k,g){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";c=c||{};"manager"==a.mode()&&(c.creator=p.uid());c._=(new Date).getTime();console.log("[ActivityService] fetching activities with",c);b.get(e+"/activities",{responseType:"json",params:c}).success(function(b,c){if(200===c&&!b.c){a.profiles=b.r.profiles;var l=b.r.activities,g=_.groupBy(l,function(a){return d(a)});a.activityList=_.map(g,function(a,b){return{date:b,activities:a}});a.activityMap=_.reduce(l,
function(a,b){a[b._id]=b;return a},{});a.activityList.length?a.hints="":s();console.log("[ActivityService] activities result",a.activityList,a.activityMap)}k&&k(b,c)}).error(function(b,c){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";g&&g(b,c)})},getActivity:function(a,c,d){var n=(new Date).getTime();b.get(e+"/activities/"+a+"?_="+n,{responseType:"json"}).success(c).error(d)},createActivity:function(c,k,g){c=c||{};c._=(new Date).getTime();c=f.object.toUrlencodedString(c);b.post(e+"/activities",c,
{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b,c){if(b&&!b.c&&b.r){a.hints="";a:{var l=b.r[0];a.activityMap[l._id]=l;for(var g=d(l),e=0;e<a.activityList.length;++e){var f=a.activityList[e];if(f.date==g){f.activities.unshift(l);break a}else if(f.date>g){h(e,l);break a}}h(e,l)}}a.hints="";k&&k(b,c)}).error(g)},updateActivity:q,closeActivity:function(a,b,c){q(a,{status:"closed"},b,c)},deleteActivity:function(d,k,g){c();b({method:"DELETE",url:e+
"/activities/"+d+"?_="+(new Date).getTime()}).success(function(b,c){if(b&&!b.c)a:{m(),delete a.activityMap[d];for(var e=0;e<a.activityList.length;++e)for(var g=0;g<a.activityList[e].activities.length;++g)if(a.activityList[e].activities[g]._id==d){a.activityList[e].activities.splice(g,1);a.activityList[e].activities.length||a.activityList.splice(e,1);break a}}r();a.activityList.length||s();k&&k(b,c)}).error(function(a,b){r();g&&g(a,b)})},fetchActivityConfig:function(a,c){var d=(new Date).getTime();
b.get(e+"/activities/config?_="+d,null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",b);a&&a(b,c)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");c&&c(a,b)})}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,b,f,p,e){function m(){var d=f.search().aid;p.getActivity(d,function(c,d){console.log("[PlayerMainController] get activity success",d,c);if(200==d&&!c.c)if(a.profiles=c.profiles,a.activity=c.r,q(a.activity.resources),a.activity.active)a.userCount=a.activity.users.participators.length,b.autoRefresh&&(h=setTimeout(function(){m()},
5E3));else{var e=_.countBy(a.activity.resources,function(a){return a.user});a.userCount=_.keys(e).length}},function(a,b){console.error("[PlayerMainController] get activity fail",b,a)});console.log("[PlayerMainController] getting info of activity "+d)}function q(b){var c=a.resources[0],e=c?c.resources[0].date:0;b=_.filter(b,function(a){return a.date>e});console.log("new resources",b);for(c=0;c<b.length;++c){var f=b[c],h=new Date(f.date);h.setSeconds(0);h.setMilliseconds(0);h=h.getTime();a.resources[0]&&
a.resources[0].ts==h?a.resources[0].resources.splice(0,0,f):a.resources.splice(0,0,{ts:h,resources:[f]});1!=f.type&&2!=f.type||a.presources.splice(0,0,f)}console.log("resources",a.resources);console.log("presources",a.presources)}var h=0;a.username=e.nick();a.userCount=0;a.rawResources=[];a.resources=[];a.presources=[];a.profiles={};b.selectedResource=null;b.selectedRIndex=-1;b.autoRefresh=!0;b.$watch("selectedResource",function(a){a&&2==a.type&&setTimeout(function(){document.getElementById("videoPlayer").src=
a.content},100)});a.uid2nick=function(b){return a.profiles[b]?a.profiles[b].nick:b};b.showResourceDetail=function(d){d.type&&(b.selectedResource=d,b.selectedRIndex=a.presources.indexOf(d))};b.hasPreviousPreviewableResource=function(){return 0<b.selectedRIndex};b.hasNextPreviewableResource=function(){return b.selectedRIndex<a.presources.length-1};b.selectPreviousPreviewableResource=function(){0<b.selectedRIndex&&(--b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.selectNextPreviewableResource=
function(){b.selectedRIndex<a.presources.length-1&&(++b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.hideResourceDetail=function(){b.selectedResource=null;b.selectedRIndex=-1};b.toggleAuthRefresh=function(){b.autoRefresh=!b.autoRefresh;b.autoRefresh?m():h&&(clearTimeout(h),h=0)};window.rs=a;m()}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main"])})();
