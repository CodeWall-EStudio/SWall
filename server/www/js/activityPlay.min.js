angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8090":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){var a={object:{toUrlencodedString:function(a){return _.map(a,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var g=document.cookie.split("; ");return _.reduce(g,function(a,b){var p=b.split("=");a[p[0]]=p[1];return a},{})[a]}},time:{timezoneOffset:(new Date).getTimezoneOffset(),dateToDatetimePickerValue:function(b,g){b||(b=new Date);b.setMinutes(b.getMinutes()-a.time.timezoneOffset);
g||(b.setSeconds(0),b.setMilliseconds(0));return b.toISOString().split(".")[0]},datetimePickerValueToTs:function(b){if(b){var g=3>b.split(":").length?":00.000Z":".000Z",g=Date.parse(b+g)+6E4*a.time.timezoneOffset;console.log(b,g,new Date(g));return g}return 0}}};return a}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(a,b,g,s,n){return{uid:function(){return g.cookie.get("uid")},hasLoggedIn:function(){var a=g.cookie.get("uid"),b=g.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(g,r,m,q){function e(b,f){console.log("[UserService] login result:",
b,f,document.cookie);200==f&&m?(localStorage.login_result=JSON.stringify(b),m(b,f)):q&&q(b,f);a.$emit(n,f,b)}b.put(s+"/users/"+g+"/login","pwd="+encodeURIComponent(r),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(e).error(e)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")},fetchProfile:function(a){}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(a,b,g,s,n){function p(c){c?(a.selectedActivity=c,a.selectedActivityID=c._id):(a.selectedActivity=null,a.selectedActivityID="");console.log("[ActivityService] selected activity",a.selectedActivity)}function r(c,h,d,t){e();h=h||{};h._=(new Date).getTime();h=g.object.toUrlencodedString(h);b.put(n+"/activities/"+
c,h,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(c,b){if(c&&!c.c&&c.r)a:{var h=c.r;a.activityMap[h._id]=h;for(var t=0;t<a.activityList.length;++t)for(var f=a.activityList[t].activities,e=0;e<f.length;++e)if(f[e]._id==h._id){a.selectedActivity==f[e]&&(a.selectedActivity=h,a.selectedActivityID=h._id);f[e]=h;break a}}k();d&&d(c,b)}).error(function(a,c){k();t&&t(a,c)})}function m(c,b){a.activityList.splice(c,0,{date:q(b),activities:[b]})}function q(a){a=
new Date(a.info.date);a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}function e(){l.setAttribute("disabled","disabled")}function k(){l.removeAttribute("disabled")}function f(){a.hints="\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8"}var l=document.getElementById("activityDetailButtons");a.profiles={};a.activityList=[];a.activityMap={};a.selectedActivity=null;a.selectedActivityID="";a.hints="";return{selectActivity:p,selectActivityByID:function(c){p(a.activityMap[c])},
fetchActivities:function(c,h,d){a.activityList=[];a.activityMap={};a.hints="\u8bf7\u7a0d\u5019...";c=c||{};"manager"==a.mode()&&(c.creator=s.uid());c._=(new Date).getTime();console.log("[ActivityService] fetching activities with",c);b.get(n+"/activities",{responseType:"json",params:c}).success(function(c,b){if(200===b&&!c.c){a.profiles=c.r.profiles;var d=c.r.activities,e=_.groupBy(d,function(a){return q(a)});a.activityList=_.map(e,function(a,c){return{date:c,activities:a}});a.activityMap=_.reduce(d,
function(a,c){a[c._id]=c;return a},{});a.activityList.length?a.hints="":f();console.log("[ActivityService] activities result",a.activityList,a.activityMap)}h&&h(c,b)}).error(function(c,b){a.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";d&&d(c,b)})},getActivity:function(a,h,d){var t=(new Date).getTime();b.get(n+"/activities/"+a+"?_="+t,{responseType:"json"}).success(h).error(d)},createActivity:function(c,h,d){c=c||{};c._=(new Date).getTime();c=g.object.toUrlencodedString(c);b.post(n+"/activities",c,
{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(c,b){if(c&&!c.c&&c.r){a.hints="";a:{var d=c.r[0];a.activityMap[d._id]=d;for(var f=q(d),e=0;e<a.activityList.length;++e){var k=a.activityList[e];if(k.date==f){k.activities.unshift(d);break a}else if(k.date>f){m(e,d);break a}}m(e,d)}}a.hints="";h&&h(c,b)}).error(d)},updateActivity:r,closeActivity:function(a,b,d){r(a,{status:"closed"},b,d)},deleteActivity:function(c,h,d){e();b({method:"DELETE",url:n+
"/activities/"+c+"?_="+(new Date).getTime()}).success(function(b,d){if(b&&!b.c)a:{p(),delete a.activityMap[c];for(var e=0;e<a.activityList.length;++e)for(var g=0;g<a.activityList[e].activities.length;++g)if(a.activityList[e].activities[g]._id==c){a.activityList[e].activities.splice(g,1);a.activityList[e].activities.length||a.activityList.splice(e,1);break a}}k();a.activityList.length||f();h&&h(b,d)}).error(function(a,c){k();d&&d(a,c)})},fetchActivityConfig:function(a,h){var d=(new Date).getTime();
b.get(n+"/activities/config?_="+d,null,{responseType:"json"}).success(function(b,h){console.log("[ActivityService] activity config =",b);a&&a(b,h)}).error(function(a,c){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");h&&h(a,c)})},statistics:{byUser:function(a,b){var d=_.countBy(_.pluck(a.resources,"user")),d=_.map(d,function(a,c){return{uid:c,count:a}});return _.sortBy(d,function(a){return-a.count})},byTime:function(a,b){var d=_.first(a.resources);if(d){var e=d.date,f={};
b=1E3*(b||300);_.each(a.resources,function(a){var c=Math.floor((a.date-e)/b)*b;f[c]||(f[c]=[]);f[c].push(a)});return{beginning:e,items:f}}return{}}}}}]);angular.module("ap.controllers.main",["ts.services.activity","ts.services.user","ts.services.utils"]).controller("PlayerMainController",["$rootScope","$scope","$location","ActivityService","UserService","UtilsService",function(a,b,g,s,n,p){function r(a,b,d,e){a="/activities/"+k+"/videos/"+a;var f=new XMLHttpRequest,g=new FormData;_.each(b,function(a,c){g.append(c,a)});console.log("updating main videos",a,b);f.addEventListener("load",function(a){d&&d(f,a,JSON.parse(f.responseText))});f.addEventListener("error",
function(a){e&&e(f,a)});f.open("PUT",a);f.send(g)}function m(){s.getActivity(k,function(c,h){console.log("[PlayerMainController] get activity success",h,c);if(200==h&&!c.c)if(a.profiles=c.profiles,a.activity=c.r,q(a.activity.resources),a.mainVideos.length||(a.mainVideos=c.r.videos||[]),a.activity.active)a.userCount=a.activity.users.participators.length,b.autoRefresh&&(f=setTimeout(function(){m()},5E3));else{var d=_.countBy(a.activity.resources,function(a){return a.user});a.userCount=_.keys(d).length}},
function(a,b){console.error("[PlayerMainController] get activity fail",b,a)});console.log("[PlayerMainController] getting info of activity "+k)}function q(c){var b=a.resources[0],d=b?b.resources[0].date:0;c=_.filter(c,function(a){return a.date>d});console.log("new resources",c);for(b=0;b<c.length;++b){var e=c[b],f=new Date(e.date);f.setSeconds(0);f.setMilliseconds(0);f=f.getTime();a.resources[0]&&a.resources[0].ts==f?a.resources[0].resources.splice(0,0,e):a.resources.splice(0,0,{ts:f,resources:[e]});
1!=e.type&&2!=e.type||a.presources.splice(0,0,e);-1==a.uploadedUsers.indexOf(e.user)&&a.uploadedUsers.push(e.user)}console.log("resources",a.resources);console.log("presources",a.presources)}function e(a){for(var b=_.map($(".resourceItem"),function(a){return parseInt(a.getAttribute("data-ts"))}).sort(),d=0;d<b.length;++d)if(b[d]>=a)return b[d-1];return _.last(b)}var k=g.search().aid,f=0,l=document.getElementById("player");a.username=n.nick();a.userCount=0;a.uploadedUsers=[];a.rawResources=[];a.resources=
[];a.presources=[];a.highlightResource={};a.profiles={};a.selectedMainVideo=null;a.editingOrder=!1;a.editingTime=!1;a.mainVideos=[];b.selectedUser=null;b.selectedResource=null;b.selectedRIndex=-1;b.autoRefresh=!0;b.$watch("selectedResource",function(a){a&&2==a.type&&setTimeout(function(){document.getElementById("videoPlayer").src=a.content},100)});a.uid2nick=function(b){return a.profiles[b]?a.profiles[b].nick:b};a.timelineStartTime=function(){var b=_.last(a.resources);return(b=b?_.last(b.resources):
void 0)&&a.selectedMainVideo?b.date:0};a.selectedMainVideoStartTime=function(){var b=a.timelineStartTime();a.selectedMainVideo&&(b+=1E3*a.selectedMainVideo.startTime);return b};a.selectedMainVideoStopTime=function(){return a.selectedMainVideo?a.selectedMainVideoStartTime()+1E3*a.selectedMainVideo.duration:0};b.selectMainVideo=function(b){l.pause();a.selectedMainVideo=b;b=new Date(a.selectedMainVideoStartTime());a.selectedMainVideoStartDate={y:b.getFullYear(),M:b.getMonth()+1,d:b.getDate(),h:b.getHours(),
m:b.getMinutes(),s:b.getSeconds()}};b.toggleVideoPlayer=function(){l.paused?l.play():l.pause()};b.enterEditOrderMode=function(c){(a.editingOrder=c)?l.pause():b.updateMainVideosOrder()};b.enterEditTimeMode=function(c,h){a.editingTime=c?!0:!1;c?a.selectedMainVideo=c:h&&b.updateMainVideoTiming()};b.updateMainVideosLocalOrder=function(b,h){var d=a.mainVideos.splice(b,1)[0];a.mainVideos.splice(h?b-1:b+1,0,d)};b.updateMainVideosOrder=function(){r(a.mainVideos[0]._id,{orders:_.map(a.mainVideos,function(a){return a._id}).join(",")},
function(a,b,d){console.log(a.status,d)},function(a,b){console.log(a.status,b)})};b.updateMainVideoTiming=function(){var b=a.timelineStartTime(),h=new Date(b),d=new Date;d.setFullYear(a.selectedMainVideoStartDate.y);d.setMonth(a.selectedMainVideoStartDate.M-1);d.setDate(a.selectedMainVideoStartDate.d);d.setHours(a.selectedMainVideoStartDate.h);d.setMinutes(a.selectedMainVideoStartDate.m);d.setSeconds(a.selectedMainVideoStartDate.s);d.setMilliseconds(h.getMilliseconds());b=(d.getTime()-b)/1E3;0<=b?
(a.selectedMainVideoStartDate={y:d.getFullYear(),M:d.getMonth()+1,d:d.getDate(),h:d.getHours(),m:d.getMinutes(),s:d.getSeconds()},a.selectedMainVideo.startTime=b,r(a.selectedMainVideo._id,{startTime:b},function(a,b,c){console.log(a.status,c)},function(a,b){console.log(a.status,b)})):(alert("\u4e3b\u89c6\u9891\u5f00\u59cb\u5f55\u5236\u65f6\u95f4\u5fc5\u987b\u665a\u4e8e\u65f6\u95f4\u8f74\u5f00\u59cb\u65f6\u95f4\uff01"),d=new Date(a.selectedMainVideoStartTime()),a.selectedMainVideoStartDate={y:d.getFullYear(),
M:d.getMonth()+1,d:d.getDate(),h:d.getHours(),m:d.getMinutes(),s:d.getSeconds()})};b.showResourceDetail=function(c){c.type&&(b.selectedResource=c,b.selectedRIndex=a.presources.indexOf(c))};b.hasPreviousPreviewableResource=function(){return 0<b.selectedRIndex};b.hasNextPreviewableResource=function(){return b.selectedRIndex<a.presources.length-1};b.selectPreviousPreviewableResource=function(){0<b.selectedRIndex&&(--b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.selectNextPreviewableResource=
function(){b.selectedRIndex<a.presources.length-1&&(++b.selectedRIndex,b.selectedResource=a.presources[b.selectedRIndex])};b.filterByUser=function(a){b.selectedUser=a;$(".resourceGroup").css("display","none");setTimeout(function(){$(".resourceGroup").css("display","-webkit-box");b.$digest();refreshAllNextItemLineHeight()},0)};b.nextLineHeight=function(a,b){if(b){var d=$('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]').outerHeight();return d?d-3:0}return 0};b.isFirstResourceInGroup=function(a,
b){if(0==b)return!0;var d=document.querySelector('.resourceItem[data-gindex="'+a+'"][data-rindex="'+b+'"]');if(d){var e=d.parentElement.querySelectorAll(".resourceItem:not(.ng-hide)")[0];return d==e}return!1};b.resourceShouldBeVisible=function(a){return!b.selectedUser||b.selectedUser==a.user};b.groupContainsResourceOfSelectedUser=function(a){return b.selectedUser?_.some(a.resources,function(a){return a.user==b.selectedUser}):!0};b.hideResourceDetail=function(){b.selectedResource=null;b.selectedRIndex=
-1};b.toggleAuthRefresh=function(){b.autoRefresh=!b.autoRefresh;b.autoRefresh?m():f&&(clearTimeout(f),f=0)};b.showUserStatistics=function(){b.stat=2;var c=s.statistics.byUser(a.activity,10),c=_.map(c,function(b){return[a.uid2nick(b.uid),b.count]});c.splice(0,0,["\u7528\u6237","\u8d44\u6e90\u6570"]);var e=google.visualization.arrayToDataTable(c),d={is3D:!0},f=new google.visualization.PieChart(document.getElementById("statBody"));setTimeout(function(){f.draw(e,d)},200)};b.showTimeStatistics=function(){b.stat=
1;var c=s.statistics.byTime(a.activity),e=c.beginning,c=_.map(c.items,function(a,b){var c=new Date(parseInt(b)+e);return[c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+" "+c.getHours()+":"+c.getMinutes(),a.length]});c.splice(0,0,["\u65f6\u95f4","\u8d44\u6e90\u6570"]);var d=google.visualization.arrayToDataTable(c),f={hAxis:{title:"\u65f6\u95f4",titleTextStyle:{color:"red"}}},g=new google.visualization.ColumnChart(document.getElementById("statBody"));setTimeout(function(){g.draw(d,f)},200)};window.rs=
a;window.utils=p;m();(function(){var b=document.querySelector("video");b.addEventListener("timeupdate",function(f){f=a.selectedMainVideoStartTime()+1E3*b.currentTime;f=e(f);f=$(".resourceItem[data-ts="+f+"]");var d=f.parents(".resourceGroup"),g=parseInt(f.attr("data-gindex")),k=parseInt(f.attr("data-rindex")),l=$("#timeline");if(a.highlightResource.g!==g||a.highlightResource.r!==k)l.scrollTop(l.scrollTop()+d.position().top+f.position().top),a.$apply(function(){a.highlightResource={g:g,r:k};var b=
l.width();l.width(b+1);setTimeout(function(){l.width(b)},0)})})})()}]);angular.module("ap.controllers.videoUploader",["ts.services.activity","ts.services.user"]).controller("MainVideoUploaderController",["$rootScope","$scope","$location","ActivityService","UserService",function(a,b,g,s,n){function p(){if(b.videoFile&&b.videoDuration&&b.videoName){var a=new FormData,g=new XMLHttpRequest;a.append("file",b.videoFile);g.upload.addEventListener("progress",function(a){b.$apply(function(){b.videoUploadProgress=Math.floor(100*(a.loaded/a.total))})},!1);g.addEventListener("load",
function(a){b.videoIsUploading=!1;if(200==g.status){var e=(a=JSON.parse(g.responseText))&&a[0]?"/resources/"+a[0].filename:null;console.log("[uploader] upload video success",a,e);b.videoURL=e;r()}b.$digest()},!1);g.addEventListener("error",function(a){console.log("[uploader] upload video error",a);b.$apply(function(){m()})},!1);b.videoIsUploading=!0;b.videoUploadProgress=0;g.open("POST","/resources");g.send(a);console.log("[uploader] uploading video ...")}}function r(){var e=g.search().aid,k=new FormData,
f=new XMLHttpRequest;k.append("src",b.videoURL);k.append("name",b.videoName);k.append("duration",b.videoDuration);f.addEventListener("load",function(e){b.videoIsAdding=!1;if(201==f.status){var c=(e=JSON.parse(f.responseText))?e.c:-1,g=e?e.r:null;console.log("[uploader] add success",e);!c&&g&&($("#uploadMainVideoModal").modal("hide"),a.mainVideos=g.videos)}a.$digest()});f.addEventListener("error",function(a){console.log("[uploader] add video error",a);b.$apply(function(){m()})});b.videoIsAdding=!0;
f.open("POST","/activities/"+e+"/videos");f.send(k);console.log("[uploader] adding video to activity",e)}function m(){b.videoFile=null;b.videoName=null;b.videoDuration=0;b.videoIsUploading=!1;b.videoIsAdding=!1;b.videoUploadProgress=0;b.videoURL=null}var q=document.getElementById("mainVideoFile");m();b.onSelectedFile=function(){var a=q.files,a=a?a[0]:null;console.log("[uploader] selected file",a);if(a){b.videoFile=a;var g=document.createElement("video"),a=window.URL.createObjectURL(a);g.addEventListener("loadedmetadata",
function(){b.videoDuration=g.duration;console.log("[uploader] video duration = "+g.duration)});g.src=a;console.log("[uploader] reading video file ...")}};b.startUpload=function(){p()}}]);(function(){angular.module("activityPlay",["ts.services.user","ts.services.activity","ap.controllers.main","ap.controllers.videoUploader"])})();
