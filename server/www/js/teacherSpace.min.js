(function(b){function a(a,d){this.itemsArray=[];this.$element=b(a);this.$element.hide();this.multiple=(this.isSelect="SELECT"===a.tagName)&&a.hasAttribute("multiple");this.objectItems=d&&d.itemValue;this.placeholderText=a.hasAttribute("placeholder")?this.$element.attr("placeholder"):"";this.inputSize=Math.max(1,this.placeholderText.length);this.$container=b('<div class="bootstrap-tagsinput"></div>');this.$input=b('<input size="'+this.inputSize+'" type="text" placeholder="'+this.placeholderText+'"/>').appendTo(this.$container);
this.$element.after(this.$container);this.build(d)}function e(b,a){if("function"!==typeof b[a]){var c=b[a];b[a]=function(b){return b[c]}}}function k(b,a){if("function"!==typeof b[a]){var c=b[a];b[a]=function(){return c}}}function f(b){return b?n.text(b).html():""}function g(b){var a=0;if(document.selection)b.focus(),a=document.selection.createRange(),a.moveStart("character",-b.value.length),a=a.text.length;else if(b.selectionStart||"0"==b.selectionStart)a=b.selectionStart;return a}var m={tagClass:function(b){return"label label-info"},
itemValue:function(b){return b?b.toString():b},itemText:function(b){return this.itemValue(b)},freeInput:!0,maxTags:void 0,confirmKeys:[13],onTagExists:function(b,a){a.hide().fadeIn()}};a.prototype={constructor:a,add:function(a,d){var c=this;if(!(c.options.maxTags&&c.itemsArray.length>=c.options.maxTags||!1!==a&&!a)){if("object"===typeof a&&!c.objectItems)throw"Can't add objects when itemValue option is not set";if(!a.toString().match(/^\s*$/)){c.isSelect&&!c.multiple&&0<c.itemsArray.length&&c.remove(c.itemsArray[0]);
if("string"===typeof a&&"INPUT"===this.$element[0].tagName){var l=a.split(",");if(1<l.length){for(var e=0;e<l.length;e++)this.add(l[e],!0);d||c.pushVal();return}}var h=c.options.itemValue(a),l=c.options.itemText(a),e=c.options.tagClass(a),g=b.grep(c.itemsArray,function(a){return c.options.itemValue(a)===h})[0];g?c.options.onTagExists&&(l=b(".tag",c.$container).filter(function(){return b(this).data("item")===g}),c.options.onTagExists(a,l)):(c.itemsArray.push(a),e=b('<span class="tag '+f(e)+'">'+f(l)+
'<span data-role="remove"></span></span>'),e.data("item",a),c.findInputWrapper().before(e),e.after(" "),c.isSelect&&!b('option[value="'+escape(h)+'"]',c.$element)[0]&&(l=b("<option selected>"+f(l)+"</option>"),l.data("item",a),l.attr("value",h),c.$element.append(l)),d||c.pushVal(),c.options.maxTags===c.itemsArray.length&&c.$container.addClass("bootstrap-tagsinput-max"),c.$element.trigger(b.Event("itemAdded",{item:a})))}}},remove:function(a,d){var c=this;c.objectItems&&(a="object"===typeof a?b.grep(c.itemsArray,
function(b){return c.options.itemValue(b)==c.options.itemValue(a)})[0]:b.grep(c.itemsArray,function(b){return c.options.itemValue(b)==a})[0]);a&&(b(".tag",c.$container).filter(function(){return b(this).data("item")===a}).remove(),b("option",c.$element).filter(function(){return b(this).data("item")===a}).remove(),c.itemsArray.splice(b.inArray(a,c.itemsArray),1));d||c.pushVal();c.options.maxTags>c.itemsArray.length&&c.$container.removeClass("bootstrap-tagsinput-max");c.$element.trigger(b.Event("itemRemoved",
{item:a}))},removeAll:function(){b(".tag",this.$container).remove();for(b("option",this.$element).remove();0<this.itemsArray.length;)this.itemsArray.pop();this.pushVal();this.options.maxTags&&!this.isEnabled()&&this.enable()},refresh:function(){var a=this;b(".tag",a.$container).each(function(){var d=b(this),c=d.data("item"),l=a.options.itemValue(c),e=a.options.itemText(c),h=a.options.tagClass(c);d.attr("class",null);d.addClass("tag "+f(h));d.contents().filter(function(){return 3==this.nodeType})[0].nodeValue=
f(e);a.isSelect&&b("option",a.$element).filter(function(){return b(this).data("item")===c}).attr("value",l)})},items:function(){return this.itemsArray},pushVal:function(){var a=this,d=b.map(a.items(),function(b){return a.options.itemValue(b).toString()});a.$element.val(d,!0).trigger("change")},build:function(a){var d=this;d.options=b.extend({},m,a);var c=d.options.typeahead||{};d.objectItems&&(d.options.freeInput=!1);e(d.options,"itemValue");e(d.options,"itemText");e(d.options,"tagClass");d.options.source&&
(c.source=d.options.source);c.source&&b.fn.typeahead&&(k(c,"source"),d.$input.typeahead({source:function(a,e){function h(a){for(var b=[],c=0;c<a.length;c++){var h=d.options.itemText(a[c]);f[h]=a[c];b.push(h)}e(b)}var f=this.map={},g=c.source(a);b.isFunction(g.success)?g.success(h):b.when(g).then(h)},updater:function(a){d.add(this.map[a])},matcher:function(a){return-1!==a.toLowerCase().indexOf(this.query.trim().toLowerCase())},sorter:function(a){return a.sort()},highlighter:function(a){return a.replace(RegExp("("+
this.query+")","gi"),"<strong>$1</strong>")}}));d.$container.on("click",b.proxy(function(a){d.$input.focus()},d));d.$container.on("keydown","input",b.proxy(function(a){var c=b(a.target),h=d.findInputWrapper();switch(a.which){case 8:0===g(c[0])&&(h=h.prev())&&d.remove(h.data("item"));break;case 46:0===g(c[0])&&(h=h.next())&&d.remove(h.data("item"));break;case 37:a=h.prev();0===c.val().length&&a[0]&&(a.before(h),c.focus());break;case 39:a=h.next();0===c.val().length&&a[0]&&(a.after(h),c.focus());break;
default:d.options.freeInput&&0<=b.inArray(a.which,d.options.confirmKeys)&&(d.add(c.val()),c.val(""),a.preventDefault())}c.attr("size",Math.max(this.inputSize,c.val().length))},d));d.$container.on("click","[data-role=remove]",b.proxy(function(a){d.remove(b(a.target).closest(".tag").data("item"))},d));d.options.itemValue===m.itemValue&&("INPUT"===d.$element[0].tagName?d.add(d.$element.val()):b("option",d.$element).each(function(){d.add(b(this).attr("value"),!0)}))},destroy:function(){this.$container.off("keypress",
"input");this.$container.off("click","[role=remove]");this.$container.remove();this.$element.removeData("tagsinput");this.$element.show()},focus:function(){this.$input.focus()},input:function(){return this.$input},findInputWrapper:function(){for(var a=this.$input[0],d=this.$container[0];a&&a.parentNode!==d;)a=a.parentNode;return b(a)}};b.fn.tagsinput=function(e,d){var c=[];this.each(function(){var g=b(this).data("tagsinput");g?(g=g[e](d),void 0!==g&&c.push(g)):(g=new a(this,e),b(this).data("tagsinput",
g),c.push(g),"SELECT"===this.tagName&&b("option",b(this)).attr("selected","selected"),b(this).val(b(this).val()))});return"string"==typeof e?1<c.length?c:c[0]:c};b.fn.tagsinput.Constructor=a;var n=b("<div />");b(function(){b("input[data-role=tagsinput], select[multiple][data-role=tagsinput]").tagsinput()})})(window.jQuery);angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8080":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){return{object:{toUrlencodedString:function(b){return _.map(b,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(b){var a=document.cookie.split("; ");return _.reduce(a,function(a,b){var f=b.split("=");a[f[0]]=f[1];return a},{})[b]}}}}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(b,a,e,k,f){return{uid:function(){return e.cookie.get("uid")},hasLoggedIn:function(){var a=e.cookie.get("uid"),b=e.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(e,m,n,p){function d(a,d){console.log("[UserService] login result:",
a,d,document.cookie);200==d&&n?(localStorage.login_result=JSON.stringify(a),n(a,d)):p&&p(a,d);b.$emit(f,d,a)}a.put(k+"/users/"+e+"/login","pwd="+encodeURIComponent(m),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(d).error(d)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")},fetchProfile:function(a){}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(b,a,e,k,f){function g(a){a?(b.selectedActivity=a,b.selectedActivityID=a._id):(b.selectedActivity=null,b.selectedActivityID="");console.log("[ActivityService] selected activity",b.selectedActivity)}function m(h,g,k,q){d();g=e.object.toUrlencodedString(g);a.put(f+"/activities/"+h,g,{responseType:"json",
headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,d){if(a&&!a.c&&a.r)a:{var h=a.r;b.activityMap[h._id]=h;for(var e=0;e<b.activityList.length;++e)for(var g=b.activityList[e].activities,f=0;f<g.length;++f)if(g[f]._id==h._id){b.selectedActivity==g[f]&&(b.selectedActivity=h,b.selectedActivityID=h._id);g[f]=h;break a}}c();k&&k(a,d)}).error(function(a,b){c();q&&q(a,b)})}function n(a,c){b.activityList.splice(a,0,{date:p(c),activities:[c]})}function p(a){a=new Date(a.info.date);
a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}function d(){r.setAttribute("disabled","disabled")}function c(){r.removeAttribute("disabled")}function l(){b.hints="\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8"}var r=document.getElementById("activityDetailButtons");b.activityList=[];b.activityMap={};b.selectedActivity=null;b.selectedActivityID="";b.hints="";return{selectActivity:g,selectActivityByID:function(a){g(b.activityMap[a])},fetchActivities:function(c,
d,e){b.activityList=[];b.activityMap={};b.hints="\u8bf7\u7a0d\u540e...";c=c||{};"manager"==b.mode()&&(c.creator=k.uid());c._=(new Date).getTime();console.log("[ActivityService] fetching activities with",c);a.get(f+"/activities",{responseType:"json",params:c}).success(function(a,c){if(200===c&&!a.c){var e=a.r.activities,h=_.groupBy(e,function(a){return p(a)});b.activityList=_.map(h,function(a,b){return{date:b,activities:a}});b.activityMap=_.reduce(e,function(a,b){a[b._id]=b;return a},{});b.activityList.length?
b.hints="":l();console.log("[ActivityService] activities result",b.activityList,b.activityMap)}d&&d(a,c)}).error(function(a,c){b.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";e&&e(a,c)})},getActivity:function(b,c,d){a.get(f+"/activities/"+b,{responseType:"json"}).success(c).error(d)},createActivity:function(c,d,g){c=e.object.toUrlencodedString(c);a.post(f+"/activities",c,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,c){if(a&&!a.c&&a.r){b.hints=
"";a:{var e=a.r[0];b.activityMap[e._id]=e;for(var g=p(e),h=0;h<b.activityList.length;++h){var f=b.activityList[h];if(f.date==g){f.activities.unshift(e);break a}else if(f.date>g){n(h,e);break a}}n(h,e)}}b.hints="";d&&d(a,c)}).error(g)},updateActivity:m,closeActivity:function(a,b,c){m(a,{status:"closed"},b,c)},deleteActivity:function(e,k,m){d();a({method:"DELETE",url:f+"/activities/"+e}).success(function(a,d){if(a&&!a.c)a:{g(),delete b.activityMap[e];for(var f=0;f<b.activityList.length;++f)for(var m=
0;m<b.activityList[f].activities.length;++m)if(b.activityList[f].activities[m]._id==e){b.activityList[f].activities.splice(m,1);b.activityList[f].activities.length||b.activityList.splice(f,1);break a}}c();b.activityList.length||l();k&&k(a,d)}).error(function(a,b){c();m&&m(a,b)})},fetchActivityConfig:function(b,c){var d=(new Date).getTime();a.get(f+"/activities/config?_="+d,null,{responseType:"json"}).success(function(a,c){console.log("[ActivityService] activity config =",a);b&&b(a,c)}).error(function(a,
b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");c&&c(a,b)})}}}]);angular.module("ts.controllers.activityDetail",["ts.utils.constants","ts.services.activity"]).controller("ActivityDetailController",["$rootScope","$scope","ActivityService","EVENT_MODE_CHANGE","CMD_SHOW_ACTIVITY_PANEL",function(b,a,e,k,f){a.userCount=function(){if(b.selectedActivity){if(b.selectedActivity.active)return b.selectedActivity.users.participators.length;var a=_.countBy(b.selectedActivity.resources,function(a){return a.user});return _.keys(a).length}return 0};a.editActivity=function(){b.$emit(f,
{panelTitle:"\u7f16\u8f91\u6d3b\u52a8",confirmBtnTitle:"\u4fdd\u5b58",activity:$.extend(!0,{},b.selectedActivity)})};a.closeActivity=function(){confirm("\u786e\u5b9a\u8981\u5173\u95ed\u6d3b\u52a8\uff1f")&&e.closeActivity(b.selectedActivity._id)};a.deleteActivity=function(){confirm("\u78ba\u5b9a\u8981\u522a\u9664\u6d3b\u52d5\uff1f")&&e.deleteActivity(b.selectedActivity._id)};a.handlePlayBtnClick=function(){window.open("activity_play.html#?aid="+b.selectedActivity._id,"_blank")};b.$on(k,function(a,
b){e.selectActivity()})}]);angular.module("ts.controllers.activityList",["ts.services.activity"]).controller("ActivityListController",["$rootScope","$scope","ActivityService",function(b,a,e){a.selectActivity=function(a){e.selectActivityByID(a)}}]);angular.module("ts.controllers.activityPanel",["ts.utils.constants","ts.services.activity"]).controller("ActivityPanelController",["$rootScope","$scope","$http","ActivityService","CMD_SHOW_ACTIVITY_PANEL",function(b,a,e,k,f){function g(a,b){console.log(a,b);h.removeAttribute("disabled");c.modal("hide")}function m(b,c){b=b||{c:-1,msg:"UNKNOWN"};a.errMsg=c+" - ["+b.c+"] "+b.m;h.removeAttribute("disabled")}function n(){h.setAttribute("disabled","disabled")}function p(a,b){a.setMinutes(a.getMinutes()-
s);b||(a.setSeconds(0),a.setMilliseconds(0));return a.toISOString().split(".")[0]}function d(a){if(a){var b=3>a.split(":").length?":00.000Z":".000Z",b=Date.parse(a+b)+6E4*s;console.log(a,b,new Date(b));return b}return 0}var c=$("#createActivityModal"),l=$('input[data-role="tagsinput"]'),r=document.getElementById("na_date"),h=document.getElementById("activityFormAllFields"),t=document.getElementById("activityFormFieldsForOpenActivities"),s=(new Date).getTimezoneOffset(),q={info:{type:1},users:{invitedUsers:[]}};
b.$on(f,function(b,c){c=c||{};a.panelTitle=c.panelTitle||"\u521b\u5efa\u6d3b\u52a8";a.confirmBtnTitle=c.confirmBtnTitle||"\u521b\u5efa\u6d3b\u52a8";a.cancelBtnTitle=c.cancelBtnTitle||"\u53d6\u6d88";a.activity=c.activity||$.extend(!0,{},q);a.invitedUsers=a.activity.users.invitedUsers.join(",");var d=a.activity.info.date,e=new Date,d=d?new Date(d):e;d.setSeconds(0);d.setMilliseconds(0);a.activity.info.date=p(d);r.setAttribute("min",p(e));_.each(a.activity.users.invitedUsers,function(a){l.tagsinput("add",
a)});a.showActivityPanel()});c.on("hidden.bs.modal",function(){a.activity=$.extend(!0,{},q);a.grade=a.cls=a.subject=0;a.errMsg="";l.tagsinput("removeAll")});a.$watch("grade",function(b){a.cls=0});a.showActivityPanel=function(){$("#createActivityModal").modal("show");!a.activity._id||a.activity.active?t.removeAttribute("disabled"):t.setAttribute("disabled","disabled")};a.createActivity=function(){a.errMsg="";n();var b=a.config?a.config.activityConfig:{};console.log(b,a.activity);b={uids:a.invitedUsers||
"",title:a.activity.info.title||"",type:a.activity.info.type|1,desc:a.activity.info.desc||"",date:d(a.activity.info.date),teacher:a.activity.info.teacher||"",grade:b.classes[a.grade].grade,"class":b.classes[a.grade].cls[a.cls],subject:b.subjects[a.subject],domain:a.activity.info.domain||""};k.createActivity(b,g,m)};a.updateActivity=function(){a.errMsg="";n();var b=a.config?a.config.activityConfig:{},c={uids:a.invitedUsers||""};a.activity.active&&(c.title=a.activity.info.title||"",c.type=a.activity.info.type||
"",c.desc=a.activity.info.desc||"",c.date=d(a.activity.info.date),c.teacher=a.activity.info.teacher||"",c.grade=b.classes[a.grade].grade||"",c["class"]=b.classes[a.grade].cls[a.cls]||"",c.subject=b.subjects[a.subject]||"",c.domain=a.activity.info.domain||"");k.updateActivity(a.activity._id,c,g,m)};a.handleConfirmBtnClick=function(){a.activity._id?a.updateActivity():a.createActivity()};(function(){k.fetchActivityConfig(function(b,c){a.config=b;a.grade=0;a.cls=0;a.subject=0})})()}]);angular.module("ts.controllers.loginForm",["ts.utils.constants","ts.services.user"]).controller("LoginFormController",["$rootScope","$scope","UserService","CMD_SHOW_LOGIN_PANEL",function(b,a,e,k){a.uid="";a.pwd="";a.errMsg="";a.login=function(){function b(e,f){200==f?$("#loginModal").modal("hide"):(a.errMsg="\u9a8c\u8bc1\u5931\u8d25",a.$digest());a.uid=a.pwd=a.errMsg=""}a.uid?a.pwd?e.login(a.uid,a.pwd,b,b):a.errMsg="\u8bf7\u8f93\u5165\u5bc6\u7801":a.errMsg="\u8bf7\u8f93\u5165\u5e10\u53f7\u540d"};
b.$on(k,function(){if(e.hasLoggedIn())if(confirm("\u786e\u5b9a\u8981\u9000\u51fa\u767b\u5f55\u5417\uff1f"))e.logout();else return;$("#loginModal").modal("show")});e.hasLoggedIn()||$("#loginModal").modal("show")}]);angular.module("ts.controllers.main",["ts.utils.constants","ts.services.user","ts.services.activity"]).controller("MainController",["$rootScope","$scope","$http","$location","UserService","ActivityService","EVENT_LOGIN","CMD_SHOW_LOGIN_PANEL","EVENT_MODE_CHANGE",function(b,a,e,k,f,g,m,n,p){b.fetchActivities=function(a){g.selectActivity();g.fetchActivities(a)};b.showLoginModal=function(){b.$emit(n)};b.mode=function(){return k.search().mode};b.gotoMode=function(a){a!==b.mode()&&(k.search("mode",a),
b.$emit(p,a))};b.$on(m,function(a,c){200==c&&b.fetchActivities()});f.hasLoggedIn()&&b.fetchActivities()}]);angular.module("ts.controllers.navigator",["ts.services.user"]).controller("NavigatorController",["$rootScope","$scope","UserService","EVENT_LOGIN","CMD_SHOW_LOGIN_PANEL",function(b,a,e,k,f){b.$on(k,function(b,f){200==f&&(a.nickname=e.nick())});a.nickname=e.nick()}]);angular.module("ts.controllers.toolbar",["ts.utils.constants"]).controller("ToolbarController",["$rootScope","$scope","EVENT_MODE_CHANGE","CMD_SHOW_ACTIVITY_PANEL",function(b,a,e,k){a.authorizationTypes=[{label:"\u6388\u6743\u6211\u53c2\u4e0e\u7684",value:"invited"},{label:"\u516c\u5f00\u7684",value:"public"},{label:"\u5168\u90e8",value:null}];a.statuses=[{label:"\u5f00\u653e\u7684",value:"active"},{label:"\u5173\u95ed\u7684",value:"closed"},{label:"\u5168\u90e8",value:null}];a.aTypeIndex=2;a.statusIndex=
2;a.searchKeyword="";a.showCreateActivityModal=function(a){a.currentTarget.classList.contains("disabled")||b.$emit(k)};a.updateQueryAndSearch=function(e,g){e&&(a[e]=g);var k={},n=a.authorizationTypes[a.aTypeIndex].value,p=a.statuses[a.statusIndex].value;n&&(k.authorize=n);p&&(k.status=p);a.searchKeyword&&(k.kw=a.searchKeyword);b.fetchActivities(k)};b.$on(e,function(b,e){a.updateQueryAndSearch()})}]);angular.module("ts.directives.ngEnter",[]).directive("ngEnter",function(){return{link:function(b,a,e){a.on("keydown",function(a){if(13==a.keyCode){var f=e.ngEnter;f&&_.bind(function(){eval("this."+f)},b)()}})}}});(function(){angular.module("teacherSpace","ts.controllers.main ts.controllers.navigator ts.controllers.toolbar ts.controllers.activityList ts.controllers.activityDetail ts.controllers.activityPanel ts.controllers.loginForm ts.directives.ngEnter".split(" "))})();
