!function(e){var c=function(a,d){this.element=e(a);this.format=b.parseFormat(d.format||this.element.data("date-format")||"mm/dd/yyyy");this.picker=e(b.template).appendTo("body").on({click:e.proxy(this.click,this)});this.isInput=this.element.is("input");this.component=this.element.is(".date")?this.element.find(".add-on"):!1;if(this.isInput)this.element.on({focus:e.proxy(this.show,this),keyup:e.proxy(this.update,this)});else if(this.component)this.component.on("click",e.proxy(this.show,this));else this.element.on("click",
e.proxy(this.show,this));this.minViewMode=d.minViewMode||this.element.data("date-minviewmode")||0;if("string"===typeof this.minViewMode)switch(this.minViewMode){case "months":this.minViewMode=1;break;case "years":this.minViewMode=2;break;default:this.minViewMode=0}this.viewMode=d.viewMode||this.element.data("date-viewmode")||0;if("string"===typeof this.viewMode)switch(this.viewMode){case "months":this.viewMode=1;break;case "years":this.viewMode=2;break;default:this.viewMode=0}this.startViewMode=this.viewMode;
this.weekStart=d.weekStart||this.element.data("date-weekstart")||0;this.weekEnd=0===this.weekStart?6:this.weekStart-1;this.onRender=d.onRender;this.fillDow();this.fillMonths();this.update();this.showMode()};c.prototype={constructor:c,show:function(a){this.picker.show();this.height=this.component?this.component.outerHeight():this.element.outerHeight();this.place();e(window).on("resize",e.proxy(this.place,this));a&&(a.stopPropagation(),a.preventDefault());var b=this;e(document).on("mousedown",function(a){0==
e(a.target).closest(".datepicker").length&&b.hide()});this.element.trigger({type:"show",date:this.date})},hide:function(){this.picker.hide();e(window).off("resize",this.place);this.viewMode=this.startViewMode;this.showMode();this.isInput||e(document).off("mousedown",this.hide);this.element.trigger({type:"hide",date:this.date})},set:function(){var a=b.formatDate(this.date,this.format);this.isInput?this.element.prop("value",a):(this.component&&this.element.find("input").prop("value",a),this.element.data("date",
a))},setValue:function(a){this.date="string"===typeof a?b.parseDate(a,this.format):new Date(a);this.set();this.viewDate=new Date(this.date.getFullYear(),this.date.getMonth(),1,0,0,0,0);this.fill()},place:function(){var a=this.component?this.component.offset():this.element.offset();this.picker.css({top:a.top+this.height,left:a.left})},update:function(a){this.date=b.parseDate("string"===typeof a?a:this.isInput?this.element.prop("value"):this.element.data("date"),this.format);this.viewDate=new Date(this.date.getFullYear(),
this.date.getMonth(),1,0,0,0,0);this.fill()},fillDow:function(){for(var a=this.weekStart,d="<tr>";a<this.weekStart+7;)d+='<th class="dow">'+b.dates.daysMin[a++%7]+"</th>";d+="</tr>";this.picker.find(".datepicker-days thead").append(d)},fillMonths:function(){for(var a="",d=0;12>d;)a+='<span class="month">'+b.dates.monthsShort[d++]+"</span>";this.picker.find(".datepicker-months td").append(a)},fill:function(){var a=new Date(this.viewDate),d=a.getFullYear(),e=a.getMonth(),c=this.date.valueOf();this.picker.find(".datepicker-days th:eq(1)").text(b.dates.months[e]+
" "+d);var f=new Date(d,e-1,28,0,0,0,0),a=b.getDaysInMonth(f.getFullYear(),f.getMonth());f.setDate(a);f.setDate(a-(f.getDay()-this.weekStart+7)%7);var m=new Date(f);m.setDate(m.getDate()+42);for(var m=m.valueOf(),a=[],l,g,n;f.valueOf()<m;){f.getDay()===this.weekStart&&a.push("<tr>");l=this.onRender(f);g=f.getFullYear();n=f.getMonth();if(n<e&&g===d||g<d)l+=" old";else if(n>e&&g===d||g>d)l+=" new";f.valueOf()===c&&(l+=" active");a.push('<td class="day '+l+'">'+f.getDate()+"</td>");f.getDay()===this.weekEnd&&
a.push("</tr>");f.setDate(f.getDate()+1)}this.picker.find(".datepicker-days tbody").empty().append(a.join(""));e=this.date.getFullYear();a=this.picker.find(".datepicker-months").find("th:eq(1)").text(d).end().find("span").removeClass("active");e===d&&a.eq(this.date.getMonth()).addClass("active");a="";d=10*parseInt(d/10,10);c=this.picker.find(".datepicker-years").find("th:eq(1)").text(d+"-"+(d+9)).end().find("td");d-=1;for(f=-1;11>f;f++)a+='<span class="year'+(-1===f||10===f?" old":"")+(e===d?" active":
"")+'">'+d+"</span>",d+=1;c.html(a)},click:function(a){a.stopPropagation();a.preventDefault();var d=e(a.target).closest("span, td, th");if(1===d.length)switch(d[0].nodeName.toLowerCase()){case "th":switch(d[0].className){case "switch":this.showMode(1);break;case "prev":case "next":this.viewDate["set"+b.modes[this.viewMode].navFnc].call(this.viewDate,this.viewDate["get"+b.modes[this.viewMode].navFnc].call(this.viewDate)+b.modes[this.viewMode].navStep*("prev"===d[0].className?-1:1)),this.fill(),this.set()}break;
case "span":d.is(".month")?(a=d.parent().find("span").index(d),this.viewDate.setMonth(a)):(d=parseInt(d.text(),10)||0,this.viewDate.setFullYear(d));0!==this.viewMode&&(this.date=new Date(this.viewDate),this.element.trigger({type:"changeDate",date:this.date,viewMode:b.modes[this.viewMode].clsName}));this.showMode(-1);this.fill();this.set();break;case "td":if(d.is(".day")&&!d.is(".disabled")){var c=parseInt(d.text(),10)||1;a=this.viewDate.getMonth();d.is(".old")?a-=1:d.is(".new")&&(a+=1);d=this.viewDate.getFullYear();
this.date=new Date(d,a,c,0,0,0,0);this.viewDate=new Date(d,a,Math.min(28,c),0,0,0,0);this.fill();this.set();this.element.trigger({type:"changeDate",date:this.date,viewMode:b.modes[this.viewMode].clsName})}}},mousedown:function(a){a.stopPropagation();a.preventDefault()},showMode:function(a){a&&(this.viewMode=Math.max(this.minViewMode,Math.min(2,this.viewMode+a)));this.picker.find(">div").hide().filter(".datepicker-"+b.modes[this.viewMode].clsName).show()}};e.fn.datepicker=function(a,b){return this.each(function(){var k=
e(this),h=k.data("datepicker"),f="object"===typeof a&&a;h||k.data("datepicker",h=new c(this,e.extend({},e.fn.datepicker.defaults,f)));if("string"===typeof a)h[a](b)})};e.fn.datepicker.defaults={onRender:function(a){return""}};e.fn.datepicker.Constructor=c;var b={modes:[{clsName:"days",navFnc:"Month",navStep:1},{clsName:"months",navFnc:"FullYear",navStep:1},{clsName:"years",navFnc:"FullYear",navStep:10}],dates:{days:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),daysShort:"Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),
daysMin:"Su Mo Tu We Th Fr Sa Su".split(" "),months:"January February March April May June July August September October November December".split(" "),monthsShort:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")},isLeapYear:function(a){return 0===a%4&&0!==a%100||0===a%400},getDaysInMonth:function(a,d){return[31,b.isLeapYear(a)?29:28,31,30,31,30,31,31,30,31,30,31][d]},parseFormat:function(a){var b=a.match(/[.\/\-\s].*?/);a=a.split(/\W+/);if(!b||!a||0===a.length)throw Error("Invalid date format.");
return{separator:b,parts:a}},parseDate:function(a,b){var e=a.split(b.separator);a=new Date;var c;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);if(e.length===b.parts.length){for(var f=a.getFullYear(),m=a.getDate(),l=a.getMonth(),g=0,n=b.parts.length;g<n;g++)switch(c=parseInt(e[g],10)||1,b.parts[g]){case "dd":case "d":m=c;a.setDate(c);break;case "mm":case "m":l=c-1;a.setMonth(c-1);break;case "yy":f=2E3+c;a.setFullYear(2E3+c);break;case "yyyy":f=c,a.setFullYear(c)}a=new Date(f,l,
m,0,0,0)}return a},formatDate:function(a,b){var e={d:a.getDate(),m:a.getMonth()+1,yy:a.getFullYear().toString().substring(2),yyyy:a.getFullYear()};e.dd=(10>e.d?"0":"")+e.d;e.mm=(10>e.m?"0":"")+e.m;a=[];for(var c=0,f=b.parts.length;c<f;c++)a.push(e[b.parts[c]]);return a.join(b.separator)},headTemplate:'<thead><tr><th class="prev">&lsaquo;</th><th colspan="5" class="switch"></th><th class="next">&rsaquo;</th></tr></thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>'};b.template='<div class="datepicker dropdown-menu"><div class="datepicker-days"><table class=" table-condensed">'+
b.headTemplate+'<tbody></tbody></table></div><div class="datepicker-months"><table class="table-condensed">'+b.headTemplate+b.contTemplate+'</table></div><div class="datepicker-years"><table class="table-condensed">'+b.headTemplate+b.contTemplate+"</table></div></div>"}(window.jQuery);(function(e){function c(a,b){this.itemsArray=[];this.$element=e(a);this.$element.hide();this.multiple=(this.isSelect="SELECT"===a.tagName)&&a.hasAttribute("multiple");this.objectItems=b&&b.itemValue;this.placeholderText=a.hasAttribute("placeholder")?this.$element.attr("placeholder"):"";this.inputSize=Math.max(1,this.placeholderText.length);this.$container=e('<div class="bootstrap-tagsinput"></div>');this.$input=e('<input size="'+this.inputSize+'" type="text" placeholder="'+this.placeholderText+'"/>').appendTo(this.$container);
this.$element.after(this.$container);this.build(b)}function b(a,b){if("function"!==typeof a[b]){var e=a[b];a[b]=function(a){return a[e]}}}function a(a,b){if("function"!==typeof a[b]){var e=a[b];a[b]=function(){return e}}}function d(a){return a?f.text(a).html():""}function k(a){var b=0;if(document.selection)a.focus(),b=document.selection.createRange(),b.moveStart("character",-a.value.length),b=b.text.length;else if(a.selectionStart||"0"==a.selectionStart)b=a.selectionStart;return b}var h={tagClass:function(a){return"label label-info"},
itemValue:function(a){return a?a.toString():a},itemText:function(a){return this.itemValue(a)},freeInput:!0,maxTags:void 0,confirmKeys:[13],onTagExists:function(a,b){b.hide().fadeIn()}};c.prototype={constructor:c,add:function(a,b){var g=this;if(!(g.options.maxTags&&g.itemsArray.length>=g.options.maxTags||!1!==a&&!a)){if("object"===typeof a&&!g.objectItems)throw"Can't add objects when itemValue option is not set";if(!a.toString().match(/^\s*$/)){g.isSelect&&!g.multiple&&0<g.itemsArray.length&&g.remove(g.itemsArray[0]);
if("string"===typeof a&&"INPUT"===this.$element[0].tagName){var c=a.split(",");if(1<c.length){for(var f=0;f<c.length;f++)this.add(c[f],!0);b||g.pushVal();return}}var k=g.options.itemValue(a),c=g.options.itemText(a),f=g.options.tagClass(a),h=e.grep(g.itemsArray,function(a){return g.options.itemValue(a)===k})[0];h?g.options.onTagExists&&(c=e(".tag",g.$container).filter(function(){return e(this).data("item")===h}),g.options.onTagExists(a,c)):(g.itemsArray.push(a),f=e('<span class="tag '+d(f)+'">'+d(c)+
'<span data-role="remove"></span></span>'),f.data("item",a),g.findInputWrapper().before(f),f.after(" "),g.isSelect&&!e('option[value="'+escape(k)+'"]',g.$element)[0]&&(c=e("<option selected>"+d(c)+"</option>"),c.data("item",a),c.attr("value",k),g.$element.append(c)),b||g.pushVal(),g.options.maxTags===g.itemsArray.length&&g.$container.addClass("bootstrap-tagsinput-max"),g.$element.trigger(e.Event("itemAdded",{item:a})))}}},remove:function(a,b){var d=this;d.objectItems&&(a="object"===typeof a?e.grep(d.itemsArray,
function(b){return d.options.itemValue(b)==d.options.itemValue(a)})[0]:e.grep(d.itemsArray,function(b){return d.options.itemValue(b)==a})[0]);a&&(e(".tag",d.$container).filter(function(){return e(this).data("item")===a}).remove(),e("option",d.$element).filter(function(){return e(this).data("item")===a}).remove(),d.itemsArray.splice(e.inArray(a,d.itemsArray),1));b||d.pushVal();d.options.maxTags>d.itemsArray.length&&d.$container.removeClass("bootstrap-tagsinput-max");d.$element.trigger(e.Event("itemRemoved",
{item:a}))},removeAll:function(){e(".tag",this.$container).remove();for(e("option",this.$element).remove();0<this.itemsArray.length;)this.itemsArray.pop();this.pushVal();this.options.maxTags&&!this.isEnabled()&&this.enable()},refresh:function(){var a=this;e(".tag",a.$container).each(function(){var b=e(this),c=b.data("item"),f=a.options.itemValue(c),k=a.options.itemText(c),h=a.options.tagClass(c);b.attr("class",null);b.addClass("tag "+d(h));b.contents().filter(function(){return 3==this.nodeType})[0].nodeValue=
d(k);a.isSelect&&e("option",a.$element).filter(function(){return e(this).data("item")===c}).attr("value",f)})},items:function(){return this.itemsArray},pushVal:function(){var a=this,b=e.map(a.items(),function(b){return a.options.itemValue(b).toString()});a.$element.val(b,!0).trigger("change")},build:function(d){var c=this;c.options=e.extend({},h,d);var f=c.options.typeahead||{};c.objectItems&&(c.options.freeInput=!1);b(c.options,"itemValue");b(c.options,"itemText");b(c.options,"tagClass");c.options.source&&
(f.source=c.options.source);f.source&&e.fn.typeahead&&(a(f,"source"),c.$input.typeahead({source:function(a,b){function d(a){for(var e=[],f=0;f<a.length;f++){var g=c.options.itemText(a[f]);k[g]=a[f];e.push(g)}b(e)}var k=this.map={},h=f.source(a);e.isFunction(h.success)?h.success(d):e.when(h).then(d)},updater:function(a){c.add(this.map[a])},matcher:function(a){return-1!==a.toLowerCase().indexOf(this.query.trim().toLowerCase())},sorter:function(a){return a.sort()},highlighter:function(a){return a.replace(RegExp("("+
this.query+")","gi"),"<strong>$1</strong>")}}));c.$container.on("click",e.proxy(function(a){c.$input.focus()},c));c.$container.on("keydown","input",e.proxy(function(a){var b=e(a.target),d=c.findInputWrapper();switch(a.which){case 8:0===k(b[0])&&(d=d.prev())&&c.remove(d.data("item"));break;case 46:0===k(b[0])&&(d=d.next())&&c.remove(d.data("item"));break;case 37:a=d.prev();0===b.val().length&&a[0]&&(a.before(d),b.focus());break;case 39:a=d.next();0===b.val().length&&a[0]&&(a.after(d),b.focus());break;
default:c.options.freeInput&&0<=e.inArray(a.which,c.options.confirmKeys)&&(c.add(b.val()),b.val(""),a.preventDefault())}b.attr("size",Math.max(this.inputSize,b.val().length))},c));c.$container.on("click","[data-role=remove]",e.proxy(function(a){c.remove(e(a.target).closest(".tag").data("item"))},c));c.options.itemValue===h.itemValue&&("INPUT"===c.$element[0].tagName?c.add(c.$element.val()):e("option",c.$element).each(function(){c.add(e(this).attr("value"),!0)}))},destroy:function(){this.$container.off("keypress",
"input");this.$container.off("click","[role=remove]");this.$container.remove();this.$element.removeData("tagsinput");this.$element.show()},focus:function(){this.$input.focus()},input:function(){return this.$input},findInputWrapper:function(){for(var a=this.$input[0],b=this.$container[0];a&&a.parentNode!==b;)a=a.parentNode;return e(a)}};e.fn.tagsinput=function(a,b){var d=[];this.each(function(){var f=e(this).data("tagsinput");f?(f=f[a](b),void 0!==f&&d.push(f)):(f=new c(this,a),e(this).data("tagsinput",
f),d.push(f),"SELECT"===this.tagName&&e("option",e(this)).attr("selected","selected"),e(this).val(e(this).val()))});return"string"==typeof a?1<d.length?d:d[0]:d};e.fn.tagsinput.Constructor=c;var f=e("<div />");e(function(){e("input[data-role=tagsinput], select[multiple][data-role=tagsinput]").tagsinput()})})(window.jQuery);(function(){var e="localhost"==location.hostname?"http://localhost:8080":"";angular.module("TeacherSpace",[]).controller("MainController",["$rootScope","$scope","$http","$location","UserService","ActivityService",function(c,b,a,d,e,h){c.uid="oscar";c.activityID="";c.activity=null;c.fetchActivities=function(a){c.activityID="";c.activity=null;h.fetchActivities(a)};c.showLoginModal=function(){e.hasLoggedIn()||$("#loginModal").modal("show")};c.mode=function(){return d.search().mode};c.gotoMode=function(a){d.search("mode",
a);c.$emit("event.mode.change",a)};e.hasLoggedIn()?c.fetchActivities():c.showLoginModal();c.$on("event.login",function(a,b){c.fetchActivities()})}]).controller("NavigatorController",["$rootScope","$scope","UserService",function(c,b,a){b.username=a.uid();c.$on("event.login",function(d,c){b.username=a.uid()})}]).controller("ToolbarController",["$rootScope","$scope",function(c,b){b.authorizationTypes=[{label:"\u6388\u6743\u6211\u53c2\u4e0e\u7684",value:"invited"},{label:"\u516c\u5f00\u7684",value:"public"},
{label:"\u5168\u90e8",value:null}];b.statuses=[{label:"\u5f00\u653e\u7684",value:"active"},{label:"\u5173\u95ed\u7684",value:"closed"},{label:"\u5168\u90e8",value:null}];b.aTypeIndex=2;b.statusIndex=2;b.searchKeyword="";b.showCreateActivityModal=function(a){a.currentTarget.classList.contains("disabled")||$("#createActivityModal").modal("show")};b.updateQueryAndSearch=function(a,d){a&&(b[a]=d);var e={},h=b.authorizationTypes[b.aTypeIndex].value,f=b.statuses[b.statusIndex].value;h&&(e.authorize=h);
f&&(e.status=f);b.searchKeyword&&(e.kw=b.searchKeyword);c.fetchActivities(e)}}]).controller("ActivityListController",["$rootScope","$scope",function(c,b){b.selectActivity=function(a){c.activityID=a;c.activity=c.activityMap[a]}}]).controller("ActivityDetailController",["$rootScope","$scope",function(c,b){b.userCount=function(){if(c.activity){if(c.activity.active)return c.activity.users.participators.length;var a=_.countBy(c.activity.resources,function(a){return a.user});return _.keys(a).length}return 0}}]).controller("ActivityFormController",
["$rootScope","$scope","$http","ActivityService",function(c,b,a,d){var e=$("#createActivityModal"),h=document.querySelector("#createActivityForm > fieldset");e.on("hidden.bs.modal",function(){b.$apply(function(){b.invitedUsers="";b.title="";b.type=1;b.desc="";b.teacher="";b.grade="";b["class"]="";b.subject="";b.domain="";b.errMsg="";console.log("reset")})});b.type=1;b.$watch("grade",function(a){b.cls=0});b.createActivity=function(){b.errMsg="";h.setAttribute("disabled","disabled");var a=b.config?
b.config.activityConfig:{},a={uids:b.invitedUsers?b.invitedUsers:"",title:b.title||"",type:b.type|1,desc:b.desc||"",date:b.date?b.date.getTime():0,teacher:b.teacher||"",grade:a.classes[b.grade].grade,"class":a.classes[b.grade].cls[b.cls],subject:a.subjects[b.subject],domain:b.domain||""};d.createActivity(a,function(a,b){console.log(a,b);h.removeAttribute("disabled");e.modal("hide")},function(a,c){a=a||{c:-1,msg:"UNKNOWN"};b.errMsg=c+" - ["+a.c+"] "+a.m;h.removeAttribute("disabled")})};(function(){d.fetchActivityConfig(function(a,
c){b.config=a;b.grade=0;b.cls=0;b.subject=0})})()}]).controller("LoginFormController",["$rootScope","$scope","UserService",function(c,b,a){b.uid="";b.pwd="";b.errMsg="";b.login=function(){b.uid?b.pwd?a.login(b.uid,b.pwd,function(a){a||$("#loginModal").modal("hide");b.uid=b.pwd=b.errMsg=""}):b.errMsg="\u8bf7\u8f93\u5165\u5bc6\u7801":b.errMsg="\u8bf7\u8f93\u5165\u5e10\u53f7\u540d"}}]).directive("ngEnter",function(){return{link:function(c,b,a){b.on("keydown",function(b){if(13==b.keyCode){var e=a.ngEnter;
e&&_.bind(function(a){eval("this."+e)},c)()}})}}}).directive("activityDate",function(){return{link:function(c,b,a){c=c.item.date.split("_");b.text(c[0]+"\u5e74"+c[1]+"\u6708"+c[2]+"\u65e5")}}}).directive("activityDatePicker",function(){return{link:function(c,b,a){var d=new Date;d.setHours(0);d.setMinutes(0);d.setSeconds(0);d.setMilliseconds(0);var e=$(b).datepicker({onRender:function(a){return a.getTime()<d.getTime()?"disabled":""}}).on("changeDate",function(b){e.hide();var d=a.ngDateModel;d&&(c[d]=
b.date)}).data("datepicker")}}}).service("UserService",["$rootScope","$location",function(c,b){function a(){return b.search().uid}return{uid:a,hasLoggedIn:function(){return void 0!==a()},login:function(a,e,h){b.search("uid",a);h(0);c.$emit("event.login",0)}}}]).service("ActivityService",["$rootScope","$http",function(c,b){return{fetchActivities:function(a,d,k){b.get(e+"/activities?uid="+c.uid,{responseType:"json",params:a}).success(function(a,b){if(200===b&&!a.c){var e=a.r.activities,k=_.groupBy(e,
function(a){var b=new Date(a.info.date);a=b.getFullYear();var c=b.getMonth()+1,b=b.getDate();return[a,c,b].join("_")});c.activityList=_.map(k,function(a,b){return{date:b,activities:a}});c.activityMap=_.reduce(e,function(a,b){a[b._id]=b;return a},{})}d&&d(a,b)}).error(k)},createActivity:function(a,d,k){a=_.map(a,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&");b.post(e+"/activities?uid="+c.uid,a,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(d).error(k)},
fetchActivityConfig:function(a,c){b.get(e+"/activities/config",null,{responseType:"json"}).success(function(b,c){console.log("[ActivityService] activity config =",b);a&&a(b,c)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");c&&c(a,b)})}}}])})();
