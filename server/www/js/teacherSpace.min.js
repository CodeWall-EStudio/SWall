!function(a){var b=function(c,k){this.element=a(c);this.format=e.parseFormat(k.format||this.element.data("date-format")||"mm/dd/yyyy");this.picker=a(e.template).appendTo("body").on({click:a.proxy(this.click,this)});this.isInput=this.element.is("input");this.component=this.element.is(".date")?this.element.find(".add-on"):!1;if(this.isInput)this.element.on({focus:a.proxy(this.show,this),keyup:a.proxy(this.update,this)});else if(this.component)this.component.on("click",a.proxy(this.show,this));else this.element.on("click",
a.proxy(this.show,this));this.minViewMode=k.minViewMode||this.element.data("date-minviewmode")||0;if("string"===typeof this.minViewMode)switch(this.minViewMode){case "months":this.minViewMode=1;break;case "years":this.minViewMode=2;break;default:this.minViewMode=0}this.viewMode=k.viewMode||this.element.data("date-viewmode")||0;if("string"===typeof this.viewMode)switch(this.viewMode){case "months":this.viewMode=1;break;case "years":this.viewMode=2;break;default:this.viewMode=0}this.startViewMode=this.viewMode;
this.weekStart=k.weekStart||this.element.data("date-weekstart")||0;this.weekEnd=0===this.weekStart?6:this.weekStart-1;this.onRender=k.onRender;this.fillDow();this.fillMonths();this.update();this.showMode()};b.prototype={constructor:b,show:function(c){this.picker.show();this.height=this.component?this.component.outerHeight():this.element.outerHeight();this.place();a(window).on("resize",a.proxy(this.place,this));c&&(c.stopPropagation(),c.preventDefault());var k=this;a(document).on("mousedown",function(c){0==
a(c.target).closest(".datepicker").length&&k.hide()});this.element.trigger({type:"show",date:this.date})},hide:function(){this.picker.hide();a(window).off("resize",this.place);this.viewMode=this.startViewMode;this.showMode();this.isInput||a(document).off("mousedown",this.hide);this.element.trigger({type:"hide",date:this.date})},set:function(){var c=e.formatDate(this.date,this.format);this.isInput?this.element.prop("value",c):(this.component&&this.element.find("input").prop("value",c),this.element.data("date",
c))},setValue:function(c){this.date="string"===typeof c?e.parseDate(c,this.format):new Date(c);this.set();this.viewDate=new Date(this.date.getFullYear(),this.date.getMonth(),1,0,0,0,0);this.fill()},place:function(){var c=this.component?this.component.offset():this.element.offset();this.picker.css({top:c.top+this.height,left:c.left})},update:function(c){this.date=e.parseDate("string"===typeof c?c:this.isInput?this.element.prop("value"):this.element.data("date"),this.format);this.viewDate=new Date(this.date.getFullYear(),
this.date.getMonth(),1,0,0,0,0);this.fill()},fillDow:function(){for(var c=this.weekStart,a="<tr>";c<this.weekStart+7;)a+='<th class="dow">'+e.dates.daysMin[c++%7]+"</th>";a+="</tr>";this.picker.find(".datepicker-days thead").append(a)},fillMonths:function(){for(var c="",a=0;12>a;)c+='<span class="month">'+e.dates.monthsShort[a++]+"</span>";this.picker.find(".datepicker-months td").append(c)},fill:function(){var c=new Date(this.viewDate),a=c.getFullYear(),b=c.getMonth(),g=this.date.valueOf();this.picker.find(".datepicker-days th:eq(1)").text(e.dates.months[b]+
" "+a);var h=new Date(a,b-1,28,0,0,0,0),c=e.getDaysInMonth(h.getFullYear(),h.getMonth());h.setDate(c);h.setDate(c-(h.getDay()-this.weekStart+7)%7);var n=new Date(h);n.setDate(n.getDate()+42);for(var n=n.valueOf(),c=[],f,d,l;h.valueOf()<n;){h.getDay()===this.weekStart&&c.push("<tr>");f=this.onRender(h);d=h.getFullYear();l=h.getMonth();if(l<b&&d===a||d<a)f+=" old";else if(l>b&&d===a||d>a)f+=" new";h.valueOf()===g&&(f+=" active");c.push('<td class="day '+f+'">'+h.getDate()+"</td>");h.getDay()===this.weekEnd&&
c.push("</tr>");h.setDate(h.getDate()+1)}this.picker.find(".datepicker-days tbody").empty().append(c.join(""));b=this.date.getFullYear();c=this.picker.find(".datepicker-months").find("th:eq(1)").text(a).end().find("span").removeClass("active");b===a&&c.eq(this.date.getMonth()).addClass("active");c="";a=10*parseInt(a/10,10);g=this.picker.find(".datepicker-years").find("th:eq(1)").text(a+"-"+(a+9)).end().find("td");a-=1;for(h=-1;11>h;h++)c+='<span class="year'+(-1===h||10===h?" old":"")+(b===a?" active":
"")+'">'+a+"</span>",a+=1;g.html(c)},click:function(c){c.stopPropagation();c.preventDefault();var b=a(c.target).closest("span, td, th");if(1===b.length)switch(b[0].nodeName.toLowerCase()){case "th":switch(b[0].className){case "switch":this.showMode(1);break;case "prev":case "next":this.viewDate["set"+e.modes[this.viewMode].navFnc].call(this.viewDate,this.viewDate["get"+e.modes[this.viewMode].navFnc].call(this.viewDate)+e.modes[this.viewMode].navStep*("prev"===b[0].className?-1:1)),this.fill(),this.set()}break;
case "span":b.is(".month")?(c=b.parent().find("span").index(b),this.viewDate.setMonth(c)):(b=parseInt(b.text(),10)||0,this.viewDate.setFullYear(b));0!==this.viewMode&&(this.date=new Date(this.viewDate),this.element.trigger({type:"changeDate",date:this.date,viewMode:e.modes[this.viewMode].clsName}));this.showMode(-1);this.fill();this.set();break;case "td":if(b.is(".day")&&!b.is(".disabled")){var m=parseInt(b.text(),10)||1;c=this.viewDate.getMonth();b.is(".old")?c-=1:b.is(".new")&&(c+=1);b=this.viewDate.getFullYear();
this.date=new Date(b,c,m,0,0,0,0);this.viewDate=new Date(b,c,Math.min(28,m),0,0,0,0);this.fill();this.set();this.element.trigger({type:"changeDate",date:this.date,viewMode:e.modes[this.viewMode].clsName})}}},mousedown:function(a){a.stopPropagation();a.preventDefault()},showMode:function(a){a&&(this.viewMode=Math.max(this.minViewMode,Math.min(2,this.viewMode+a)));this.picker.find(">div").hide().filter(".datepicker-"+e.modes[this.viewMode].clsName).show()}};a.fn.datepicker=function(c,k){return this.each(function(){var e=
a(this),g=e.data("datepicker"),h="object"===typeof c&&c;g||e.data("datepicker",g=new b(this,a.extend({},a.fn.datepicker.defaults,h)));if("string"===typeof c)g[c](k)})};a.fn.datepicker.defaults={onRender:function(a){return""}};a.fn.datepicker.Constructor=b;var e={modes:[{clsName:"days",navFnc:"Month",navStep:1},{clsName:"months",navFnc:"FullYear",navStep:1},{clsName:"years",navFnc:"FullYear",navStep:10}],dates:{days:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),daysShort:"Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),
daysMin:"Su Mo Tu We Th Fr Sa Su".split(" "),months:"January February March April May June July August September October November December".split(" "),monthsShort:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")},isLeapYear:function(a){return 0===a%4&&0!==a%100||0===a%400},getDaysInMonth:function(a,b){return[31,e.isLeapYear(a)?29:28,31,30,31,30,31,31,30,31,30,31][b]},parseFormat:function(a){var b=a.match(/[.\/\-\s].*?/);a=a.split(/\W+/);if(!b||!a||0===a.length)throw Error("Invalid date format.");
return{separator:b,parts:a}},parseDate:function(a,b){var e=a.split(b.separator);a=new Date;var g;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);if(e.length===b.parts.length){for(var h=a.getFullYear(),n=a.getDate(),f=a.getMonth(),d=0,l=b.parts.length;d<l;d++)switch(g=parseInt(e[d],10)||1,b.parts[d]){case "dd":case "d":n=g;a.setDate(g);break;case "mm":case "m":f=g-1;a.setMonth(g-1);break;case "yy":h=2E3+g;a.setFullYear(2E3+g);break;case "yyyy":h=g,a.setFullYear(g)}a=new Date(h,f,
n,0,0,0)}return a},formatDate:function(a,b){var e={d:a.getDate(),m:a.getMonth()+1,yy:a.getFullYear().toString().substring(2),yyyy:a.getFullYear()};e.dd=(10>e.d?"0":"")+e.d;e.mm=(10>e.m?"0":"")+e.m;a=[];for(var g=0,h=b.parts.length;g<h;g++)a.push(e[b.parts[g]]);return a.join(b.separator)},headTemplate:'<thead><tr><th class="prev">&lsaquo;</th><th colspan="5" class="switch"></th><th class="next">&rsaquo;</th></tr></thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>'};e.template='<div class="datepicker dropdown-menu"><div class="datepicker-days"><table class=" table-condensed">'+
e.headTemplate+'<tbody></tbody></table></div><div class="datepicker-months"><table class="table-condensed">'+e.headTemplate+e.contTemplate+'</table></div><div class="datepicker-years"><table class="table-condensed">'+e.headTemplate+e.contTemplate+"</table></div></div>"}(window.jQuery);(function(a){function b(b,f){this.itemsArray=[];this.$element=a(b);this.$element.hide();this.multiple=(this.isSelect="SELECT"===b.tagName)&&b.hasAttribute("multiple");this.objectItems=f&&f.itemValue;this.placeholderText=b.hasAttribute("placeholder")?this.$element.attr("placeholder"):"";this.inputSize=Math.max(1,this.placeholderText.length);this.$container=a('<div class="bootstrap-tagsinput"></div>');this.$input=a('<input size="'+this.inputSize+'" type="text" placeholder="'+this.placeholderText+'"/>').appendTo(this.$container);
this.$element.after(this.$container);this.build(f)}function e(a,b){if("function"!==typeof a[b]){var c=a[b];a[b]=function(a){return a[c]}}}function c(a,b){if("function"!==typeof a[b]){var c=a[b];a[b]=function(){return c}}}function k(a){return a?h.text(a).html():""}function m(a){var b=0;if(document.selection)a.focus(),b=document.selection.createRange(),b.moveStart("character",-a.value.length),b=b.text.length;else if(a.selectionStart||"0"==a.selectionStart)b=a.selectionStart;return b}var g={tagClass:function(a){return"label label-info"},
itemValue:function(a){return a?a.toString():a},itemText:function(a){return this.itemValue(a)},freeInput:!0,maxTags:void 0,confirmKeys:[13],onTagExists:function(a,b){b.hide().fadeIn()}};b.prototype={constructor:b,add:function(b,c){var d=this;if(!(d.options.maxTags&&d.itemsArray.length>=d.options.maxTags||!1!==b&&!b)){if("object"===typeof b&&!d.objectItems)throw"Can't add objects when itemValue option is not set";if(!b.toString().match(/^\s*$/)){d.isSelect&&!d.multiple&&0<d.itemsArray.length&&d.remove(d.itemsArray[0]);
if("string"===typeof b&&"INPUT"===this.$element[0].tagName){var l=b.split(",");if(1<l.length){for(var e=0;e<l.length;e++)this.add(l[e],!0);c||d.pushVal();return}}var g=d.options.itemValue(b),l=d.options.itemText(b),e=d.options.tagClass(b),h=a.grep(d.itemsArray,function(a){return d.options.itemValue(a)===g})[0];h?d.options.onTagExists&&(l=a(".tag",d.$container).filter(function(){return a(this).data("item")===h}),d.options.onTagExists(b,l)):(d.itemsArray.push(b),e=a('<span class="tag '+k(e)+'">'+k(l)+
'<span data-role="remove"></span></span>'),e.data("item",b),d.findInputWrapper().before(e),e.after(" "),d.isSelect&&!a('option[value="'+escape(g)+'"]',d.$element)[0]&&(l=a("<option selected>"+k(l)+"</option>"),l.data("item",b),l.attr("value",g),d.$element.append(l)),c||d.pushVal(),d.options.maxTags===d.itemsArray.length&&d.$container.addClass("bootstrap-tagsinput-max"),d.$element.trigger(a.Event("itemAdded",{item:b})))}}},remove:function(b,c){var d=this;d.objectItems&&(b="object"===typeof b?a.grep(d.itemsArray,
function(a){return d.options.itemValue(a)==d.options.itemValue(b)})[0]:a.grep(d.itemsArray,function(a){return d.options.itemValue(a)==b})[0]);b&&(a(".tag",d.$container).filter(function(){return a(this).data("item")===b}).remove(),a("option",d.$element).filter(function(){return a(this).data("item")===b}).remove(),d.itemsArray.splice(a.inArray(b,d.itemsArray),1));c||d.pushVal();d.options.maxTags>d.itemsArray.length&&d.$container.removeClass("bootstrap-tagsinput-max");d.$element.trigger(a.Event("itemRemoved",
{item:b}))},removeAll:function(){a(".tag",this.$container).remove();for(a("option",this.$element).remove();0<this.itemsArray.length;)this.itemsArray.pop();this.pushVal();this.options.maxTags&&!this.isEnabled()&&this.enable()},refresh:function(){var b=this;a(".tag",b.$container).each(function(){var c=a(this),d=c.data("item"),e=b.options.itemValue(d),g=b.options.itemText(d),h=b.options.tagClass(d);c.attr("class",null);c.addClass("tag "+k(h));c.contents().filter(function(){return 3==this.nodeType})[0].nodeValue=
k(g);b.isSelect&&a("option",b.$element).filter(function(){return a(this).data("item")===d}).attr("value",e)})},items:function(){return this.itemsArray},pushVal:function(){var b=this,c=a.map(b.items(),function(a){return b.options.itemValue(a).toString()});b.$element.val(c,!0).trigger("change")},build:function(b){var f=this;f.options=a.extend({},g,b);var d=f.options.typeahead||{};f.objectItems&&(f.options.freeInput=!1);e(f.options,"itemValue");e(f.options,"itemText");e(f.options,"tagClass");f.options.source&&
(d.source=f.options.source);d.source&&a.fn.typeahead&&(c(d,"source"),f.$input.typeahead({source:function(b,c){function e(a){for(var b=[],d=0;d<a.length;d++){var l=f.options.itemText(a[d]);g[l]=a[d];b.push(l)}c(b)}var g=this.map={},h=d.source(b);a.isFunction(h.success)?h.success(e):a.when(h).then(e)},updater:function(a){f.add(this.map[a])},matcher:function(a){return-1!==a.toLowerCase().indexOf(this.query.trim().toLowerCase())},sorter:function(a){return a.sort()},highlighter:function(a){return a.replace(RegExp("("+
this.query+")","gi"),"<strong>$1</strong>")}}));f.$container.on("click",a.proxy(function(a){f.$input.focus()},f));f.$container.on("keydown","input",a.proxy(function(b){var c=a(b.target),d=f.findInputWrapper();switch(b.which){case 8:0===m(c[0])&&(d=d.prev())&&f.remove(d.data("item"));break;case 46:0===m(c[0])&&(d=d.next())&&f.remove(d.data("item"));break;case 37:b=d.prev();0===c.val().length&&b[0]&&(b.before(d),c.focus());break;case 39:b=d.next();0===c.val().length&&b[0]&&(b.after(d),c.focus());break;
default:f.options.freeInput&&0<=a.inArray(b.which,f.options.confirmKeys)&&(f.add(c.val()),c.val(""),b.preventDefault())}c.attr("size",Math.max(this.inputSize,c.val().length))},f));f.$container.on("click","[data-role=remove]",a.proxy(function(b){f.remove(a(b.target).closest(".tag").data("item"))},f));f.options.itemValue===g.itemValue&&("INPUT"===f.$element[0].tagName?f.add(f.$element.val()):a("option",f.$element).each(function(){f.add(a(this).attr("value"),!0)}))},destroy:function(){this.$container.off("keypress",
"input");this.$container.off("click","[role=remove]");this.$container.remove();this.$element.removeData("tagsinput");this.$element.show()},focus:function(){this.$input.focus()},input:function(){return this.$input},findInputWrapper:function(){for(var b=this.$input[0],c=this.$container[0];b&&b.parentNode!==c;)b=b.parentNode;return a(b)}};a.fn.tagsinput=function(c,e){var d=[];this.each(function(){var g=a(this).data("tagsinput");g?(g=g[c](e),void 0!==g&&d.push(g)):(g=new b(this,c),a(this).data("tagsinput",
g),d.push(g),"SELECT"===this.tagName&&a("option",a(this)).attr("selected","selected"),a(this).val(a(this).val()))});return"string"==typeof c?1<d.length?d:d[0]:d};a.fn.tagsinput.Constructor=b;var h=a("<div />");a(function(){a("input[data-role=tagsinput], select[multiple][data-role=tagsinput]").tagsinput()})})(window.jQuery);(function(){angular.module("TeacherSpace",[]).controller("MainController",["$rootScope","$scope","$http",function(a,b,e){a.uid="oscar";a.activityID="";a.activity=null;a.fetchActivities=function(b){a.activityID="";a.activity=null;e.get("/activities?uid="+a.uid,{responseType:"json",params:b}).success(function(b,c){if(200===c&&!b.c){var e=b.r.activities,h=_.groupBy(e,function(a){var b=new Date(a.info.date);a=b.getFullYear();var c=b.getMonth()+1,b=b.getDate();return[a,c,b].join("_")});a.activityList=
_.map(h,function(a,b){return{date:b,activities:a}});a.activityMap=_.reduce(e,function(a,b){a[b._id]=b;return a},{})}}).error(function(a,b){})};a.fetchActivities()}]).controller("NavigatorController",["$rootScope","$scope",function(a,b){}]).controller("ToolbarController",["$rootScope","$scope",function(a,b){b.authorizationTypes=[{label:"\u6388\u6743\u6211\u53c2\u4e0e\u7684",value:"invited"},{label:"\u516c\u5f00\u7684",value:"public"},{label:"\u5168\u90e8",value:null}];b.statuses=[{label:"\u5f00\u653e\u7684",
value:"active"},{label:"\u5173\u95ed\u7684",value:"closed"},{label:"\u5168\u90e8",value:null}];b.aTypeIndex=2;b.statusIndex=2;b.searchKeyword="";b.updateQueryCondition=function(e,c){if(b[e]!==c){b[e]=c;var k={},m=b.authorizationTypes[b.aTypeIndex].value,g=b.statuses[b.statusIndex].value;m&&(k.authorize=m);g&&(k.status=g);b.searchKeyword&&(k.kw=b.searchKeyword);a.fetchActivities(k)}}}]).controller("ActivityListController",["$rootScope","$scope",function(a,b){b.selectActivity=function(b){a.activityID=
b;a.activity=a.activityMap[b]}}]).controller("ActivityDetailController",["$rootScope","$scope",function(a,b){b.userCount=function(){if(a.activity){if(a.activity.active)return a.activity.users.participators.length;var b=_.countBy(a.activity.resources,function(a){return a.user});return _.keys(b).length}return 0}}]).controller("ActivityFormController",["$rootScope","$scope","$http",function(a,b,e){var c=$("#createActivityModal"),k=document.querySelector("#createActivityForm > fieldset");b.type=1;b.$watch("grade",
function(a){b.cls=0});b.createActivity=function(){b.errMsg="";k.setAttribute("disabled","disabled");var m=b.config?b.config.activityConfig:{},m={uids:b.invitedUsers?b.invitedUsers:"",title:b.title||"",type:b.type|0,desc:b.desc||"",date:b.date?b.date.getTime():0,teacher:b.teacher||"",grade:m.classes[b.grade].grade,"class":m.classes[b.grade].cls[b.cls],subject:m.subjects[b.subject],domain:b.domain||""},m=_.map(m,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&");e.post("/activities?uid="+
a.uid,m,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,b){console.log(a,b);k.removeAttribute("disabled");c.modal("hide")}).error(function(a,c){a=a||{c:-1,msg:"UNKNOWN"};b.errMsg=c+" - ["+a.c+"] "+a.m;k.removeAttribute("disabled")})};(function(){e.get("/activities/config",null,{responseType:"json"}).success(function(a,c){console.log("[ActivityFormController] activity config =",a);b.config=a;b.grade=0;b.cls=0;b.subject=0}).error(function(a,b){console.error("[ActivityFormController] FAIL TO FETCH ACTIVITY CONFIGURATIONS")})})()}]).directive("activityDate",
function(){return{link:function(a,b,e){a=a.item.date.split("_");b.text(a[0]+"\u5e74"+a[1]+"\u6708"+a[2]+"\u65e5")}}}).directive("activityDatePicker",function(){return{link:function(a,b,e){var c=new Date;c.setHours(0);c.setMinutes(0);c.setSeconds(0);c.setMilliseconds(0);var k=$(b).datepicker({onRender:function(a){return a.getTime()<c.getTime()?"disabled":""}}).on("changeDate",function(b){k.hide();var c=e.ngModel;c&&(a[c]=b.date)}).data("datepicker")}}})})();
