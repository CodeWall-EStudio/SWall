angular.module("ts.utils.constants",[]).constant("BACKEND_SERVER","localhost"==location.hostname?"http://localhost:8090":"").constant("EVENT_LOGIN","event.login").constant("EVENT_MODE_CHANGE","event.mode.change").constant("CMD_SHOW_LOGIN_PANEL","cmd.login.panel.show").constant("CMD_SHOW_ACTIVITY_PANEL","cmd.activity.panel.show");angular.module("ts.services.utils",[]).service("UtilsService",[function(){var b={object:{toUrlencodedString:function(a){return _.map(a,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")}},cookie:{get:function(a){var b=document.cookie.split("; ");return _.reduce(b,function(a,b){var l=b.split("=");a[l[0]]=l[1];return a},{})[a]}},time:{timezoneOffset:(new Date).getTimezoneOffset(),dateToDatetimePickerValue:function(a,c){a||(a=new Date);a.setMinutes(a.getMinutes()-b.time.timezoneOffset);
c||(a.setSeconds(0),a.setMilliseconds(0));return a.toISOString().split(".")[0]},datetimePickerValueToTs:function(a){if(a){var c=3>a.split(":").length?":00.000Z":".000Z",c=Date.parse(a+c)+6E4*b.time.timezoneOffset;console.log(a,c,new Date(c));return c}return 0}}};return b}]);angular.module("ts.services.user",["ts.utils.constants","ts.services.utils"]).service("UserService",["$rootScope","$http","UtilsService","BACKEND_SERVER","EVENT_LOGIN",function(b,a,c,h,d){return{uid:function(){return c.cookie.get("uid")},hasLoggedIn:function(){var a=c.cookie.get("uid"),b=c.cookie.get("skey");return Boolean(a&&b)},nick:function(){var a=localStorage.login_result;return(a=a?JSON.parse(a):{})?a.nick:""},login:function(c,f,n,m){function p(a,c){console.log("[UserService] login result:",
a,c,document.cookie);200==c&&n?(localStorage.login_result=JSON.stringify(a),n(a,c)):m&&m(a,c);b.$emit(d,c,a)}a.put(h+"/users/"+c+"/login","pwd="+encodeURIComponent(f),{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(p).error(p)},logout:function(){var a=(new Date).toGMTString();document.cookie="uin=; path=/; expires="+a;document.cookie="skey=; path=/; expires="+a;localStorage.removeItem("login_result")},fetchProfile:function(a){},activity:{isCreatorOfActivity:function(a){return c.cookie.get("uid")==
a.users.creator}}}}]);angular.module("ts.services.activity",["ts.utils.constants","ts.services.utils","ts.services.user"]).service("ActivityService",["$rootScope","$http","UtilsService","UserService","BACKEND_SERVER",function(b,a,c,h,d){function l(a){a?(b.selectedActivity=a,b.selectedActivityID=a._id):(b.selectedActivity=null,b.selectedActivityID="");console.log("[ActivityService] selected activity",b.selectedActivity)}function f(e,k,g,r){p();k=k||{};k._=(new Date).getTime();k=c.object.toUrlencodedString(k);a.put(d+"/activities/"+
e,k,{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,r){if(a&&!a.c&&a.r)a:{var e=a.r;b.activityMap[e._id]=e;for(var c=0;c<b.activityList.length;++c)for(var k=b.activityList[c].activities,d=0;d<k.length;++d)if(k[d]._id==e._id){b.selectedActivity==k[d]&&(b.selectedActivity=e,b.selectedActivityID=e._id);k[d]=e;break a}}q();g&&g(a,r)}).error(function(a,b){q();r&&r(a,b)})}function n(a,c){b.activityList.splice(a,0,{date:m(c),activities:[c]})}function m(a){a=
new Date(a.info.date);a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a.getTime().toString()}function p(){s.setAttribute("disabled","disabled")}function q(){s.removeAttribute("disabled")}function t(){b.hints="\u6ca1\u627e\u5230\u4efb\u4f55\u6d3b\u52a8"}var s=document.getElementById("activityDetailButtons");b.profiles={};b.activityList=[];b.activityMap={};b.selectedActivity=null;b.selectedActivityID="";b.hints="";return{selectActivity:l,selectActivityByID:function(a){l(b.activityMap[a])},
fetchActivities:function(c,k,g){b.activityList=[];b.activityMap={};b.hints="\u8bf7\u7a0d\u5019...";c=c||{};"manager"==b.mode()&&(c.creator=h.uid());c._=(new Date).getTime();console.log("[ActivityService] fetching activities with",c);a.get(d+"/activities",{responseType:"json",params:c}).success(function(a,c){if(200===c&&!a.c){b.profiles=a.r.profiles;var g=a.r.activities,d=_.groupBy(g,function(a){return m(a)});b.activityList=_.map(d,function(a,b){return{date:b,activities:a}});b.activityMap=_.reduce(g,
function(a,b){a[b._id]=b;return a},{});b.activityList.length?b.hints="":t();console.log("[ActivityService] activities result",b.activityList,b.activityMap)}k&&k(a,c)}).error(function(a,c){b.hints="\u62c9\u53d6\u6d3b\u52a8\u5931\u8d25";g&&g(a,c)})},getActivity:function(b,c,g){var r=(new Date).getTime();a.get(d+"/activities/"+b+"?_="+r,{responseType:"json"}).success(c).error(g)},createActivity:function(e,k,g){e=e||{};e._=(new Date).getTime();e=c.object.toUrlencodedString(e);a.post(d+"/activities",e,
{responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a,c){if(a&&!a.c&&a.r){b.hints="";a:{var g=a.r[0];b.activityMap[g._id]=g;for(var d=m(g),e=0;e<b.activityList.length;++e){var l=b.activityList[e];if(l.date==d){l.activities.unshift(g);break a}else if(l.date>d){n(e,g);break a}}n(e,g)}}b.hints="";k&&k(a,c)}).error(g)},updateActivity:f,closeActivity:function(a,b,c){f(a,{status:"closed"},b,c)},deleteActivity:function(c,k,g){p();a({method:"DELETE",url:d+
"/activities/"+c+"?_="+(new Date).getTime()}).success(function(a,g){if(a&&!a.c)a:{l(),delete b.activityMap[c];for(var d=0;d<b.activityList.length;++d)for(var f=0;f<b.activityList[d].activities.length;++f)if(b.activityList[d].activities[f]._id==c){b.activityList[d].activities.splice(f,1);b.activityList[d].activities.length||b.activityList.splice(d,1);break a}}q();b.activityList.length||t();k&&k(a,g)}).error(function(a,b){q();g&&g(a,b)})},fetchActivityConfig:function(b,c){var g=(new Date).getTime();
a.get(d+"/activities/config?_="+g,null,{responseType:"json"}).success(function(a,c){console.log("[ActivityService] activity config =",a);b&&b(a,c)}).error(function(a,b){console.error("[ActivityService] FAIL TO FETCH ACTIVITY CONFIGURATIONS");c&&c(a,b)})},statistics:{byUser:function(a,b){var c=_.countBy(_.pluck(a.resources,"user")),c=_.map(c,function(a,b){return{uid:b,count:a}});return _.sortBy(c,function(a){return-a.count})},byTime:function(a,b){var c=_.first(a.resources);if(c){var d=c.date,f={};
b=1E3*(b||300);_.each(a.resources,function(a){var c=Math.floor((a.date-d)/b)*b;f[c]||(f[c]=[]);f[c].push(a)});return{beginning:d,items:f}}return{}}}}}]);angular.module("ts.controllers.activityDetail",["ts.utils.constants","ts.services.activity"]).controller("ActivityDetailController",["$rootScope","$scope","ActivityService","EVENT_MODE_CHANGE","CMD_SHOW_ACTIVITY_PANEL",function(b,a,c,h,d){a.userCount=function(){return b.selectedActivity?b.selectedActivity.active?a.participatorCount():a.uploadedUserCount():0};a.participatorCount=function(){var a=b.selectedActivity;return a&&a.active?a.users.participators.length:0};a.uploadedUserCount=function(){if(b.selectedActivity){var a=
_.countBy(b.selectedActivity.resources,function(a){return a.user});return _.keys(a).length}return 0};a.resourceCount=function(a){return b.selectedActivity&&b.selectedActivity.resources?_.reduce(b.selectedActivity.resources,function(b,c){c.type==a&&(b+=1);return b},0):0};a.editActivity=function(){b.$emit(d,{panelTitle:"\u7f16\u8f91\u6d3b\u52a8",confirmBtnTitle:"\u4fdd\u5b58",activity:$.extend(!0,{},b.selectedActivity)})};a.closeActivity=function(){confirm("\u786e\u5b9a\u8981\u5173\u95ed\u6d3b\u52a8\uff1f")&&
c.closeActivity(b.selectedActivity._id)};a.deleteActivity=function(){confirm("\u786e\u5b9a\u8981\u5220\u9664\u6d3b\u52a8\uff1f")&&c.deleteActivity(b.selectedActivity._id,null,function(){alert("\u5220\u9664\u6d3b\u52a8\u5931\u8d25\uff0c\u8bf7\u6ce8\u610f\uff1a\u6709\u8d44\u6e90\u6216\u6709\u7528\u6237\u52a0\u5165\u7684\u6d3b\u52a8\u4e0d\u80fd\u5220\u9664")})};a.handlePlayBtnClick=function(){window.open("activity_play.html#?aid="+b.selectedActivity._id,"_blank")};b.$on(h,function(a,b){c.selectActivity()})}]);angular.module("ts.controllers.activityList",["ts.services.activity"]).controller("ActivityListController",["$rootScope","$scope","ActivityService",function(b,a,c){a.selectActivity=function(a){c.selectActivityByID(a)}}]);angular.module("ts.controllers.activityPanel",["ts.utils.constants","ts.services.activity","ts.services.utils"]).controller("ActivityPanelController",["$rootScope","$scope","$http","ActivityService","UtilsService","CMD_SHOW_ACTIVITY_PANEL",function(b,a,c,h,d,l){function f(a,b){console.log(a,b);s.removeAttribute("disabled");p.modal("hide")}function n(b,c){b=b||{c:-1,msg:"UNKNOWN"};var d="\u5176\u4ed6\u672a\u77e5\u9519\u8bef";switch(b.c){case 1:d="\u540e\u53f0\u5176\u4ed6\u9519\u8bef";break;case 10:d=
"\u7528\u6237\u5c1a\u672a\u767b\u5f55";break;case 1E4:d="\u7528\u6237\u6743\u9650\u586b\u5199\u4e0d\u6b63\u786e";break;case 10010:d="\u6d3b\u52a8\u6807\u9898\u586b\u5199\u4e0d\u6b63\u786e";break;case 10020:d="\u6d3b\u52a8\u7c7b\u578b\u586b\u5199\u4e0d\u6b63\u786e";break;case 10040:d="\u6d3b\u52a8\u65e5\u671f\u586b\u5199\u4e0d\u6b63\u786e\uff0c\u5fc5\u987b\u665a\u4e8e\u5f53\u524d\u65f6\u95f4\uff01";break;case 10050:d="\u51fa\u8bfe\u6559\u5e08\u586b\u5199\u4e0d\u6b63\u786e";break;case 10060:d="\u5e74\u7ea7\u586b\u5199\u4e0d\u6b63\u786e";
break;case 10070:d="\u73ed\u7ea7\u586b\u5199\u4e0d\u6b63\u786e";break;case 10080:d="\u5b66\u79d1\u586b\u5199\u4e0d\u6b63\u786e";break;case 10090:d="\u8bfe\u9898\u586b\u5199\u4e0d\u6b63\u786e"}a.errMsg="["+c+"|"+b.c+"]"+d;s.removeAttribute("disabled")}function m(){s.setAttribute("disabled","disabled")}var p=$("#createActivityModal"),q=$('input[data-role="tagsinput"]'),t=document.getElementById("na_date"),s=document.getElementById("activityFormAllFields"),e=document.getElementById("activityFormFieldsForOpenActivities"),
k={info:{type:1},users:{invitedUsers:[]}};b.$on(l,function(b,c){c=c||{};a.panelTitle=c.panelTitle||"\u521b\u5efa\u6d3b\u52a8";a.confirmBtnTitle=c.confirmBtnTitle||"\u521b\u5efa\u6d3b\u52a8";a.cancelBtnTitle=c.cancelBtnTitle||"\u53d6\u6d88";a.activity=c.activity||$.extend(!0,{},k);a.invitedUsers=a.activity.users.invitedUsers.join(",");for(var f=a.config?a.config.activityConfig:{},e=a.activity.info,h=0;h<f.classes.length;++h){var l=f.classes[h];if(l.grade==e.grade){a.grade=h;a.cls=l.cls.indexOf(e["class"]);
console.log(a.grade,a.cls);break}}e=a.activity.info.date;f=new Date;e=e?new Date(e):f;e.setSeconds(0);e.setMilliseconds(0);a.activity.info.date=d.time.dateToDatetimePickerValue(e);t.setAttribute("min",d.time.dateToDatetimePickerValue(f));_.each(a.activity.users.invitedUsers,function(a){q.tagsinput("add",a)});a.showActivityPanel()});p.on("hidden.bs.modal",function(){a.activity=$.extend(!0,{},k);a.grade=a.cls=a.subject=0;a.errMsg="";q.tagsinput("removeAll")});a.$watch("grade",function(a){});a.showActivityPanel=
function(){$("#createActivityModal").modal("show");!a.activity._id||a.activity.active?e.removeAttribute("disabled"):e.setAttribute("disabled","disabled")};a.createActivity=function(){a.errMsg="";m();var b=a.config?a.config.activityConfig:{},c=b.classes[a.grade],b=b.subjects[a.subject],c={uids:a.invitedUsers||"",title:a.activity.info.title||"",type:a.activity.info.type|1,desc:a.activity.info.desc||"",date:d.time.datetimePickerValueToTs(a.activity.info.date),teacher:a.activity.info.teacher||"",grade:c?
c.grade:"","class":c?c.cls[a.cls]:"",subject:b||"",domain:a.activity.info.domain||""};h.createActivity(c,f,n)};a.updateActivity=function(){a.errMsg="";m();var b=a.config?a.config.activityConfig:{},c={uids:a.invitedUsers||""};a.activity.active&&(c.title=a.activity.info.title||"",c.type=a.activity.info.type||"",c.desc=a.activity.info.desc||"",c.date=d.time.datetimePickerValueToTs(a.activity.info.date),c.teacher=a.activity.info.teacher||"",c.grade=b.classes[a.grade].grade||"",c["class"]=b.classes[a.grade].cls[a.cls]||
"",c.subject=b.subjects[a.subject]||"",c.domain=a.activity.info.domain||"");h.updateActivity(a.activity._id,c,f,n)};a.handleConfirmBtnClick=function(){a.activity._id?a.updateActivity():a.createActivity()};(function(){h.fetchActivityConfig(function(b,c){a.config=b})})()}]);angular.module("ts.controllers.loginForm",["ts.utils.constants","ts.services.user"]).controller("LoginFormController",["$rootScope","$scope","UserService","CMD_SHOW_LOGIN_PANEL",function(b,a,c,h){a.uid="";a.pwd="";a.errMsg="";a.login=function(){function b(c,d){200==d?$("#loginModal").modal("hide"):(a.errMsg="\u9a8c\u8bc1\u5931\u8d25",a.$digest());a.uid=a.pwd=a.errMsg=""}a.uid?a.pwd?c.login(a.uid,a.pwd,b,b):a.errMsg="\u8bf7\u8f93\u5165\u5bc6\u7801":a.errMsg="\u8bf7\u8f93\u5165\u5e10\u53f7\u540d"};
b.$on(h,function(){if(c.hasLoggedIn())if(confirm("\u786e\u5b9a\u8981\u9000\u51fa\u767b\u5f55\u5417\uff1f"))c.logout();else return;$("#loginModal").modal("show")})}]);angular.module("ts.controllers.main",["ts.utils.constants","ts.services.user","ts.services.activity"]).controller("MainController",["$rootScope","$scope","$http","$location","UserService","ActivityService","EVENT_LOGIN","CMD_SHOW_LOGIN_PANEL","EVENT_MODE_CHANGE",function(b,a,c,h,d,l,f,n,m){b.fetchActivities=function(a){l.selectActivity();l.fetchActivities(a)};b.showLoginModal=function(){window.location="/qqconnect/login"};b.mode=function(){return h.search().mode};b.gotoMode=function(a){a!==b.mode()&&
(h.search("mode",a),b.$emit(m,a))};b.$on(f,function(a,c){200==c&&b.fetchActivities()});d.hasLoggedIn()&&b.fetchActivities()}]);angular.module("ts.controllers.navigator",["ts.services.user"]).controller("NavigatorController",["$rootScope","$scope","UserService","EVENT_LOGIN","CMD_SHOW_LOGIN_PANEL",function(b,a,c,h,d){b.$on(h,function(b,d){200==d&&(a.nickname=c.nick())});a.nickname=c.nick()}]);angular.module("ts.controllers.toolbar",["ts.utils.constants"]).controller("ToolbarController",["$rootScope","$scope","EVENT_MODE_CHANGE","CMD_SHOW_ACTIVITY_PANEL",function(b,a,c,h){a.authorizationTypes=[{label:"\u6388\u6743\u6211\u53c2\u4e0e\u7684",value:"invited"},{label:"\u516c\u5f00\u7684",value:"public"},{label:"\u5168\u90e8\u6743\u9650",value:null}];a.statuses=[{label:"\u5f00\u653e\u7684",value:"active"},{label:"\u5173\u95ed\u7684",value:"closed"},{label:"\u5168\u90e8\u72b6\u6001",value:null}];
a.aTypeIndex=2;a.statusIndex=2;a.searchKeyword="";a.showCreateActivityModal=function(a){a.currentTarget.classList.contains("disabled")||b.$emit(h)};a.updateQueryAndSearch=function(c,h){c&&(a[c]=h);var f={},n=a.authorizationTypes[a.aTypeIndex].value,m=a.statuses[a.statusIndex].value;n&&(f.authorize=n);m&&(f.status=m);a.searchKeyword&&(f.kw=a.searchKeyword);b.fetchActivities(f)};b.$on(c,function(b,c){a.updateQueryAndSearch()})}]);angular.module("ts.directives.ngEnter",[]).directive("ngEnter",function(){return{link:function(b,a,c){a.on("keydown",function(a){if(13==a.keyCode){var d=c.ngEnter;d&&_.bind(function(){eval("this."+d)},b)()}})}}});(function(){angular.module("teacherSpace","ts.controllers.main ts.controllers.navigator ts.controllers.toolbar ts.controllers.activityList ts.controllers.activityDetail ts.controllers.activityPanel ts.controllers.loginForm ts.directives.ngEnter".split(" "))})();
